<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - cp2k-omen_cov.info - src/CSR.H</title>
  <link rel="stylesheet" type="text/css" href="../gcov.css">
</head>

<body>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="title">LCOV - code coverage report</td></tr>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>

    <tr>
      <td width="100%">
        <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="35%" class="headerValue"><a href="../index.html">top level</a> - <a href="index.html">src</a> - CSR.H<span style="font-size: 80%;"> (source / <a href="CSR.H.func-sort-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="15%"></td>
            <td width="10%" class="headerCovTableHead">Hit</td>
            <td width="10%" class="headerCovTableHead">Total</td>
            <td width="15%" class="headerCovTableHead">Coverage</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">cp2k-omen_cov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntry">586</td>
            <td class="headerCovTableEntry">742</td>
            <td class="headerCovTableEntryMed">79.0 %</td>
          </tr>
          <tr>
            <td class="headerItem">Date:</td>
            <td class="headerValue">2017-12-30 22:09:47</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntry">28</td>
            <td class="headerCovTableEntry">42</td>
            <td class="headerCovTableEntryLo">66.7 %</td>
          </tr>
          <tr><td><img src="../glass.png" width=3 height=3 alt=""></td></tr>
        </table>
      </td>
    </tr>

    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
  </table>

  <table cellpadding=0 cellspacing=0 border=0>
    <tr>
      <td><br></td>
    </tr>
    <tr>
      <td>
<pre class="sourceHeading">          Line data    Source code</pre>
<pre class="source">
<a name="1"><span class="lineNum">       1 </span>            : /*</a>
<span class="lineNum">       2 </span>            : Copyright (c) 2017 ETH Zurich
<span class="lineNum">       3 </span>            : Sascha Brueck, Mauro Calderara, Mohammad Hossein Bani-Hashemian, and Mathieu Luisier
<span class="lineNum">       4 </span>            : 
<span class="lineNum">       5 </span>            : Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
<span class="lineNum">       6 </span>            : 
<span class="lineNum">       7 </span>            : The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
<span class="lineNum">       8 </span>            : 
<span class="lineNum">       9 </span>            : THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
<span class="lineNum">      10 </span>            : */
<span class="lineNum">      11 </span>            : 
<span class="lineNum">      12 </span>            : #ifndef __CSR
<span class="lineNum">      13 </span>            : #define __CSR
<span class="lineNum">      14 </span>            : 
<span class="lineNum">      15 </span>            : #include &lt;omp.h&gt;
<span class="lineNum">      16 </span>            : #include &lt;fstream&gt;
<span class="lineNum">      17 </span>            : #include &lt;algorithm&gt;
<span class="lineNum">      18 </span>            : #include &lt;complex&gt;
<span class="lineNum">      19 </span>            : #include &quot;Blas.H&quot;
<span class="lineNum">      20 </span>            : #include &quot;libcp2k.h&quot;
<span class="lineNum">      21 </span>            : 
<span class="lineNum">      22 </span>            : using namespace MYBLAS;
<span class="lineNum">      23 </span>            : 
<span class="lineNum">      24 </span>            : namespace cp2k_methods {
<span class="lineNum">      25 </span>            :     enum cp2k_method_type {
<span class="lineNum">      26 </span>            :         WRITE_OUT    = 0,
<span class="lineNum">      27 </span>            :         LOCAL_SCF    = 1,
<span class="lineNum">      28 </span>            :         TRANSMISSION = 2,
<span class="lineNum">      29 </span>            :         TRANSPORT    = 3,
<span class="lineNum">      30 </span>            :     };
<span class="lineNum">      31 </span>            : }
<span class="lineNum">      32 </span>            : 
<span class="lineNum">      33 </span>            : namespace lin_solver_methods {
<span class="lineNum">      34 </span>            :     enum lin_solver_method_type {
<span class="lineNum">      35 </span>            :         SPLITSOLVE = 11,
<span class="lineNum">      36 </span>            :         SUPERLU    = 12,
<span class="lineNum">      37 </span>            :         MUMPS      = 13,
<span class="lineNum">      38 </span>            :         FULL       = 14,
<span class="lineNum">      39 </span>            :         BANDED     = 15,
<span class="lineNum">      40 </span>            :         PARDISO    = 16,
<span class="lineNum">      41 </span>            :         UMFPACK    = 17,
<span class="lineNum">      42 </span>            :     };
<span class="lineNum">      43 </span>            : }
<span class="lineNum">      44 </span>            : 
<span class="lineNum">      45 </span>            : namespace inv_solver_methods {
<span class="lineNum">      46 </span>            :     enum inv_solver_method_type {
<span class="lineNum">      47 </span>            :         FULL    = 101,
<span class="lineNum">      48 </span>            :         PEXSI   = 102,
<span class="lineNum">      49 </span>            :         PARDISO = 103,
<span class="lineNum">      50 </span>            :         RGF     = 104,
<span class="lineNum">      51 </span>            :     };
<span class="lineNum">      52 </span>            : }
<span class="lineNum">      53 </span>            : 
<span class="lineNum">      54 </span>            : namespace injection_methods {
<span class="lineNum">      55 </span>            :     enum injection_method_type {
<span class="lineNum">      56 </span>            :         EVP  = 21,
<span class="lineNum">      57 </span>            :         BEYN = 22,
<span class="lineNum">      58 </span>            :     };
<span class="lineNum">      59 </span>            : }
<span class="lineNum">      60 </span>            : 
<span class="lineNum">      61 </span>            : namespace real_int_methods {
<span class="lineNum">      62 </span>            :     enum real_int_method_type {
<span class="lineNum">      63 </span>            :         GAUSSCHEBYSHEV = 31,
<span class="lineNum">      64 </span>            :         TRAPEZOIDAL    = 32,
<span class="lineNum">      65 </span>            :         READFROMFILE   = 33,
<span class="lineNum">      66 </span>            :     };
<span class="lineNum">      67 </span>            : }
<span class="lineNum">      68 </span>            : 
<span class="lineNum">      69 </span>            : namespace transport_methods {
<span class="lineNum">      70 </span>            :     enum transport_method_type {
<span class="lineNum">      71 </span>            :         EQ   = 0,
<span class="lineNum">      72 </span>            :         NEGF = 1,
<span class="lineNum">      73 </span>            :         GF   = 2,
<span class="lineNum">      74 </span>            :         WF   = 3,
<span class="lineNum">      75 </span>            :     };
<span class="lineNum">      76 </span>            : }
<span class="lineNum">      77 </span>            : 
<span class="lineNum">      78 </span>            : struct transport_parameters 
<span class="lineNum">      79 </span>            : {
<span class="lineNum">      80 </span>            :     cp2k_methods::cp2k_method_type             cp2k_method;
<span class="lineNum">      81 </span>            :     injection_methods::injection_method_type   injection_method;
<span class="lineNum">      82 </span>            :     lin_solver_methods::lin_solver_method_type lin_solver_method;
<span class="lineNum">      83 </span>            :     inv_solver_methods::inv_solver_method_type inv_solver_method;
<span class="lineNum">      84 </span>            :     real_int_methods::real_int_method_type     real_int_method;
<span class="lineNum">      85 </span>            :     int    n_occ;
<span class="lineNum">      86 </span>            :     int    n_abscissae;
<span class="lineNum">      87 </span>            :     int    n_kpoint;
<span class="lineNum">      88 </span>            :     int    num_interval;
<span class="lineNum">      89 </span>            :     int    tasks_per_point;
<span class="lineNum">      90 </span>            :     int    tasks_per_point_cc;
<span class="lineNum">      91 </span>            :     int    gpus_per_point;
<span class="lineNum">      92 </span>            :     int    NCRC_beyn;
<span class="lineNum">      93 </span>            :     int    n_points_beyn;
<span class="lineNum">      94 </span>            :     int    n_points_inv;
<span class="lineNum">      95 </span>            :     int    tasks_per_integration_point;
<span class="lineNum">      96 </span>            :     int    cutl;
<span class="lineNum">      97 </span>            :     int    cutr;
<span class="lineNum">      98 </span>            :     int    cp2k_scf_iter;
<span class="lineNum">      99 </span>            :     int    pexsi_ordering;
<span class="lineNum">     100 </span>            :     int    pexsi_row_ordering;
<span class="lineNum">     101 </span>            :     int    pexsi_verbosity;
<span class="lineNum">     102 </span>            :     int    pexsi_np_symb_fact;
<span class="lineNum">     103 </span>            :     bool   update_fermi;
<span class="lineNum">     104 </span>            :     bool   get_fermi_neutral;
<span class="lineNum">     105 </span>            :     bool   negf_solver;
<span class="lineNum">     106 </span>            :     bool   extra_scf;
<span class="lineNum">     107 </span>            :     bool   obc;
<span class="lineNum">     108 </span>            :     double colzero_threshold;
<span class="lineNum">     109 </span>            :     double eps_limit;
<span class="lineNum">     110 </span>            :     double eps_limit_cc;
<span class="lineNum">     111 </span>            :     double eps_decay;
<span class="lineNum">     112 </span>            :     double eps_singularity_curvatures;
<span class="lineNum">     113 </span>            :     double eps_mu;
<span class="lineNum">     114 </span>            :     double eps_eigval_degen;
<span class="lineNum">     115 </span>            :     double eps_fermi;
<span class="lineNum">     116 </span>            :     double energy_interval;
<span class="lineNum">     117 </span>            :     double min_interval;
<span class="lineNum">     118 </span>            :     double temperature;
<span class="lineNum">     119 </span>            :     double fac_neigbeyn;
<span class="lineNum">     120 </span>            :     double fac_neigbeyn_cc;
<span class="lineNum">     121 </span>            :     double svd_cutoff;
<span class="lineNum">     122 </span>            :     double evoltfactor;
<span class="lineNum">     123 </span>            :     double boltzmann_ev;
<span class="lineNum">     124 </span>            :     double conduct_quant;
<span class="lineNum">     125 </span>            : };
<span class="lineNum">     126 </span>            : 
<span class="lineNum">     127 </span>            : struct contact_type
<span class="lineNum">     128 </span>            : {
<span class="lineNum">     129 </span>            :     int    bandwidth, natoms, atomstart, ndof, start, start_bs, inj_sign, sigma_natoms, sigmasize, sigmastart, triblockstart;
<span class="lineNum">     130 </span>            :     double n_ele;
<span class="lineNum">     131 </span>            : };
<span class="lineNum">     132 </span>            : 
<span class="lineNum">     133 </span>            : struct result_type
<span class="lineNum">     134 </span>            : {
<span class="lineNum">     135 </span>            :     int npro,ndec,eigval_degeneracy;
<span class="lineNum">     136 </span>            :     double transm,dos,rcond;
<span class="lineNum">     137 </span>            :     double *dosprofile;
<span class="lineNum">     138 </span>            : };
<span class="lineNum">     139 </span>            : 
<span class="lineNum">     140 </span>            : #define LOGCERR std::cerr &lt;&lt; &quot;ERROR IN LINE &quot; &lt;&lt; __LINE__ &lt;&lt; &quot; OF FILE &quot; &lt;&lt; __FILE__ &lt;&lt; std::endl
<span class="lineNum">     141 </span>            : 
<span class="lineNum">     142 </span>            : /************************************************************************************************/
<a name="143"><span class="lineNum">     143 </span>            : </a>
<span class="lineNum">     144 </span>            : struct CSR_Exception{
<span class="lineNum">     145 </span><span class="lineNoCov">          0 :     CSR_Exception(const int line,const char* file) {std::cerr&lt;&lt;&quot;Error in line &quot;&lt;&lt;line&lt;&lt;&quot; of file &quot;&lt;&lt;file&lt;&lt;std::endl;}</span>
<span class="lineNum">     146 </span>            : };
<span class="lineNum">     147 </span>            : 
<span class="lineNum">     148 </span>            : /************************************************************************************************/
<a name="149"><span class="lineNum">     149 </span>            : </a>
<span class="lineNum">     150 </span>            : template &lt;class T&gt;
<span class="lineNum">     151 </span><span class="lineCov">          6 : void full_transpose(int ncol, int nrow, T *B, T* A)</span>
<span class="lineNum">     152 </span>            : {
<span class="lineNum">     153 </span><span class="lineCov">        102 :     for(int i=0;i&lt;ncol;i++) c_tcopy(nrow,&amp;B[i*nrow],1,&amp;A[i],ncol);</span>
<span class="lineNum">     154 </span><span class="lineCov">          6 : }</span>
<span class="lineNum">     155 </span>            : 
<span class="lineNum">     156 </span>            : /************************************************************************************************/
<span class="lineNum">     157 </span>            : 
<span class="lineNum">     158 </span>            : template &lt;class T&gt;
<span class="lineNum">     159 </span>            : void set_to_zero(int length, T *array)
<span class="lineNum">     160 </span>            : {
<span class="lineNum">     161 </span><span class="lineNoCov">          0 :     for (int i=0; i &lt; length; ++i) {</span>
<span class="lineNum">     162 </span><span class="lineNoCov">          0 :         array[i] = (T)0;</span>
<span class="lineNum">     163 </span>            :     }
<span class="lineNum">     164 </span>            : }
<span class="lineNum">     165 </span>            : 
<span class="lineNum">     166 </span>            : /************************************************************************************************/
<a name="167"><span class="lineNum">     167 </span>            : </a>
<span class="lineNum">     168 </span>            : template &lt;typename T&gt;
<span class="lineNum">     169 </span><span class="lineCov">     195940 : T fermi(T E,T mu,double temp,int mode)</span>
<span class="lineNum">     170 </span>            : {
<span class="lineNum">     171 </span><span class="lineCov">     195940 :     if (mode==0) {</span>
<span class="lineNum">     172 </span><span class="lineCov">     195940 :         if (temp&lt;=0.0) {</span>
<span class="lineNum">     173 </span><span class="lineNoCov">          0 :             temp=1.0E-8;</span>
<span class="lineNum">     174 </span>            :         }
<span class="lineNum">     175 </span><span class="lineCov">     195940 :         return 1.0/(1.0+exp((E-mu)/temp));</span>
<span class="lineNum">     176 </span><span class="lineNoCov">          0 :     } else if (mode==1) {</span>
<span class="lineNum">     177 </span><span class="lineNoCov">          0 :         if (temp&lt;=0.0) {</span>
<span class="lineNum">     178 </span>            :             return 0.0;
<span class="lineNum">     179 </span>            :         } else {
<span class="lineNum">     180 </span><span class="lineNoCov">          0 :             return log(1.0+exp(-(E-mu)/temp));</span>
<span class="lineNum">     181 </span>            :         }
<span class="lineNum">     182 </span><span class="lineNoCov">          0 :     } else if (mode==2) {</span>
<span class="lineNum">     183 </span><span class="lineNoCov">          0 :         if (temp&lt;=0.0) {</span>
<span class="lineNum">     184 </span>            :             return 0.0;
<span class="lineNum">     185 </span>            :         } else {
<span class="lineNum">     186 </span><span class="lineNoCov">          0 :             return 1.0/temp/(2.0+exp((E-mu)/temp)+1.0/exp((E-mu)/temp));</span>
<span class="lineNum">     187 </span>            :         }
<span class="lineNum">     188 </span><span class="lineNoCov">          0 :     } else if (mode==3) {</span>
<span class="lineNum">     189 </span><span class="lineNoCov">          0 :         if (temp&lt;=0.0) {</span>
<span class="lineNum">     190 </span>            :             return 0.0;
<span class="lineNum">     191 </span>            :         } else {
<span class="lineNum">     192 </span><span class="lineNoCov">          0 :             return exp((E-mu)/temp)/temp/(1.0+exp(-(E-mu)/temp));</span>
<span class="lineNum">     193 </span>            :         }
<span class="lineNum">     194 </span>            :     } else {
<span class="lineNum">     195 </span>            :         return 0.0;
<span class="lineNum">     196 </span>            :     }
<span class="lineNum">     197 </span>            : }
<span class="lineNum">     198 </span>            : 
<span class="lineNum">     199 </span>            : /************************************************************************************************/
<span class="lineNum">     200 </span>            : 
<span class="lineNum">     201 </span>            : class CSR{
<span class="lineNum">     202 </span>            : public:
<span class="lineNum">     203 </span>            :     
<span class="lineNum">     204 </span>            :     CSR(int,int);
<span class="lineNum">     205 </span>            :     ~CSR();
<span class="lineNum">     206 </span>            :     void update_diag(double*,double*);
<span class="lineNum">     207 </span>            :     void r_update_diag(double*);
<span class="lineNum">     208 </span>            :     void i_update_diag(double*);
<span class="lineNum">     209 </span>            :     void get_row_edge();
<span class="lineNum">     210 </span>            :     void write(const char*);
<span class="lineNum">     211 </span>            : 
<span class="lineNum">     212 </span>            :     int pos,size,n_nonzeros,type;
<span class="lineNum">     213 </span>            :     double *r_nnz,*i_nnz;
<span class="lineNum">     214 </span>            :     int *index_i,*index_j,*edge_i,*diag_pos;
<span class="lineNum">     215 </span>            :     
<span class="lineNum">     216 </span>            : private:
<span class="lineNum">     217 </span>            : };
<span class="lineNum">     218 </span>            : 
<span class="lineNum">     219 </span>            : template &lt;class T&gt;
<span class="lineNum">     220 </span>            : class TCSR{
<span class="lineNum">     221 </span>            : public:
<span class="lineNum">     222 </span>            :     
<span class="lineNum">     223 </span>            :     TCSR(int,int,int);
<span class="lineNum">     224 </span>            :     TCSR(TCSR&lt;T&gt;*);
<span class="lineNum">     225 </span>            :     TCSR(const char*);
<span class="lineNum">     226 </span>            :     TCSR(char*,int,int);
<span class="lineNum">     227 </span>            : // sab begin
<span class="lineNum">     228 </span>            : //create new matrix by cutting out from old one
<span class="lineNum">     229 </span>            :     TCSR(TCSR&lt;T&gt;*,int,int,int,int);
<span class="lineNum">     230 </span>            :     TCSR(cp2k_csr_interop_type&amp;,int,int,int,int);
<span class="lineNum">     231 </span>            :     TCSR(cp2k_csr_interop_type&amp;,MPI_Comm,int*,int,int,int,MPI_Comm*);
<span class="lineNum">     232 </span>            :     TCSR(cp2k_csr_interop_type&amp;);
<span class="lineNum">     233 </span>            : // this constructs a matrix by summing of a vector of matrices
<span class="lineNum">     234 </span>            :     TCSR(int,T*,TCSR&lt;T&gt;**,int=-1);
<span class="lineNum">     235 </span>            : // and this is the gather
<span class="lineNum">     236 </span>            :     TCSR(TCSR&lt;T&gt;*,MPI_Comm);
<span class="lineNum">     237 </span>            :     TCSR(TCSR&lt;T&gt;*,int,MPI_Comm);
<span class="lineNum">     238 </span>            :     TCSR(TCSR&lt;T&gt;*,int*,int,MPI_Comm);
<span class="lineNum">     239 </span>            :     TCSR(TCSR&lt;T&gt;*,MPI_Comm,int,MPI_Comm*,MPI_Comm*);
<span class="lineNum">     240 </span>            :     TCSR(MPI_Comm,TCSR&lt;T&gt;*);
<span class="lineNum">     241 </span>            : //distribute matrix according to pattern
<span class="lineNum">     242 </span>            :     TCSR(TCSR&lt;T&gt;*,TCSR&lt;T&gt;*,int,MPI_Comm);
<span class="lineNum">     243 </span>            : // sab end
<span class="lineNum">     244 </span>            :     ~TCSR();
<span class="lineNum">     245 </span>            :     void change_contain(TCSR&lt;T&gt;*);
<span class="lineNum">     246 </span>            :     void copy_index(TCSR&lt;double&gt;*);
<span class="lineNum">     247 </span>            :     void copy_index(TCSR&lt;CPX&gt;*);
<span class="lineNum">     248 </span>            :     void copy_contain(TCSR&lt;double&gt;*,double);
<span class="lineNum">     249 </span>            :     void copy_contain(TCSR&lt;CPX&gt;*,double);
<span class="lineNum">     250 </span>            :     void cpu_distribute(int*,int*,int,int,int);
<span class="lineNum">     251 </span>            :     void update_diag(T*,T);
<span class="lineNum">     252 </span>            :     void update_loc_diag(T*,T);
<span class="lineNum">     253 </span>            :     void update_diag_single(T);
<span class="lineNum">     254 </span>            :     void update_diag_single(T,int,int);
<span class="lineNum">     255 </span>            :     void update_diag_pack(T*,T,int);
<span class="lineNum">     256 </span>            :     void update_rdiag_pack(double*,int,int,double,int,int*);
<span class="lineNum">     257 </span>            :     void get_row_edge();
<span class="lineNum">     258 </span>            :     void get_diag_pos();
<span class="lineNum">     259 </span>            :     void scale_element(int,int*,T);
<span class="lineNum">     260 </span>            :     void mat_vec_mult(T*,T*,int);
<span class="lineNum">     261 </span>            :     void mat_vec_mult(T*,T*,int,int);
<span class="lineNum">     262 </span>            :     void trans_mat_vec_mult(T*,T*,int,int);
<span class="lineNum">     263 </span>            :     void trans_mat_vec_mult_omp(T*,T*,int,int);
<span class="lineNum">     264 </span>            :     void trans_mat_vec_mult(T*,T*,int,int,int);
<span class="lineNum">     265 </span>            :     void spec_mat_vec_mult(T*,T*,int,int*,int*,int,int);
<span class="lineNum">     266 </span>            :     void spec_mat_vec_mult(T*,T*,int,int*,int*,int,int,int*);
<span class="lineNum">     267 </span>            :     void sparse_to_full(T*,int,int);
<span class="lineNum">     268 </span>            :     void add_sparse_to_full(T*,int,int,T);
<span class="lineNum">     269 </span>            :     void sparse_to_cmp_full(CPX*,int,int);
<span class="lineNum">     270 </span>            :     void add_sparse_to_cmp_full(CPX*,int,int,CPX);
<span class="lineNum">     271 </span>            :     void full_to_sparse(T*,int,int);
<span class="lineNum">     272 </span>            :     void sparse_to_full_trans(T *,int ,int );
<span class="lineNum">     273 </span>            :     void cmp_full_to_sparse(CPX*,int,int,CPX);
<span class="lineNum">     274 </span>            :     void write_CSR(const char*);
<span class="lineNum">     275 </span>            :     void write(const char*);
<span class="lineNum">     276 </span>            :     void init_variable(int*,int);
<span class="lineNum">     277 </span>            :     void init_variable(double*,int);
<span class="lineNum">     278 </span>            :     void init_variable(CPX*,int);
<span class="lineNum">     279 </span>            :     void add_to_corner(T*,T,int*,int);
<span class="lineNum">     280 </span>            :     void change_findx(int);
<span class="lineNum">     281 </span>            :     void get_full_index_i(int*);
<span class="lineNum">     282 </span>            :     int get_msize(int,int,int,int*);
<span class="lineNum">     283 </span>            : // sab begin
<span class="lineNum">     284 </span>            :     void write_CSR_bin(const char*);
<span class="lineNum">     285 </span>            :     void mat_vec_mult_add(T*,T*,int,T);
<span class="lineNum">     286 </span>            :     int additionalentries(TCSR&lt;T&gt;*);
<span class="lineNum">     287 </span>            :     void add(TCSR&lt;T&gt;*,T);
<span class="lineNum">     288 </span>            :     void add_real(TCSR&lt;CPX&gt;*,CPX);
<span class="lineNum">     289 </span>            :     void copy_shifted(TCSR&lt;T&gt;*,int,int,int,int);
<span class="lineNum">     290 </span>            :     void copy_pbc_cell(contact_type,int,int,MPI_Comm);
<span class="lineNum">     291 </span>            :     void add_pot(TCSR&lt;T&gt;*,int*,T*);
<span class="lineNum">     292 </span>            :     void Bcast(int,MPI_Comm);
<span class="lineNum">     293 </span>            :     void scatter(TCSR&lt;T&gt;*,int,MPI_Comm);
<span class="lineNum">     294 </span>            :     void reduce(int,MPI_Comm);
<span class="lineNum">     295 </span>            :     void reducescatter(TCSR&lt;T&gt;*,MPI_Comm);
<span class="lineNum">     296 </span>            :     void distribute_back(cp2k_csr_interop_type&amp;,MPI_Comm,int*,int,int,int,MPI_Comm);
<span class="lineNum">     297 </span>            :     void psipsidagger(CPX*,int,CPX);
<span class="lineNum">     298 </span>            :     void psipsidagger(double*,int,double);
<span class="lineNum">     299 </span>            :     void psipsidagger_transpose(CPX*,int,CPX);
<span class="lineNum">     300 </span>            :     void psipsidagger_transpose(CPX*,CPX*,int,CPX);
<span class="lineNum">     301 </span>            :     double psipsidagger_transpose(TCSR&lt;double&gt;*,TCSR&lt;double&gt;*,CPX*,int,CPX);
<span class="lineNum">     302 </span>            :     void psipsidagger_transpose(TCSR&lt;double&gt;*,double*,int*,TCSR&lt;double&gt;*,CPX*,int,CPX,MPI_Comm);
<span class="lineNum">     303 </span>            :     void psipsidagger_transpose(double*,CPX*,int,MPI_Comm);
<span class="lineNum">     304 </span>            :     void psipsidagger_transpose(double*,int,double);
<span class="lineNum">     305 </span>            :     double psipsidagger(TCSR&lt;double&gt;*,CPX*,CPX*,CPX*,int,int,int,CPX);
<span class="lineNum">     306 </span>            :     double psipsidagger_transpose(TCSR&lt;double&gt;*,CPX*,CPX*,CPX*,int,int,int,CPX);
<span class="lineNum">     307 </span>            :     void atom_allocate(TCSR&lt;T&gt;*,int*,T*,T);
<span class="lineNum">     308 </span>            :     void settozeropbc(int,int);
<span class="lineNum">     309 </span>            :     void removepbc(int,int);
<span class="lineNum">     310 </span>            :     void tr_full_to_sparse(T*,int,int);
<span class="lineNum">     311 </span>            :     void full_to_sparse(T*,int,int,int,int);
<span class="lineNum">     312 </span>            :     void sparse_transpose(TCSR&lt;T&gt; *mat);
<span class="lineNum">     313 </span>            :     void extract_lower_triangle(TCSR&lt;T&gt;*);
<span class="lineNum">     314 </span>            :     void extract_upper_triangle(TCSR&lt;T&gt;*);
<span class="lineNum">     315 </span>            :     void sparse_to_full(T*,int,int,int,int);
<span class="lineNum">     316 </span>            :     void set_to_id();
<span class="lineNum">     317 </span>            :     void remove_thr(double);
<span class="lineNum">     318 </span>            :     int get_bandwidth(MPI_Comm);
<span class="lineNum">     319 </span>            :     void sparse_to_narrow_band(T*,int,int);
<span class="lineNum">     320 </span>            : // sab end
<span class="lineNum">     321 </span>            :     
<span class="lineNum">     322 </span>            :     void get_dense_by_range(T* matrix_out, int start_row, int start_col, int end_row, int end_col);
<span class="lineNum">     323 </span>            :     void get_dense_by_range_trans(T* matrix_out, int start_row, int start_col, int end_row, int end_col);
<span class="lineNum">     324 </span>            : 
<span class="lineNum">     325 </span>            :     int pos,size,size_tot,n_nonzeros,type,findx,first_row;
<span class="lineNum">     326 </span>            :     T *nnz;
<span class="lineNum">     327 </span>            :     int *index_i,*index_j,*edge_i,*diag_pos;
<span class="lineNum">     328 </span>            :     
<span class="lineNum">     329 </span>            : private:
<span class="lineNum">     330 </span>            :     inline MPI_Datatype give_me_MPI_datatype (double*)
<span class="lineNum">     331 </span>            :     {
<span class="lineNum">     332 </span>            :         return MPI_DOUBLE;
<span class="lineNum">     333 </span>            :     }
<span class="lineNum">     334 </span>            :     inline MPI_Datatype give_me_MPI_datatype (CPX*)
<span class="lineNum">     335 </span>            :     {
<span class="lineNum">     336 </span>            :         return MPI_DOUBLE_COMPLEX;
<span class="lineNum">     337 </span>            :     }
<span class="lineNum">     338 </span>            : };
<a name="339"><span class="lineNum">     339 </span>            : </a>
<span class="lineNum">     340 </span>            : template &lt;class T&gt;
<span class="lineNum">     341 </span><span class="lineCov">          7 : TCSR&lt;T&gt;::TCSR(int N, int n_nnz, int fortran_index)</span>
<span class="lineNum">     342 </span>            : {
<span class="lineNum">     343 </span><span class="lineCov">     383642 :     nnz        = new T[max(n_nnz,1)];</span>
<span class="lineNum">     344 </span><span class="lineCov">         14 :     index_i    = new int[max(N,1)];</span>
<span class="lineNum">     345 </span><span class="lineCov">         14 :     index_j    = new int[max(n_nnz,1)];</span>
<span class="lineNum">     346 </span><span class="lineCov">         14 :     edge_i     = new int[N+1];</span>
<span class="lineNum">     347 </span><span class="lineCov">         21 :     diag_pos   = new int[max(N,1)];</span>
<span class="lineNum">     348 </span>            : 
<span class="lineNum">     349 </span><span class="lineCov">          7 :     size       = N;</span>
<span class="lineNum">     350 </span><span class="lineCov">          7 :     size_tot   = N;</span>
<span class="lineNum">     351 </span><span class="lineCov">          7 :     type       = 0;</span>
<span class="lineNum">     352 </span><span class="lineCov">          7 :     n_nonzeros = n_nnz;</span>
<span class="lineNum">     353 </span><span class="lineCov">          7 :     findx      = fortran_index;</span>
<span class="lineNum">     354 </span><span class="lineCov">          7 :     first_row  = 0;                                                    </span>
<span class="lineNum">     355 </span><span class="lineCov">          7 : }</span>
<span class="lineNum">     356 </span>            : 
<span class="lineNum">     357 </span>            : /************************************************************************************************/
<a name="358"><span class="lineNum">     358 </span>            : </a>
<span class="lineNum">     359 </span>            : template &lt;class T&gt;
<span class="lineNum">     360 </span><span class="lineCov">         34 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *mat)</span>
<span class="lineNum">     361 </span>            : {
<span class="lineNum">     362 </span>            : 
<span class="lineNum">     363 </span><span class="lineCov">      12498 :     nnz        = new T[mat-&gt;n_nonzeros];</span>
<span class="lineNum">     364 </span><span class="lineCov">         62 :     index_i    = new int[mat-&gt;size];</span>
<span class="lineNum">     365 </span><span class="lineCov">         68 :     index_j    = new int[mat-&gt;n_nonzeros];</span>
<span class="lineNum">     366 </span><span class="lineCov">         68 :     edge_i     = new int[mat-&gt;size+1];</span>
<span class="lineNum">     367 </span><span class="lineCov">         68 :     diag_pos   = new int[mat-&gt;size];</span>
<span class="lineNum">     368 </span>            : 
<span class="lineNum">     369 </span><span class="lineCov">         34 :     size       = mat-&gt;size;</span>
<span class="lineNum">     370 </span><span class="lineCov">         34 :     size_tot   = mat-&gt;size_tot;</span>
<span class="lineNum">     371 </span><span class="lineCov">         34 :     type       = mat-&gt;type;</span>
<span class="lineNum">     372 </span><span class="lineCov">         34 :     n_nonzeros = mat-&gt;n_nonzeros;</span>
<span class="lineNum">     373 </span><span class="lineCov">         34 :     findx      = mat-&gt;findx;</span>
<span class="lineNum">     374 </span><span class="lineCov">         34 :     first_row  = mat-&gt;first_row;</span>
<span class="lineNum">     375 </span>            :     
<span class="lineNum">     376 </span><span class="lineCov">         68 :     c_tcopy(n_nonzeros,mat-&gt;nnz,1,nnz,1);</span>
<span class="lineNum">     377 </span><span class="lineCov">         68 :     c_icopy(size,mat-&gt;index_i,1,index_i,1);</span>
<span class="lineNum">     378 </span><span class="lineCov">         68 :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);</span>
<span class="lineNum">     379 </span><span class="lineCov">         68 :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);</span>
<span class="lineNum">     380 </span><span class="lineCov">         68 :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);</span>
<span class="lineNum">     381 </span><span class="lineCov">         34 : }</span>
<span class="lineNum">     382 </span>            : 
<span class="lineNum">     383 </span>            : /******************** written by SAB ********************/
<a name="384"><span class="lineNum">     384 </span>            : </a>
<span class="lineNum">     385 </span>            : template &lt;class T&gt;
<span class="lineNum">     386 </span><span class="lineCov">         13 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *mat,int istart, int ilength, int jstart, int jlength)</span>
<span class="lineNum">     387 </span>            : {
<span class="lineNum">     388 </span><span class="lineCov">         13 :     if (istart&lt;0)                     throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     389 </span><span class="lineCov">         13 :     if (jstart&lt;0)                     throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     390 </span><span class="lineCov">         13 :     if (ilength&lt;0)                    throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     391 </span><span class="lineCov">         13 :     if (jlength&lt;0)                    throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     392 </span><span class="lineCov">         13 :     if (istart+ilength&gt;mat-&gt;size_tot) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     393 </span>            : 
<span class="lineNum">     394 </span><span class="lineCov">         13 :     int iend       = istart+ilength;</span>
<span class="lineNum">     395 </span><span class="lineCov">         13 :     int jend       = jstart+jlength;</span>
<span class="lineNum">     396 </span><span class="lineCov">         39 :     int loc_istart = max(0,min(mat-&gt;size,istart-mat-&gt;first_row));</span>
<span class="lineNum">     397 </span><span class="lineCov">         39 :     int loc_iend   = max(0,min(mat-&gt;size,iend-mat-&gt;first_row));</span>
<span class="lineNum">     398 </span>            : 
<span class="lineNum">     399 </span><span class="lineCov">         13 :     size       = loc_iend-loc_istart;</span>
<span class="lineNum">     400 </span><span class="lineCov">         13 :     size_tot   = ilength;</span>
<span class="lineNum">     401 </span><span class="lineCov">         13 :     type       = mat-&gt;type;</span>
<span class="lineNum">     402 </span><span class="lineCov">         13 :     findx      = mat-&gt;findx;</span>
<span class="lineNum">     403 </span><span class="lineCov">         39 :     first_row  = min(ilength,max(0,mat-&gt;first_row-istart));</span>
<span class="lineNum">     404 </span>            : 
<span class="lineNum">     405 </span><span class="lineCov">         13 :     n_nonzeros = 0;</span>
<span class="lineNum">     406 </span>            : 
<span class="lineNum">     407 </span><span class="lineCov">       1669 :     for (int i=loc_istart;i&lt;loc_iend;i++) {</span>
<span class="lineNum">     408 </span><span class="lineCov">     277022 :         for(int e=mat-&gt;edge_i[i]-mat-&gt;findx;e&lt;mat-&gt;edge_i[i+1]-mat-&gt;findx;e++){</span>
<span class="lineNum">     409 </span><span class="lineCov">     275366 :             if(mat-&gt;index_j[e]-mat-&gt;findx&gt;=jstart &amp;&amp; mat-&gt;index_j[e]-mat-&gt;findx&lt;jend){</span>
<span class="lineNum">     410 </span><span class="lineCov">     114170 :                 n_nonzeros++;</span>
<span class="lineNum">     411 </span>            :             }
<span class="lineNum">     412 </span>            :         }
<span class="lineNum">     413 </span>            :     }
<span class="lineNum">     414 </span>            : 
<span class="lineNum">     415 </span><span class="lineCov">     114196 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     416 </span><span class="lineCov">         26 :     index_i    = new int[max(size,1)];</span>
<span class="lineNum">     417 </span><span class="lineCov">         26 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     418 </span><span class="lineCov">         26 :     edge_i     = new int[size+1];</span>
<span class="lineNum">     419 </span><span class="lineCov">         39 :     diag_pos   = new int[max(size,1)];</span>
<span class="lineNum">     420 </span>            : 
<span class="lineNum">     421 </span><span class="lineCov">         13 :     n_nonzeros = 0;</span>
<span class="lineNum">     422 </span><span class="lineCov">         13 :     init_variable(index_i,size);</span>
<span class="lineNum">     423 </span>            : 
<span class="lineNum">     424 </span><span class="lineCov">       3325 :     for (int i=loc_istart;i&lt;loc_iend;i++) {</span>
<span class="lineNum">     425 </span><span class="lineCov">     277022 :         for(int e=mat-&gt;edge_i[i]-mat-&gt;findx;e&lt;mat-&gt;edge_i[i+1]-mat-&gt;findx;e++){</span>
<span class="lineNum">     426 </span><span class="lineCov">     275366 :             if(mat-&gt;index_j[e]-mat-&gt;findx&gt;=jstart &amp;&amp; mat-&gt;index_j[e]-mat-&gt;findx&lt;jend){</span>
<span class="lineNum">     427 </span><span class="lineCov">     114170 :                 index_i[i-loc_istart]++;</span>
<span class="lineNum">     428 </span><span class="lineCov">     114170 :                 index_j[n_nonzeros]=mat-&gt;index_j[e]-jstart;</span>
<span class="lineNum">     429 </span><span class="lineCov">     114170 :                 nnz[n_nonzeros]=mat-&gt;nnz[e];</span>
<span class="lineNum">     430 </span><span class="lineCov">     114170 :                 n_nonzeros++;</span>
<span class="lineNum">     431 </span>            :             }
<span class="lineNum">     432 </span>            :         }
<span class="lineNum">     433 </span>            :     }
<span class="lineNum">     434 </span>            : 
<span class="lineNum">     435 </span><span class="lineCov">         13 :     get_row_edge();</span>
<span class="lineNum">     436 </span><span class="lineCov">         13 :     get_diag_pos();</span>
<span class="lineNum">     437 </span>            : 
<span class="lineNum">     438 </span><span class="lineCov">         13 :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     439 </span><span class="lineCov">         13 : }</span>
<span class="lineNum">     440 </span>            : 
<span class="lineNum">     441 </span>            : /******************** written by SAB ********************/
<a name="442"><span class="lineNum">     442 </span>            : </a>
<span class="lineNum">     443 </span>            : template &lt;class T&gt;
<span class="lineNum">     444 </span><span class="lineCov">         32 : inline TCSR&lt;T&gt;::TCSR(cp2k_csr_interop_type&amp; cp2kCSRmat,int istart, int ilength, int jstart, int jlength)</span>
<span class="lineNum">     445 </span>            : {
<span class="lineNum">     446 </span><span class="lineCov">         32 :     if (istart&lt;0)                              throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     447 </span><span class="lineCov">         32 :     if (jstart&lt;0)                              throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     448 </span><span class="lineCov">         32 :     if (ilength&lt;0)                             throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     449 </span><span class="lineCov">         32 :     if (jlength&lt;0)                             throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     450 </span><span class="lineCov">         32 :     if (istart+ilength&gt;cp2kCSRmat.nrows_total) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     451 </span>            : 
<span class="lineNum">     452 </span><span class="lineCov">         32 :     int iend       = istart+ilength;</span>
<span class="lineNum">     453 </span><span class="lineCov">         32 :     int jend       = jstart+jlength;</span>
<span class="lineNum">     454 </span><span class="lineCov">         96 :     int loc_istart = max(0,min(cp2kCSRmat.nrows_local,istart-cp2kCSRmat.first_row));</span>
<span class="lineNum">     455 </span><span class="lineCov">         96 :     int loc_iend   = max(0,min(cp2kCSRmat.nrows_local,iend-cp2kCSRmat.first_row));</span>
<span class="lineNum">     456 </span>            : 
<span class="lineNum">     457 </span><span class="lineCov">         32 :     size       = loc_iend-loc_istart;</span>
<span class="lineNum">     458 </span><span class="lineCov">         32 :     size_tot   = ilength;</span>
<span class="lineNum">     459 </span><span class="lineCov">         32 :     type       = 0;</span>
<span class="lineNum">     460 </span><span class="lineCov">         32 :     findx      = 1;</span>
<span class="lineNum">     461 </span><span class="lineCov">         96 :     first_row  = min(ilength,max(0,cp2kCSRmat.first_row-istart));</span>
<span class="lineNum">     462 </span>            : 
<span class="lineNum">     463 </span><span class="lineCov">         32 :     n_nonzeros = 0;</span>
<span class="lineNum">     464 </span>            : 
<span class="lineNum">     465 </span><span class="lineCov">       1184 :     for (int i=loc_istart;i&lt;loc_iend;i++) {</span>
<span class="lineNum">     466 </span><span class="lineCov">     272512 :         for(int e=cp2kCSRmat.rowptr_local[i]-1;e&lt;cp2kCSRmat.rowptr_local[i+1]-1;e++){</span>
<span class="lineNum">     467 </span><span class="lineCov">     271360 :             if(cp2kCSRmat.colind_local[e]-1&gt;=jstart &amp;&amp; cp2kCSRmat.colind_local[e]-1&lt;jend){</span>
<span class="lineNum">     468 </span><span class="lineCov">      42912 :                 n_nonzeros++;</span>
<span class="lineNum">     469 </span>            :             }
<span class="lineNum">     470 </span>            :         }
<span class="lineNum">     471 </span>            :     }
<span class="lineNum">     472 </span>            : 
<span class="lineNum">     473 </span><span class="lineCov">         64 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     474 </span><span class="lineCov">         64 :     index_i    = new int[max(size,1)];</span>
<span class="lineNum">     475 </span><span class="lineCov">         64 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     476 </span><span class="lineCov">         64 :     edge_i     = new int[size+1];</span>
<span class="lineNum">     477 </span><span class="lineCov">         96 :     diag_pos   = new int[max(size,1)];</span>
<span class="lineNum">     478 </span>            : 
<span class="lineNum">     479 </span><span class="lineCov">         32 :     n_nonzeros = 0;</span>
<span class="lineNum">     480 </span><span class="lineCov">         32 :     init_variable(index_i,size);</span>
<span class="lineNum">     481 </span>            : 
<span class="lineNum">     482 </span><span class="lineCov">       2336 :     for (int i=loc_istart;i&lt;loc_iend;i++) {</span>
<span class="lineNum">     483 </span><span class="lineCov">     272512 :         for(int e=cp2kCSRmat.rowptr_local[i]-1;e&lt;cp2kCSRmat.rowptr_local[i+1]-1;e++){</span>
<span class="lineNum">     484 </span><span class="lineCov">     271360 :             if(cp2kCSRmat.colind_local[e]-1&gt;=jstart &amp;&amp; cp2kCSRmat.colind_local[e]-1&lt;jend){</span>
<span class="lineNum">     485 </span><span class="lineCov">      42912 :                 index_i[i-loc_istart]++;</span>
<span class="lineNum">     486 </span><span class="lineCov">      42912 :                 index_j[n_nonzeros]=cp2kCSRmat.colind_local[e]-jstart;</span>
<span class="lineNum">     487 </span><span class="lineCov">      42912 :                 nnz[n_nonzeros]=cp2kCSRmat.nzvals_local[e];</span>
<span class="lineNum">     488 </span><span class="lineCov">      42912 :                 n_nonzeros++;</span>
<span class="lineNum">     489 </span>            :             }
<span class="lineNum">     490 </span>            :         }
<span class="lineNum">     491 </span>            :     }
<span class="lineNum">     492 </span>            : 
<span class="lineNum">     493 </span><span class="lineCov">         32 :     get_row_edge();</span>
<span class="lineNum">     494 </span><span class="lineCov">         32 :     get_diag_pos();</span>
<span class="lineNum">     495 </span>            : 
<span class="lineNum">     496 </span><span class="lineCov">         32 :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     497 </span><span class="lineCov">         32 : }</span>
<span class="lineNum">     498 </span>            : 
<span class="lineNum">     499 </span>            : /******************** written by SAB ********************/
<a name="500"><span class="lineNum">     500 </span>            : </a>
<span class="lineNum">     501 </span>            : template &lt;class T&gt;
<span class="lineNum">     502 </span><span class="lineCov">          4 : inline TCSR&lt;T&gt;::TCSR(cp2k_csr_interop_type&amp; cp2kCSRmat,MPI_Comm my_comm_in,int *sizes,int outsize,int cutoutl,int cutoutr,MPI_Comm *my_comm_out)</span>
<span class="lineNum">     503 </span>            : {
<span class="lineNum">     504 </span><span class="lineCov">          4 :     findx=1;</span>
<span class="lineNum">     505 </span><span class="lineCov">          4 :     type=0;</span>
<span class="lineNum">     506 </span><span class="lineCov">          4 :     int *frows_out = new int[outsize+1];</span>
<span class="lineNum">     507 </span><span class="lineCov">          4 :     frows_out[0]=0;</span>
<span class="lineNum">     508 </span><span class="lineCov">         12 :     for (int i=0;i&lt;outsize;i++) frows_out[i+1]=frows_out[i]+sizes[i];</span>
<span class="lineNum">     509 </span><span class="lineCov">          4 :     size_tot=frows_out[outsize];</span>
<span class="lineNum">     510 </span><span class="lineCov">          4 :     if (size_tot+cutoutl+cutoutr!=cp2kCSRmat.nrows_total) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     511 </span>            :     int iam,insize;
<span class="lineNum">     512 </span><span class="lineCov">          4 :     MPI_Comm_size(my_comm_in,&amp;insize);</span>
<span class="lineNum">     513 </span><span class="lineCov">          4 :     MPI_Comm_rank(my_comm_in,&amp;iam);</span>
<span class="lineNum">     514 </span><span class="lineCov">          4 :     if (insize%outsize) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     515 </span><span class="lineCov">          4 :     int *first_rows  = new int[insize+1];</span>
<span class="lineNum">     516 </span><span class="lineCov">          8 :     int *displc_size = new int[insize+1];</span>
<span class="lineNum">     517 </span><span class="lineCov">          8 :     int *dist_size   = new int[insize];</span>
<span class="lineNum">     518 </span><span class="lineCov">          8 :     int *displc_nnz  = new int[insize+1];</span>
<span class="lineNum">     519 </span><span class="lineCov">          8 :     int *dist_nnz    = new int[insize];</span>
<span class="lineNum">     520 </span><span class="lineCov">          4 :     MPI_Allgather(&amp;cp2kCSRmat.first_row,1,MPI_INT,first_rows,1,MPI_INT,my_comm_in);</span>
<span class="lineNum">     521 </span><span class="lineCov">          4 :     first_rows[insize]=cp2kCSRmat.nrows_total;</span>
<span class="lineNum">     522 </span><span class="lineCov">          4 :     index_i=NULL;</span>
<span class="lineNum">     523 </span><span class="lineCov">          4 :     index_j=NULL;</span>
<span class="lineNum">     524 </span><span class="lineCov">          4 :     nnz=NULL;</span>
<span class="lineNum">     525 </span><span class="lineCov">          4 :     if (iam&lt;outsize) {</span>
<span class="lineNum">     526 </span><span class="lineCov">          2 :         size      = sizes[iam];</span>
<span class="lineNum">     527 </span><span class="lineCov">          2 :         first_row = frows_out[iam];</span>
<span class="lineNum">     528 </span><span class="lineCov">          4 :         index_i   = new int[max(size,1)];</span>
<span class="lineNum">     529 </span><span class="lineCov">          4 :         edge_i    = new int[size+1];</span>
<span class="lineNum">     530 </span><span class="lineCov">          4 :         diag_pos  = new int[max(size,1)];</span>
<span class="lineNum">     531 </span>            :     }
<span class="lineNum">     532 </span><span class="lineCov">         12 :     for (int ir=0;ir&lt;outsize;ir++) {</span>
<span class="lineNum">     533 </span><span class="lineCov">         28 :         for (int i=0;i&lt;insize+1;i++) {</span>
<span class="lineNum">     534 </span><span class="lineCov">         12 :             displc_size[i]=first_rows[i]-cutoutl-frows_out[ir];</span>
<span class="lineNum">     535 </span><span class="lineCov">         12 :             if (displc_size[i]&lt;0)         displc_size[i]=0;</span>
<span class="lineNum">     536 </span><span class="lineCov">         12 :             if (displc_size[i]&gt;sizes[ir]) displc_size[i]=sizes[ir];</span>
<span class="lineNum">     537 </span>            :         }
<span class="lineNum">     538 </span><span class="lineCov">         20 :         for (int i=0;i&lt;insize;i++) {</span>
<span class="lineNum">     539 </span><span class="lineCov">          8 :             dist_size[i]=displc_size[i+1]-displc_size[i];</span>
<span class="lineNum">     540 </span>            :         }
<span class="lineNum">     541 </span><span class="lineCov">          4 :         int start_size=0;</span>
<span class="lineNum">     542 </span><span class="lineCov">          4 :         int end_size=cp2kCSRmat.nrows_local;</span>
<span class="lineNum">     543 </span><span class="lineCov">          4 :         if (displc_size[iam]==0 &amp;&amp; dist_size[iam]&gt;0) start_size=cutoutl+frows_out[ir]-first_rows[iam];</span>
<span class="lineNum">     544 </span><span class="lineCov">          4 :         if (displc_size[iam]==sizes[ir]-dist_size[iam] &amp;&amp; dist_size[iam]&gt;0) end_size=start_size+dist_size[iam];</span>
<span class="lineNum">     545 </span><span class="lineCov">          4 :         int dist_nnz_local=0;</span>
<span class="lineNum">     546 </span><span class="lineCov">          4 :         if (dist_size[iam]&gt;0) dist_nnz_local=cp2kCSRmat.rowptr_local[end_size]-cp2kCSRmat.rowptr_local[start_size];</span>
<span class="lineNum">     547 </span><span class="lineCov">          4 :         int start_nnz=cp2kCSRmat.rowptr_local[start_size]-1;</span>
<span class="lineNum">     548 </span><span class="lineCov">          4 :         MPI_Allgather(&amp;dist_nnz_local,1,MPI_INT,dist_nnz,1,MPI_INT,my_comm_in);</span>
<span class="lineNum">     549 </span><span class="lineCov">          4 :         displc_nnz[0]=0;</span>
<span class="lineNum">     550 </span><span class="lineCov">         12 :         for (int i=0;i&lt;insize;i++) {</span>
<span class="lineNum">     551 </span><span class="lineCov">          8 :             displc_nnz[i+1]=displc_nnz[i]+dist_nnz[i];</span>
<span class="lineNum">     552 </span>            :         }
<span class="lineNum">     553 </span><span class="lineCov">          4 :         if (iam==ir) {</span>
<span class="lineNum">     554 </span><span class="lineCov">          2 :             n_nonzeros=displc_nnz[insize];</span>
<span class="lineNum">     555 </span><span class="lineCov">          4 :             index_j = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     556 </span><span class="lineCov">          4 :             nnz     = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     557 </span>            :         }
<span class="lineNum">     558 </span><span class="lineCov">          4 :         MPI_Gatherv(&amp;cp2kCSRmat.nzerow_local[start_size],dist_size[iam],MPI_INT,index_i,dist_size,displc_size,MPI_INT,ir,my_comm_in);</span>
<span class="lineNum">     559 </span><span class="lineCov">          4 :         MPI_Gatherv(&amp;cp2kCSRmat.colind_local[start_nnz],dist_nnz[iam],MPI_INT,index_j,dist_nnz,displc_nnz,MPI_INT,ir,my_comm_in);</span>
<span class="lineNum">     560 </span><span class="lineCov">          4 :         MPI_Gatherv(&amp;cp2kCSRmat.nzvals_local[start_nnz],dist_nnz[iam],give_me_MPI_datatype(nnz),nnz,dist_nnz,displc_nnz,give_me_MPI_datatype(nnz),ir,my_comm_in);</span>
<span class="lineNum">     561 </span><span class="lineCov">          4 :         if (iam==ir) {</span>
<span class="lineNum">     562 </span><span class="lineCov">          2 :             get_row_edge();</span>
<span class="lineNum">     563 </span><span class="lineCov">          2 :             get_diag_pos();</span>
<span class="lineNum">     564 </span>            :         }
<span class="lineNum">     565 </span>            :     }
<span class="lineNum">     566 </span><span class="lineCov">          4 :     delete[] frows_out;</span>
<span class="lineNum">     567 </span><span class="lineCov">          4 :     delete[] first_rows;</span>
<span class="lineNum">     568 </span><span class="lineCov">          4 :     delete[] displc_size;</span>
<span class="lineNum">     569 </span><span class="lineCov">          4 :     delete[] dist_size;</span>
<span class="lineNum">     570 </span><span class="lineCov">          4 :     delete[] displc_nnz;</span>
<span class="lineNum">     571 </span><span class="lineCov">          4 :     delete[] dist_nnz;</span>
<span class="lineNum">     572 </span>            : 
<span class="lineNum">     573 </span><span class="lineCov">          4 :     MPI_Comm_split(my_comm_in,iam/outsize,iam,my_comm_out);</span>
<span class="lineNum">     574 </span>            :     int rank_my_comm_out;
<span class="lineNum">     575 </span><span class="lineCov">          4 :     MPI_Comm_rank(*my_comm_out,&amp;rank_my_comm_out);</span>
<span class="lineNum">     576 </span>            :     MPI_Comm equal_rank_comm;
<span class="lineNum">     577 </span><span class="lineCov">          4 :     MPI_Comm_split(my_comm_in,rank_my_comm_out,iam,&amp;equal_rank_comm);</span>
<span class="lineNum">     578 </span>            : 
<span class="lineNum">     579 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;size      ,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     580 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;size_tot  ,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     581 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;type      ,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     582 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;n_nonzeros,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     583 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;findx     ,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     584 </span><span class="lineCov">          4 :     MPI_Bcast(&amp;first_row ,1,MPI_INT,0,equal_rank_comm);</span>
<span class="lineNum">     585 </span>            : 
<span class="lineNum">     586 </span><span class="lineCov">          4 :     if (iam&gt;=outsize) {</span>
<span class="lineNum">     587 </span><span class="lineCov">          2 :         nnz      = new T[n_nonzeros];</span>
<span class="lineNum">     588 </span><span class="lineCov">          4 :         index_i  = new int[size];</span>
<span class="lineNum">     589 </span><span class="lineCov">          4 :         index_j  = new int[n_nonzeros];</span>
<span class="lineNum">     590 </span><span class="lineCov">          4 :         edge_i   = new int[size+1];</span>
<span class="lineNum">     591 </span><span class="lineCov">          4 :         diag_pos = new int[size];</span>
<span class="lineNum">     592 </span>            :     }
<span class="lineNum">     593 </span>            : 
<span class="lineNum">     594 </span><span class="lineCov">          4 :     MPI_Bcast(nnz,     n_nonzeros,give_me_MPI_datatype(nnz),0,equal_rank_comm);</span>
<span class="lineNum">     595 </span><span class="lineCov">          4 :     MPI_Bcast(index_i, size      ,MPI_INT                  ,0,equal_rank_comm);</span>
<span class="lineNum">     596 </span><span class="lineCov">          4 :     MPI_Bcast(index_j, n_nonzeros,MPI_INT                  ,0,equal_rank_comm);</span>
<span class="lineNum">     597 </span><span class="lineCov">          4 :     MPI_Bcast(edge_i,  size+1    ,MPI_INT                  ,0,equal_rank_comm);</span>
<span class="lineNum">     598 </span><span class="lineCov">          4 :     MPI_Bcast(diag_pos,size      ,MPI_INT                  ,0,equal_rank_comm);</span>
<span class="lineNum">     599 </span>            : 
<span class="lineNum">     600 </span><span class="lineCov">          4 :     MPI_Comm_free(&amp;equal_rank_comm);</span>
<span class="lineNum">     601 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">     602 </span>            : 
<span class="lineNum">     603 </span>            : /******************** written by SAB ********************/
<span class="lineNum">     604 </span>            : 
<span class="lineNum">     605 </span>            : template &lt;class T&gt;
<span class="lineNum">     606 </span>            : inline TCSR&lt;T&gt;::TCSR(cp2k_csr_interop_type&amp; cp2kCSRmat)
<span class="lineNum">     607 </span>            : {
<span class="lineNum">     608 </span>            :     size       = cp2kCSRmat.nrows_local;
<span class="lineNum">     609 </span>            :     size_tot   = cp2kCSRmat.nrows_total;
<span class="lineNum">     610 </span>            :     type       = 0;
<span class="lineNum">     611 </span>            :     findx      = 1;
<span class="lineNum">     612 </span>            :     first_row  = cp2kCSRmat.first_row;
<span class="lineNum">     613 </span>            :     n_nonzeros = cp2kCSRmat.nze_local;
<span class="lineNum">     614 </span>            : 
<span class="lineNum">     615 </span>            :     nnz        = new T[n_nonzeros];
<span class="lineNum">     616 </span>            :     index_i    = new int[size];
<span class="lineNum">     617 </span>            :     index_j    = new int[n_nonzeros];
<span class="lineNum">     618 </span>            :     edge_i     = new int[size+1];
<span class="lineNum">     619 </span>            :     diag_pos   = new int[size];
<span class="lineNum">     620 </span>            : 
<span class="lineNum">     621 </span>            :     c_tcopy(n_nonzeros,cp2kCSRmat.nzvals_local,1,nnz,1);
<span class="lineNum">     622 </span>            :     c_icopy(size,cp2kCSRmat.nzerow_local,1,index_i,1);
<span class="lineNum">     623 </span>            :     c_icopy(n_nonzeros,cp2kCSRmat.colind_local,1,index_j,1);
<span class="lineNum">     624 </span>            :     c_icopy(size+1,cp2kCSRmat.rowptr_local,1,edge_i,1);
<span class="lineNum">     625 </span>            : 
<span class="lineNum">     626 </span>            :     get_diag_pos();
<span class="lineNum">     627 </span>            : }
<span class="lineNum">     628 </span>            : 
<span class="lineNum">     629 </span>            : /******************** written by SAB ********************/
<span class="lineNum">     630 </span>            : 
<span class="lineNum">     631 </span>            : template &lt;class T&gt;
<span class="lineNum">     632 </span><span class="lineCov">          1 : inline TCSR&lt;T&gt;::TCSR(int N,T *factors,TCSR&lt;T&gt; **A,int jlength)</span>
<span class="lineNum">     633 </span>            : {
<span class="lineNum">     634 </span>            :     int i,j,e,n;
<span class="lineNum">     635 </span><span class="lineCov">          1 :     T factor = 1.0;</span>
<span class="lineNum">     636 </span>            : 
<span class="lineNum">     637 </span><span class="lineCov">          1 :     size       = A[0]-&gt;size; </span>
<span class="lineNum">     638 </span><span class="lineCov">          1 :     size_tot   = A[0]-&gt;size_tot;</span>
<span class="lineNum">     639 </span><span class="lineCov">          1 :     type       = A[0]-&gt;type;</span>
<span class="lineNum">     640 </span><span class="lineCov">          1 :     findx      = A[0]-&gt;findx;</span>
<span class="lineNum">     641 </span><span class="lineCov">          1 :     first_row  = A[0]-&gt;first_row;</span>
<span class="lineNum">     642 </span><span class="lineCov">          1 :     n_nonzeros = A[0]-&gt;n_nonzeros;</span>
<span class="lineNum">     643 </span><span class="lineCov">          3 :     for (n=1;n&lt;N;n++) {</span>
<span class="lineNum">     644 </span><span class="lineCov">          2 :         if (size      != A[n]-&gt;size      ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     645 </span><span class="lineCov">          2 :         if (size_tot  != A[n]-&gt;size_tot  ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     646 </span><span class="lineCov">          2 :         if (type      != A[n]-&gt;type      ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     647 </span><span class="lineCov">          2 :         if (findx     != A[n]-&gt;findx     ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     648 </span><span class="lineCov">          2 :         if (first_row != A[n]-&gt;first_row ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     649 </span><span class="lineCov">          2 :         n_nonzeros+=A[n]-&gt;n_nonzeros;</span>
<span class="lineNum">     650 </span>            :     }
<span class="lineNum">     651 </span>            : 
<span class="lineNum">     652 </span><span class="lineCov">          1 :     index_i  = new int[size];</span>
<span class="lineNum">     653 </span><span class="lineCov">          2 :     edge_i   = new int[size+1];</span>
<span class="lineNum">     654 </span><span class="lineCov">          2 :     diag_pos = new int[size];</span>
<span class="lineNum">     655 </span>            : 
<span class="lineNum">     656 </span><span class="lineCov">     293275 :     T *nnz_tmp       = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     657 </span><span class="lineCov">          2 :     int *index_j_tmp = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     658 </span>            : 
<span class="lineNum">     659 </span><span class="lineCov">          1 :     n_nonzeros=0;</span>
<span class="lineNum">     660 </span>            : 
<span class="lineNum">     661 </span><span class="lineCov">          2 :     if (jlength&lt;0) jlength=size_tot;</span>
<span class="lineNum">     662 </span><span class="lineCov">       1153 :     T *linefull = new T[jlength];</span>
<span class="lineNum">     663 </span>            : 
<span class="lineNum">     664 </span><span class="lineCov">       2305 :     for (i=0;i&lt;size;i++) {</span>
<span class="lineNum">     665 </span><span class="lineCov">       1152 :         int start=jlength;</span>
<span class="lineNum">     666 </span><span class="lineCov">       1152 :         int end=0;</span>
<span class="lineNum">     667 </span><span class="lineCov">       1152 :         int have_row=0;</span>
<span class="lineNum">     668 </span>            :         int has_row;
<span class="lineNum">     669 </span><span class="lineCov">       4608 :         for (n=0;n&lt;N;n++) {</span>
<span class="lineNum">     670 </span><span class="lineCov">       3456 :             if (A[n]-&gt;edge_i[i+1]-A[n]-&gt;edge_i[i]) {</span>
<span class="lineNum">     671 </span><span class="lineCov">       3000 :                 start=min(start,A[n]-&gt;index_j[A[n]-&gt;edge_i[i]-A[n]-&gt;findx]-A[n]-&gt;findx);</span>
<span class="lineNum">     672 </span><span class="lineCov">       3000 :                 end=max(end,A[n]-&gt;index_j[A[n]-&gt;edge_i[i+1]-1-A[n]-&gt;findx]-A[n]-&gt;findx+1);</span>
<span class="lineNum">     673 </span><span class="lineCov">       1500 :                 have_row++;</span>
<span class="lineNum">     674 </span><span class="lineCov">       1500 :                 has_row=n;</span>
<span class="lineNum">     675 </span>            :             }
<span class="lineNum">     676 </span>            :         }
<span class="lineNum">     677 </span><span class="lineCov">       1152 :         if (have_row==1) {</span>
<span class="lineNum">     678 </span><span class="lineCov">        804 :             int index_length=A[has_row]-&gt;edge_i[i+1]-A[has_row]-&gt;edge_i[i];</span>
<span class="lineNum">     679 </span><span class="lineCov">       1608 :             c_tcopy(index_length,&amp;A[has_row]-&gt;nnz[A[has_row]-&gt;edge_i[i]-A[has_row]-&gt;findx],1,&amp;nnz_tmp[n_nonzeros],1);</span>
<span class="lineNum">     680 </span><span class="lineCov">       1608 :             c_icopy(index_length,&amp;A[has_row]-&gt;index_j[A[has_row]-&gt;edge_i[i]-A[has_row]-&gt;findx],1,&amp;index_j_tmp[n_nonzeros],1);</span>
<span class="lineNum">     681 </span><span class="lineCov">        804 :             index_i[i]=index_length;</span>
<span class="lineNum">     682 </span><span class="lineCov">        804 :             n_nonzeros+=index_length;</span>
<span class="lineNum">     683 </span><span class="lineCov">        348 :         } else if (have_row&gt;1) {</span>
<span class="lineNum">     684 </span><span class="lineCov">        696 :             init_variable(linefull,end-start);</span>
<span class="lineNum">     685 </span><span class="lineCov">        348 :             index_i[i]=0;</span>
<span class="lineNum">     686 </span><span class="lineCov">       1392 :             for (n=0;n&lt;N;n++) {</span>
<span class="lineNum">     687 </span><span class="lineCov">       1044 :                 if (factors) factor=factors[n];</span>
<span class="lineNum">     688 </span><span class="lineCov">     110341 :                 for (e=A[n]-&gt;edge_i[i]-A[n]-&gt;findx;e&lt;A[n]-&gt;edge_i[i+1]-A[n]-&gt;findx;e++) {</span>
<span class="lineNum">     689 </span><span class="lineCov">     327891 :                     linefull[A[n]-&gt;index_j[e]-A[n]-&gt;findx-start]+=factor*A[n]-&gt;nnz[e];</span>
<span class="lineNum">     690 </span>            :                 }
<span class="lineNum">     691 </span>            :             }
<span class="lineNum">     692 </span><span class="lineCov">     198232 :             for (j=0;j&lt;end-start;j++) {</span>
<span class="lineNum">     693 </span><span class="lineCov">     197884 :                 if (abs(linefull[j])) {</span>
<span class="lineNum">     694 </span><span class="lineCov">      76769 :                     nnz_tmp[n_nonzeros]=linefull[j];</span>
<span class="lineNum">     695 </span><span class="lineCov">      76769 :                     index_j_tmp[n_nonzeros]=j+findx+start;</span>
<span class="lineNum">     696 </span><span class="lineCov">      76769 :                     index_i[i]++;</span>
<span class="lineNum">     697 </span><span class="lineCov">      76769 :                     n_nonzeros++;</span>
<span class="lineNum">     698 </span>            :                 }
<span class="lineNum">     699 </span>            :             }
<span class="lineNum">     700 </span>            :         }
<span class="lineNum">     701 </span>            :     }
<span class="lineNum">     702 </span>            : 
<span class="lineNum">     703 </span><span class="lineCov">          1 :     delete[] linefull;</span>
<span class="lineNum">     704 </span>            : 
<span class="lineNum">     705 </span><span class="lineCov">     260747 :     nnz = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     706 </span><span class="lineCov">          2 :     c_tcopy(n_nonzeros,nnz_tmp,1,nnz,1);</span>
<span class="lineNum">     707 </span><span class="lineCov">          1 :     delete[] nnz_tmp;</span>
<span class="lineNum">     708 </span><span class="lineCov">          2 :     index_j = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     709 </span><span class="lineCov">          2 :     c_icopy(n_nonzeros,index_j_tmp,1,index_j,1);</span>
<span class="lineNum">     710 </span><span class="lineCov">          1 :     delete[] index_j_tmp;</span>
<span class="lineNum">     711 </span>            : 
<span class="lineNum">     712 </span><span class="lineCov">          1 :     get_row_edge();</span>
<span class="lineNum">     713 </span><span class="lineCov">          1 :     get_diag_pos();</span>
<span class="lineNum">     714 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">     715 </span>            : 
<span class="lineNum">     716 </span>            : /******************** written by SAB ********************/
<a name="717"><span class="lineNum">     717 </span>            : </a>
<span class="lineNum">     718 </span>            : template &lt;class T&gt;
<span class="lineNum">     719 </span><span class="lineNoCov">          0 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *matlocal,MPI_Comm my_comm)</span>
<span class="lineNum">     720 </span>            : {
<span class="lineNum">     721 </span>            :     int iam,nprocs;
<span class="lineNum">     722 </span><span class="lineNoCov">          0 :     MPI_Comm_size(my_comm,&amp;nprocs);</span>
<span class="lineNum">     723 </span><span class="lineNoCov">          0 :     MPI_Comm_rank(my_comm,&amp;iam);</span>
<span class="lineNum">     724 </span>            : 
<span class="lineNum">     725 </span><span class="lineNoCov">          0 :     MPI_Allreduce(&amp;matlocal-&gt;first_row,&amp;first_row,1,MPI_INT,MPI_MIN,my_comm);</span>
<span class="lineNum">     726 </span>            : 
<span class="lineNum">     727 </span><span class="lineNoCov">          0 :     int* dist_loc_n_nonzeros=new int[nprocs];</span>
<span class="lineNum">     728 </span><span class="lineNoCov">          0 :     MPI_Allgather(&amp;matlocal-&gt;n_nonzeros,1,MPI_INT,dist_loc_n_nonzeros,1,MPI_INT,my_comm);</span>
<span class="lineNum">     729 </span><span class="lineNoCov">          0 :     int* displc_n_nonzeros=new int[nprocs+1];</span>
<span class="lineNum">     730 </span><span class="lineNoCov">          0 :     displc_n_nonzeros[0]=0;</span>
<span class="lineNum">     731 </span><span class="lineNoCov">          0 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     732 </span><span class="lineNoCov">          0 :         displc_n_nonzeros[iii]=displc_n_nonzeros[iii-1]+dist_loc_n_nonzeros[iii-1];</span>
<span class="lineNum">     733 </span>            : 
<span class="lineNum">     734 </span><span class="lineNoCov">          0 :     int* dist_loc_size=new int[nprocs];</span>
<span class="lineNum">     735 </span><span class="lineNoCov">          0 :     MPI_Allgather(&amp;matlocal-&gt;size,1,MPI_INT,dist_loc_size,1,MPI_INT,my_comm);</span>
<span class="lineNum">     736 </span><span class="lineNoCov">          0 :     int* displc_size=new int[nprocs+1];</span>
<span class="lineNum">     737 </span><span class="lineNoCov">          0 :     displc_size[0]=0;</span>
<span class="lineNum">     738 </span><span class="lineNoCov">          0 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     739 </span><span class="lineNoCov">          0 :         displc_size[iii]=displc_size[iii-1]+dist_loc_size[iii-1];</span>
<span class="lineNum">     740 </span>            : 
<span class="lineNum">     741 </span><span class="lineNoCov">          0 :     n_nonzeros = displc_n_nonzeros[nprocs];</span>
<span class="lineNum">     742 </span><span class="lineNoCov">          0 :     size       = displc_size[nprocs];</span>
<span class="lineNum">     743 </span><span class="lineNoCov">          0 :     size_tot   = matlocal-&gt;size_tot;</span>
<span class="lineNum">     744 </span><span class="lineNoCov">          0 :     findx      = matlocal-&gt;findx;</span>
<span class="lineNum">     745 </span><span class="lineNoCov">          0 :     type       = matlocal-&gt;type;</span>
<span class="lineNum">     746 </span><span class="lineNoCov">          0 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     747 </span><span class="lineNoCov">          0 :     index_i    = new int[max(size,1)];</span>
<span class="lineNum">     748 </span><span class="lineNoCov">          0 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     749 </span><span class="lineNoCov">          0 :     edge_i     = new int[size+1];</span>
<span class="lineNum">     750 </span><span class="lineNoCov">          0 :     diag_pos   = new int[max(size,1)];</span>
<span class="lineNum">     751 </span>            : 
<span class="lineNum">     752 </span><span class="lineNoCov">          0 :     MPI_Allgatherv(matlocal-&gt;nnz,matlocal-&gt;n_nonzeros,give_me_MPI_datatype(nnz),nnz,dist_loc_n_nonzeros,displc_n_nonzeros,give_me_MPI_datatype(nnz),my_comm);</span>
<span class="lineNum">     753 </span><span class="lineNoCov">          0 :     MPI_Allgatherv(matlocal-&gt;index_j,matlocal-&gt;n_nonzeros,MPI_INT,index_j,dist_loc_n_nonzeros,displc_n_nonzeros,MPI_INT,my_comm);</span>
<span class="lineNum">     754 </span><span class="lineNoCov">          0 :     MPI_Allgatherv(matlocal-&gt;index_i,matlocal-&gt;size,MPI_INT,index_i,dist_loc_size,displc_size,MPI_INT,my_comm);</span>
<span class="lineNum">     755 </span>            : 
<span class="lineNum">     756 </span><span class="lineNoCov">          0 :     delete[] dist_loc_n_nonzeros;</span>
<span class="lineNum">     757 </span><span class="lineNoCov">          0 :     delete[] displc_n_nonzeros;</span>
<span class="lineNum">     758 </span><span class="lineNoCov">          0 :     delete[] dist_loc_size;</span>
<span class="lineNum">     759 </span><span class="lineNoCov">          0 :     delete[] displc_size;</span>
<span class="lineNum">     760 </span>            : 
<span class="lineNum">     761 </span><span class="lineNoCov">          0 :     get_row_edge();</span>
<span class="lineNum">     762 </span><span class="lineNoCov">          0 :     get_diag_pos();</span>
<span class="lineNum">     763 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">     764 </span>            : 
<span class="lineNum">     765 </span>            : /******************** written by SAB ********************/
<span class="lineNum">     766 </span>            : 
<span class="lineNum">     767 </span>            : template &lt;class T&gt;
<span class="lineNum">     768 </span><span class="lineCov">          5 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *matlocal,int rootint,MPI_Comm my_comm)</span>
<span class="lineNum">     769 </span>            : {
<span class="lineNum">     770 </span>            :     int iam,nprocs;
<span class="lineNum">     771 </span><span class="lineCov">          5 :     MPI_Comm_size(my_comm,&amp;nprocs);</span>
<span class="lineNum">     772 </span><span class="lineCov">          5 :     MPI_Comm_rank(my_comm,&amp;iam);</span>
<span class="lineNum">     773 </span>            : 
<span class="lineNum">     774 </span><span class="lineCov">          5 :     MPI_Allreduce(&amp;matlocal-&gt;first_row,&amp;first_row,1,MPI_INT,MPI_MIN,my_comm);</span>
<span class="lineNum">     775 </span>            : 
<span class="lineNum">     776 </span><span class="lineCov">          5 :     int* dist_loc_n_nonzeros=new int[nprocs];</span>
<span class="lineNum">     777 </span><span class="lineCov">          5 :     MPI_Allgather(&amp;matlocal-&gt;n_nonzeros,1,MPI_INT,dist_loc_n_nonzeros,1,MPI_INT,my_comm);</span>
<span class="lineNum">     778 </span><span class="lineCov">         10 :     int* displc_n_nonzeros=new int[nprocs+1]();</span>
<span class="lineNum">     779 </span><span class="lineCov">         15 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     780 </span><span class="lineCov">          5 :         displc_n_nonzeros[iii]=displc_n_nonzeros[iii-1]+dist_loc_n_nonzeros[iii-1];</span>
<span class="lineNum">     781 </span>            : 
<span class="lineNum">     782 </span><span class="lineCov">          5 :     int* dist_loc_size=new int[nprocs];</span>
<span class="lineNum">     783 </span><span class="lineCov">          5 :     MPI_Allgather(&amp;matlocal-&gt;size,1,MPI_INT,dist_loc_size,1,MPI_INT,my_comm);</span>
<span class="lineNum">     784 </span><span class="lineCov">         10 :     int* displc_size=new int[nprocs+1]();</span>
<span class="lineNum">     785 </span><span class="lineCov">         15 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     786 </span><span class="lineCov">          5 :         displc_size[iii]=displc_size[iii-1]+dist_loc_size[iii-1];</span>
<span class="lineNum">     787 </span>            : 
<span class="lineNum">     788 </span><span class="lineCov">          5 :     if (iam==rootint) {</span>
<span class="lineNum">     789 </span><span class="lineCov">          5 :         n_nonzeros = displc_n_nonzeros[nprocs];</span>
<span class="lineNum">     790 </span><span class="lineCov">          5 :         size       = displc_size[nprocs];</span>
<span class="lineNum">     791 </span>            :     } else {
<span class="lineNum">     792 </span><span class="lineNoCov">          0 :         n_nonzeros = 0;</span>
<span class="lineNum">     793 </span><span class="lineNoCov">          0 :         size       = 0;</span>
<span class="lineNum">     794 </span><span class="lineNoCov">          0 :         if (iam&gt;rootint) {</span>
<span class="lineNum">     795 </span><span class="lineNoCov">          0 :             first_row+=displc_size[nprocs];</span>
<span class="lineNum">     796 </span>            :         }
<span class="lineNum">     797 </span>            :     }
<span class="lineNum">     798 </span><span class="lineCov">          5 :     size_tot   = matlocal-&gt;size_tot;</span>
<span class="lineNum">     799 </span><span class="lineCov">          5 :     findx      = matlocal-&gt;findx;</span>
<span class="lineNum">     800 </span><span class="lineCov">          5 :     type       = matlocal-&gt;type;</span>
<span class="lineNum">     801 </span><span class="lineCov">      92724 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     802 </span><span class="lineCov">         10 :     index_i    = new int[max(size,1)];</span>
<span class="lineNum">     803 </span><span class="lineCov">         10 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     804 </span><span class="lineCov">         10 :     edge_i     = new int[size+1];</span>
<span class="lineNum">     805 </span><span class="lineCov">         10 :     diag_pos   = new int[max(size,1)];</span>
<span class="lineNum">     806 </span>            : 
<span class="lineNum">     807 </span><span class="lineCov">          5 :     MPI_Gatherv(matlocal-&gt;nnz,matlocal-&gt;n_nonzeros,give_me_MPI_datatype(nnz),nnz,dist_loc_n_nonzeros,displc_n_nonzeros,give_me_MPI_datatype(nnz),rootint,my_comm);</span>
<span class="lineNum">     808 </span><span class="lineCov">          5 :     MPI_Gatherv(matlocal-&gt;index_j,matlocal-&gt;n_nonzeros,MPI_INT,index_j,dist_loc_n_nonzeros,displc_n_nonzeros,MPI_INT,rootint,my_comm);</span>
<span class="lineNum">     809 </span><span class="lineCov">          5 :     MPI_Gatherv(matlocal-&gt;index_i,matlocal-&gt;size,MPI_INT,index_i,dist_loc_size,displc_size,MPI_INT,rootint,my_comm);</span>
<span class="lineNum">     810 </span>            : 
<span class="lineNum">     811 </span><span class="lineCov">         10 :     delete[] dist_loc_n_nonzeros;</span>
<span class="lineNum">     812 </span><span class="lineCov">          5 :     delete[] displc_n_nonzeros;</span>
<span class="lineNum">     813 </span><span class="lineCov">          5 :     delete[] dist_loc_size;</span>
<span class="lineNum">     814 </span><span class="lineCov">          5 :     delete[] displc_size;</span>
<span class="lineNum">     815 </span>            : 
<span class="lineNum">     816 </span><span class="lineCov">          5 :     get_row_edge();</span>
<span class="lineNum">     817 </span><span class="lineCov">          5 :     get_diag_pos();</span>
<span class="lineNum">     818 </span><span class="lineCov">          5 : }</span>
<span class="lineNum">     819 </span>            : 
<span class="lineNum">     820 </span>            : /******************** written by SAB ********************/
<a name="821"><span class="lineNum">     821 </span>            : </a>
<span class="lineNum">     822 </span>            : template &lt;class T&gt;
<span class="lineNum">     823 </span><span class="lineCov">         32 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *matlocal,int *rootvec,int rootnum,MPI_Comm my_comm)</span>
<span class="lineNum">     824 </span>            : {
<span class="lineNum">     825 </span>            :     int iam,nprocs;
<span class="lineNum">     826 </span><span class="lineCov">         32 :     MPI_Comm_size(my_comm,&amp;nprocs);</span>
<span class="lineNum">     827 </span><span class="lineCov">         32 :     MPI_Comm_rank(my_comm,&amp;iam);</span>
<span class="lineNum">     828 </span>            : 
<span class="lineNum">     829 </span><span class="lineCov">         32 :     MPI_Allreduce(&amp;matlocal-&gt;first_row,&amp;first_row,1,MPI_INT,MPI_MIN,my_comm);</span>
<span class="lineNum">     830 </span>            : 
<span class="lineNum">     831 </span><span class="lineCov">         32 :     int* dist_loc_n_nonzeros=new int[nprocs];</span>
<span class="lineNum">     832 </span><span class="lineCov">         32 :     MPI_Allgather(&amp;matlocal-&gt;n_nonzeros,1,MPI_INT,dist_loc_n_nonzeros,1,MPI_INT,my_comm);</span>
<span class="lineNum">     833 </span><span class="lineCov">         64 :     int* displc_n_nonzeros=new int[nprocs+1]();</span>
<span class="lineNum">     834 </span><span class="lineCov">        160 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     835 </span><span class="lineCov">         64 :         displc_n_nonzeros[iii]=displc_n_nonzeros[iii-1]+dist_loc_n_nonzeros[iii-1];</span>
<span class="lineNum">     836 </span>            : 
<span class="lineNum">     837 </span><span class="lineCov">         32 :     int* dist_loc_size=new int[nprocs];</span>
<span class="lineNum">     838 </span><span class="lineCov">         32 :     MPI_Allgather(&amp;matlocal-&gt;size,1,MPI_INT,dist_loc_size,1,MPI_INT,my_comm);</span>
<span class="lineNum">     839 </span><span class="lineCov">         64 :     int* displc_size=new int[nprocs+1]();</span>
<span class="lineNum">     840 </span><span class="lineCov">        160 :     for (int iii=1;iii&lt;nprocs+1;iii++)</span>
<span class="lineNum">     841 </span><span class="lineCov">         64 :         displc_size[iii]=displc_size[iii-1]+dist_loc_size[iii-1];</span>
<span class="lineNum">     842 </span>            : 
<span class="lineNum">     843 </span>            :     int is_root = 0;
<span class="lineNum">     844 </span><span class="lineCov">        160 :     for (int iroot=0;iroot&lt;rootnum;iroot++){</span>
<span class="lineNum">     845 </span><span class="lineCov">         64 :         if (iam==rootvec[iroot]){</span>
<span class="lineNum">     846 </span><span class="lineCov">         32 :             is_root += 1;</span>
<span class="lineNum">     847 </span>            :         }
<span class="lineNum">     848 </span>            :     }
<span class="lineNum">     849 </span><span class="lineCov">         32 :     if (is_root&gt;1) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">     850 </span><span class="lineCov">         32 :     if (is_root) {</span>
<span class="lineNum">     851 </span><span class="lineCov">         32 :         n_nonzeros = displc_n_nonzeros[nprocs];</span>
<span class="lineNum">     852 </span><span class="lineCov">         32 :         size       = displc_size[nprocs];</span>
<span class="lineNum">     853 </span><span class="lineCov">         32 :         size_tot   = matlocal-&gt;size_tot;</span>
<span class="lineNum">     854 </span>            :     } else {
<span class="lineNum">     855 </span><span class="lineNoCov">          0 :         first_row  = 0;</span>
<span class="lineNum">     856 </span><span class="lineNoCov">          0 :         n_nonzeros = 0;</span>
<span class="lineNum">     857 </span><span class="lineNoCov">          0 :         size       = 0;</span>
<span class="lineNum">     858 </span><span class="lineNoCov">          0 :         size_tot   = 0;</span>
<span class="lineNum">     859 </span>            :     }
<span class="lineNum">     860 </span><span class="lineCov">         32 :     findx      = matlocal-&gt;findx;</span>
<span class="lineNum">     861 </span><span class="lineCov">         32 :     type       = matlocal-&gt;type;</span>
<span class="lineNum">     862 </span><span class="lineCov">         64 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">     863 </span><span class="lineCov">         64 :     index_i    = new int[max(size,1)];</span>
<span class="lineNum">     864 </span><span class="lineCov">         64 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">     865 </span><span class="lineCov">         64 :     edge_i     = new int[size+1];</span>
<span class="lineNum">     866 </span><span class="lineCov">         64 :     diag_pos   = new int[max(size,1)];</span>
<span class="lineNum">     867 </span>            : 
<span class="lineNum">     868 </span><span class="lineCov">         32 :     MPI_Gatherv(matlocal-&gt;nnz,matlocal-&gt;n_nonzeros,give_me_MPI_datatype(nnz),nnz,dist_loc_n_nonzeros,displc_n_nonzeros,give_me_MPI_datatype(nnz),rootvec[0],my_comm);</span>
<span class="lineNum">     869 </span><span class="lineCov">         32 :     MPI_Gatherv(matlocal-&gt;index_j,matlocal-&gt;n_nonzeros,MPI_INT,index_j,dist_loc_n_nonzeros,displc_n_nonzeros,MPI_INT,rootvec[0],my_comm);</span>
<span class="lineNum">     870 </span><span class="lineCov">         32 :     MPI_Gatherv(matlocal-&gt;index_i,matlocal-&gt;size,MPI_INT,index_i,dist_loc_size,displc_size,MPI_INT,rootvec[0],my_comm);</span>
<span class="lineNum">     871 </span>            : 
<span class="lineNum">     872 </span>            : /*
<span class="lineNum">     873 </span>            : //Bcast segfaults on pilatus
<span class="lineNum">     874 </span>            :     MPI_Group my_group,sub_group;
<span class="lineNum">     875 </span>            :     MPI_Comm_group(my_comm,&amp;my_group);
<span class="lineNum">     876 </span>            :     MPI_Group_incl(my_group,rootnum,rootvec,&amp;sub_group);
<span class="lineNum">     877 </span>            :     MPI_Comm sub_comm;
<span class="lineNum">     878 </span>            :     MPI_Comm_create(my_comm,sub_group,&amp;sub_comm);
<span class="lineNum">     879 </span>            :     MPI_Group_free(&amp;my_group);
<span class="lineNum">     880 </span>            :     MPI_Group_free(&amp;sub_group);
<span class="lineNum">     881 </span>            :     MPI_Bcast(nnz,n_nonzeros,give_me_MPI_datatype(nnz),rootvec[0],sub_comm);
<span class="lineNum">     882 </span>            :     MPI_Bcast(index_j,n_nonzeros,MPI_INT,rootvec[0],sub_comm);
<span class="lineNum">     883 </span>            :     MPI_Bcast(index_i,size,MPI_INT,rootvec[0],sub_comm);
<span class="lineNum">     884 </span>            :     MPI_Comm_free(&amp;sub_comm);
<span class="lineNum">     885 </span>            : */
<span class="lineNum">     886 </span>            : 
<span class="lineNum">     887 </span>            : // /*
<span class="lineNum">     888 </span>            :     struct tags {
<span class="lineNum">     889 </span>            :         enum {
<span class="lineNum">     890 </span>            :             nnz,
<span class="lineNum">     891 </span>            :             index_j,
<span class="lineNum">     892 </span>            :             index_i
<span class="lineNum">     893 </span>            :         };
<span class="lineNum">     894 </span>            :     };
<span class="lineNum">     895 </span>            : 
<span class="lineNum">     896 </span>            :     MPI_Status status;
<span class="lineNum">     897 </span><span class="lineCov">         32 :     if (iam==rootvec[0]){</span>
<span class="lineNum">     898 </span><span class="lineCov">         48 :         for (int iroot=1;iroot&lt;rootnum;iroot++){</span>
<span class="lineNum">     899 </span><span class="lineCov">         16 :             MPI_Send(nnz,n_nonzeros,give_me_MPI_datatype(nnz),rootvec[iroot],tags::nnz,my_comm);</span>
<span class="lineNum">     900 </span><span class="lineCov">         16 :             MPI_Send(index_j,n_nonzeros,MPI_INT,rootvec[iroot],tags::index_j,my_comm);</span>
<span class="lineNum">     901 </span><span class="lineCov">         16 :             MPI_Send(index_i,size,MPI_INT,rootvec[iroot],tags::index_i,my_comm);</span>
<span class="lineNum">     902 </span>            :         }
<span class="lineNum">     903 </span>            :     }else{
<span class="lineNum">     904 </span><span class="lineCov">         48 :         for (int iroot=1;iroot&lt;rootnum;iroot++){</span>
<span class="lineNum">     905 </span><span class="lineCov">         16 :             if (iam==rootvec[iroot]){</span>
<span class="lineNum">     906 </span><span class="lineCov">         16 :                 MPI_Recv(nnz,n_nonzeros,give_me_MPI_datatype(nnz),rootvec[0],tags::nnz,my_comm,&amp;status);</span>
<span class="lineNum">     907 </span><span class="lineCov">         16 :                 MPI_Recv(index_j,n_nonzeros,MPI_INT,rootvec[0],tags::index_j,my_comm,&amp;status);</span>
<span class="lineNum">     908 </span><span class="lineCov">         16 :                 MPI_Recv(index_i,size,MPI_INT,rootvec[0],tags::index_i,my_comm,&amp;status);</span>
<span class="lineNum">     909 </span>            :             }
<span class="lineNum">     910 </span>            :         }
<span class="lineNum">     911 </span>            :     }
<span class="lineNum">     912 </span>            : // */
<span class="lineNum">     913 </span>            : 
<span class="lineNum">     914 </span><span class="lineCov">         32 :     delete[] dist_loc_n_nonzeros;</span>
<span class="lineNum">     915 </span><span class="lineCov">         32 :     delete[] displc_n_nonzeros;</span>
<span class="lineNum">     916 </span><span class="lineCov">         32 :     delete[] dist_loc_size;</span>
<span class="lineNum">     917 </span><span class="lineCov">         32 :     delete[] displc_size;</span>
<span class="lineNum">     918 </span>            : 
<span class="lineNum">     919 </span><span class="lineCov">         32 :     get_row_edge();</span>
<span class="lineNum">     920 </span><span class="lineCov">         32 :     get_diag_pos();</span>
<span class="lineNum">     921 </span><span class="lineCov">         32 : }</span>
<span class="lineNum">     922 </span>            : 
<span class="lineNum">     923 </span>            : /******************** written by SAB ********************/
<span class="lineNum">     924 </span>            : 
<span class="lineNum">     925 </span>            : template &lt;class T&gt;
<span class="lineNum">     926 </span>            : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *matlocal,MPI_Comm my_comm_in,int size_my_comm_out,MPI_Comm *my_comm_out,MPI_Comm *equal_rank_comm)
<span class="lineNum">     927 </span>            : {
<span class="lineNum">     928 </span>            :     struct tags {
<span class="lineNum">     929 </span>            :         enum {
<span class="lineNum">     930 </span>            :             first_row,
<span class="lineNum">     931 </span>            :             nnz,
<span class="lineNum">     932 </span>            :             index_j,
<span class="lineNum">     933 </span>            :             index_i
<span class="lineNum">     934 </span>            :         };
<span class="lineNum">     935 </span>            :     };
<span class="lineNum">     936 </span>            : 
<span class="lineNum">     937 </span>            :     int iam,nprocs;
<span class="lineNum">     938 </span>            :     MPI_Comm_size(my_comm_in,&amp;nprocs);
<span class="lineNum">     939 </span>            :     MPI_Comm_rank(my_comm_in,&amp;iam);
<span class="lineNum">     940 </span>            :     if (nprocs % size_my_comm_out) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">     941 </span>            :     int nmat = nprocs / size_my_comm_out;
<span class="lineNum">     942 </span>            :     int color = iam / size_my_comm_out;
<span class="lineNum">     943 </span>            :     MPI_Comm_split(my_comm_in,color,iam,my_comm_out);
<span class="lineNum">     944 </span>            :     int rank_my_comm_out;
<span class="lineNum">     945 </span>            :     MPI_Comm_rank(*my_comm_out,&amp;rank_my_comm_out);
<span class="lineNum">     946 </span>            :     MPI_Comm_split(my_comm_in,rank_my_comm_out,iam,equal_rank_comm);
<span class="lineNum">     947 </span>            : 
<span class="lineNum">     948 </span>            :     int loc_n_nonzeros=matlocal-&gt;n_nonzeros;
<span class="lineNum">     949 </span>            :     int* dist_loc_n_nonzeros=new int[nprocs];
<span class="lineNum">     950 </span>            :     MPI_Allgather(&amp;loc_n_nonzeros,1,MPI_INT,dist_loc_n_nonzeros,1,MPI_INT,my_comm_in);
<span class="lineNum">     951 </span>            :     int* displc_n_nonzeros=new int[nmat+1]();
<span class="lineNum">     952 </span>            :     for (int irecv=0;irecv&lt;nmat;irecv++) {
<span class="lineNum">     953 </span>            :         int from_node = (irecv+iam*nmat)%nprocs;
<span class="lineNum">     954 </span>            :         displc_n_nonzeros[irecv+1]=displc_n_nonzeros[irecv]+dist_loc_n_nonzeros[from_node];
<span class="lineNum">     955 </span>            :     }
<span class="lineNum">     956 </span>            : 
<span class="lineNum">     957 </span>            :     int loc_size=matlocal-&gt;size;
<span class="lineNum">     958 </span>            :     int* dist_loc_size=new int[nprocs];
<span class="lineNum">     959 </span>            :     MPI_Allgather(&amp;loc_size,1,MPI_INT,dist_loc_size,1,MPI_INT,my_comm_in);
<span class="lineNum">     960 </span>            :     int* displc_size=new int[nmat+1]();
<span class="lineNum">     961 </span>            :     for (int irecv=0;irecv&lt;nmat;irecv++) {
<span class="lineNum">     962 </span>            :         int from_node = (irecv+iam*nmat)%nprocs;
<span class="lineNum">     963 </span>            :         displc_size[irecv+1]=displc_size[irecv]+dist_loc_size[from_node];
<span class="lineNum">     964 </span>            :     }
<span class="lineNum">     965 </span>            : 
<span class="lineNum">     966 </span>            :     MPI_Request reqs;
<span class="lineNum">     967 </span>            :     MPI_Status status;
<span class="lineNum">     968 </span>            :     MPI_Irecv(&amp;first_row,1,MPI_INT,(iam*nmat)%(nmat*size_my_comm_out),tags::first_row,my_comm_in,&amp;reqs);
<span class="lineNum">     969 </span>            :     if (!(iam%nmat))
<span class="lineNum">     970 </span>            :         for (int isend=0;isend&lt;nmat;isend++)
<span class="lineNum">     971 </span>            :             MPI_Send(&amp;matlocal-&gt;first_row,1,MPI_INT,iam/nmat+isend*size_my_comm_out,tags::first_row,my_comm_in);
<span class="lineNum">     972 </span>            :     MPI_Wait(&amp;reqs,&amp;status);
<span class="lineNum">     973 </span>            : 
<span class="lineNum">     974 </span>            :     n_nonzeros = displc_n_nonzeros[nmat];
<span class="lineNum">     975 </span>            :     size_tot   = matlocal-&gt;size_tot;
<span class="lineNum">     976 </span>            :     size       = displc_size[nmat];
<span class="lineNum">     977 </span>            :     findx      = matlocal-&gt;findx;
<span class="lineNum">     978 </span>            :     type       = 0;
<span class="lineNum">     979 </span>            :     nnz        = new T[max(n_nonzeros,1)];
<span class="lineNum">     980 </span>            :     index_i    = new int[max(size,1)];
<span class="lineNum">     981 </span>            :     index_j    = new int[max(n_nonzeros,1)];
<span class="lineNum">     982 </span>            :     edge_i     = new int[size+1];
<span class="lineNum">     983 </span>            :     diag_pos   = new int[max(size,1)];
<span class="lineNum">     984 </span>            : 
<span class="lineNum">     985 </span>            :     MPI_Status* nnz_status=new MPI_Status[nmat];
<span class="lineNum">     986 </span>            :     MPI_Status* ind_j_status=new MPI_Status[nmat];
<span class="lineNum">     987 </span>            :     MPI_Status* ind_i_status=new MPI_Status[nmat];
<span class="lineNum">     988 </span>            :     MPI_Request* nnz_reqs=new MPI_Request[nmat];
<span class="lineNum">     989 </span>            :     MPI_Request* ind_j_reqs=new MPI_Request[nmat];
<span class="lineNum">     990 </span>            :     MPI_Request* ind_i_reqs=new MPI_Request[nmat];
<span class="lineNum">     991 </span>            : 
<span class="lineNum">     992 </span>            :     for (int irecv=0;irecv&lt;nmat;irecv++) {
<span class="lineNum">     993 </span>            :         int from_node = (irecv+iam*nmat)%nprocs;
<span class="lineNum">     994 </span>            :         MPI_Irecv(&amp;nnz[displc_n_nonzeros[irecv]],dist_loc_n_nonzeros[from_node],give_me_MPI_datatype(nnz),from_node,tags::nnz,my_comm_in,&amp;nnz_reqs[irecv]);
<span class="lineNum">     995 </span>            :         MPI_Irecv(&amp;index_j[displc_n_nonzeros[irecv]],dist_loc_n_nonzeros[from_node],MPI_INT,from_node,tags::index_j,my_comm_in,&amp;ind_j_reqs[irecv]);
<span class="lineNum">     996 </span>            :         MPI_Irecv(&amp;index_i[displc_size[irecv]],dist_loc_size[from_node],MPI_INT,from_node,tags::index_i,my_comm_in,&amp;ind_i_reqs[irecv]);
<span class="lineNum">     997 </span>            :     }
<span class="lineNum">     998 </span>            : 
<span class="lineNum">     999 </span>            :     for (int isend=0;isend&lt;nmat;isend++) {
<span class="lineNum">    1000 </span>            :         int to_node = iam/nmat+isend*size_my_comm_out;
<span class="lineNum">    1001 </span>            :         MPI_Send(matlocal-&gt;nnz,matlocal-&gt;n_nonzeros,give_me_MPI_datatype(nnz),to_node,tags::nnz,my_comm_in);
<span class="lineNum">    1002 </span>            :         MPI_Send(matlocal-&gt;index_j,matlocal-&gt;n_nonzeros,MPI_INT,to_node,tags::index_j,my_comm_in);
<span class="lineNum">    1003 </span>            :         MPI_Send(matlocal-&gt;index_i,matlocal-&gt;size,MPI_INT,to_node,tags::index_i,my_comm_in);
<span class="lineNum">    1004 </span>            :     }
<span class="lineNum">    1005 </span>            : 
<span class="lineNum">    1006 </span>            :     MPI_Waitall(nmat,nnz_reqs,nnz_status);
<span class="lineNum">    1007 </span>            :     MPI_Waitall(nmat,ind_j_reqs,ind_j_status);
<span class="lineNum">    1008 </span>            :     MPI_Waitall(nmat,ind_i_reqs,ind_i_status);
<span class="lineNum">    1009 </span>            : 
<span class="lineNum">    1010 </span>            :     delete[] nnz_status;
<span class="lineNum">    1011 </span>            :     delete[] ind_j_status;
<span class="lineNum">    1012 </span>            :     delete[] ind_i_status;
<span class="lineNum">    1013 </span>            :     delete[] nnz_reqs;
<span class="lineNum">    1014 </span>            :     delete[] ind_j_reqs;
<span class="lineNum">    1015 </span>            :     delete[] ind_i_reqs;
<span class="lineNum">    1016 </span>            : 
<span class="lineNum">    1017 </span>            :     delete[] dist_loc_n_nonzeros;
<span class="lineNum">    1018 </span>            :     delete[] displc_n_nonzeros;
<span class="lineNum">    1019 </span>            :     delete[] dist_loc_size;
<span class="lineNum">    1020 </span>            :     delete[] displc_size;
<span class="lineNum">    1021 </span>            : 
<span class="lineNum">    1022 </span>            :     get_row_edge();
<span class="lineNum">    1023 </span>            :     get_diag_pos();
<span class="lineNum">    1024 </span>            : }
<span class="lineNum">    1025 </span>            : 
<span class="lineNum">    1026 </span>            : /******************** written by SAB ********************/
<span class="lineNum">    1027 </span>            : 
<span class="lineNum">    1028 </span>            : template &lt;class T&gt;
<span class="lineNum">    1029 </span>            : inline TCSR&lt;T&gt;::TCSR(MPI_Comm comm,TCSR&lt;T&gt; *mat)
<span class="lineNum">    1030 </span>            : {
<span class="lineNum">    1031 </span>            :     int rank;
<span class="lineNum">    1032 </span>            :     MPI_Comm_rank(comm,&amp;rank);
<span class="lineNum">    1033 </span>            : 
<span class="lineNum">    1034 </span>            :     if (!rank) {
<span class="lineNum">    1035 </span>            :         size       = mat-&gt;size;
<span class="lineNum">    1036 </span>            :         size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1037 </span>            :         type       = mat-&gt;type;
<span class="lineNum">    1038 </span>            :         n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1039 </span>            :         findx      = mat-&gt;findx;
<span class="lineNum">    1040 </span>            :         first_row  = mat-&gt;first_row;
<span class="lineNum">    1041 </span>            :     }
<span class="lineNum">    1042 </span>            : 
<span class="lineNum">    1043 </span>            :     MPI_Bcast(&amp;size      ,1,MPI_INT,0,comm);
<span class="lineNum">    1044 </span>            :     MPI_Bcast(&amp;size_tot  ,1,MPI_INT,0,comm);
<span class="lineNum">    1045 </span>            :     MPI_Bcast(&amp;type      ,1,MPI_INT,0,comm);
<span class="lineNum">    1046 </span>            :     MPI_Bcast(&amp;n_nonzeros,1,MPI_INT,0,comm);
<span class="lineNum">    1047 </span>            :     MPI_Bcast(&amp;findx     ,1,MPI_INT,0,comm);
<span class="lineNum">    1048 </span>            :     MPI_Bcast(&amp;first_row ,1,MPI_INT,0,comm);
<span class="lineNum">    1049 </span>            : 
<span class="lineNum">    1050 </span>            :     nnz      = new T[n_nonzeros];
<span class="lineNum">    1051 </span>            :     index_i  = new int[size];
<span class="lineNum">    1052 </span>            :     index_j  = new int[n_nonzeros];
<span class="lineNum">    1053 </span>            :     edge_i   = new int[size+1];
<span class="lineNum">    1054 </span>            :     diag_pos = new int[size];
<span class="lineNum">    1055 </span>            : 
<span class="lineNum">    1056 </span>            :     if (!rank) {
<span class="lineNum">    1057 </span>            :         c_tcopy(n_nonzeros,mat-&gt;nnz,1,nnz,1);
<span class="lineNum">    1058 </span>            :         c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1059 </span>            :         c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1060 </span>            :         c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1061 </span>            :         c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1062 </span>            :     }
<span class="lineNum">    1063 </span>            : 
<span class="lineNum">    1064 </span>            :     MPI_Bcast(nnz,n_nonzeros    ,give_me_MPI_datatype(nnz),0,comm);
<span class="lineNum">    1065 </span>            :     MPI_Bcast(index_i,size      ,MPI_INT                  ,0,comm);
<span class="lineNum">    1066 </span>            :     MPI_Bcast(index_j,n_nonzeros,MPI_INT                  ,0,comm);
<span class="lineNum">    1067 </span>            :     MPI_Bcast(edge_i,size+1     ,MPI_INT                  ,0,comm);
<span class="lineNum">    1068 </span>            :     MPI_Bcast(diag_pos,size     ,MPI_INT                  ,0,comm);
<span class="lineNum">    1069 </span>            : }
<span class="lineNum">    1070 </span>            : 
<span class="lineNum">    1071 </span>            : /******************** written by SAB ********************/
<span class="lineNum">    1072 </span>            : 
<span class="lineNum">    1073 </span>            : template &lt;class T&gt;
<span class="lineNum">    1074 </span><span class="lineCov">          4 : inline TCSR&lt;T&gt;::TCSR(TCSR&lt;T&gt; *mat,TCSR&lt;T&gt; *dep_mat,int rootrank,MPI_Comm matrix_comm)</span>
<span class="lineNum">    1075 </span>            : {
<span class="lineNum">    1076 </span>            :     int iam,nprocs;
<span class="lineNum">    1077 </span><span class="lineCov">          4 :     MPI_Comm_size(matrix_comm,&amp;nprocs);</span>
<span class="lineNum">    1078 </span><span class="lineCov">          4 :     MPI_Comm_rank(matrix_comm,&amp;iam);</span>
<span class="lineNum">    1079 </span>            : 
<span class="lineNum">    1080 </span><span class="lineCov">          4 :     size_tot   = mat-&gt;size_tot;</span>
<span class="lineNum">    1081 </span><span class="lineCov">          4 :     type       = mat-&gt;type;</span>
<span class="lineNum">    1082 </span><span class="lineCov">          4 :     findx      = mat-&gt;findx;</span>
<span class="lineNum">    1083 </span>            : 
<span class="lineNum">    1084 </span><span class="lineCov">          4 :     if (iam==rootrank) {</span>
<span class="lineNum">    1085 </span><span class="lineCov">          4 :         if (size_tot != dep_mat-&gt;size_tot ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    1086 </span><span class="lineCov">          4 :         if (type     != dep_mat-&gt;type     ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    1087 </span><span class="lineCov">          4 :         if (findx    != dep_mat-&gt;findx    ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    1088 </span>            :     }
<span class="lineNum">    1089 </span>            : 
<span class="lineNum">    1090 </span><span class="lineCov">          4 :     size       = mat-&gt;size;</span>
<span class="lineNum">    1091 </span><span class="lineCov">          4 :     first_row  = mat-&gt;first_row;</span>
<span class="lineNum">    1092 </span>            :     
<span class="lineNum">    1093 </span><span class="lineCov">          4 :     int *first_rows = new int[nprocs+1];</span>
<span class="lineNum">    1094 </span><span class="lineCov">          4 :     MPI_Allgather(&amp;first_row,1,MPI_INT,first_rows,1,MPI_INT,matrix_comm);</span>
<span class="lineNum">    1095 </span><span class="lineCov">          4 :     first_rows[nprocs]=size_tot;</span>
<span class="lineNum">    1096 </span><span class="lineCov">          8 :     int *sizes = new int[nprocs];</span>
<span class="lineNum">    1097 </span><span class="lineCov">         12 :     for (int irank=0;irank&lt;nprocs;irank++) {</span>
<span class="lineNum">    1098 </span><span class="lineCov">          4 :         sizes[irank]=first_rows[irank+1]-first_rows[irank];</span>
<span class="lineNum">    1099 </span>            :     }
<span class="lineNum">    1100 </span><span class="lineCov">          4 :     if (size!=sizes[iam]) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    1101 </span>            : 
<span class="lineNum">    1102 </span><span class="lineCov">          4 :     int *n_nonzeros_array = new int[nprocs];</span>
<span class="lineNum">    1103 </span><span class="lineCov">          4 :     if (iam==rootrank) {</span>
<span class="lineNum">    1104 </span><span class="lineCov">         12 :         for (int irank=0;irank&lt;nprocs;irank++) {</span>
<span class="lineNum">    1105 </span><span class="lineCov">          4 :             n_nonzeros_array[irank]=dep_mat-&gt;edge_i[first_rows[irank+1]]-dep_mat-&gt;edge_i[first_rows[irank]];</span>
<span class="lineNum">    1106 </span>            :         }
<span class="lineNum">    1107 </span>            :     }
<span class="lineNum">    1108 </span><span class="lineCov">          4 :     MPI_Bcast(n_nonzeros_array,nprocs,MPI_INT,rootrank,matrix_comm);</span>
<span class="lineNum">    1109 </span><span class="lineCov">          4 :     int *n_nonzeros_disp = new int[nprocs+1];</span>
<span class="lineNum">    1110 </span><span class="lineCov">          4 :     n_nonzeros_disp[0]=0;</span>
<span class="lineNum">    1111 </span><span class="lineCov">         16 :     for (int irank=0;irank&lt;nprocs;irank++) {</span>
<span class="lineNum">    1112 </span><span class="lineCov">          4 :         n_nonzeros_disp[irank+1]=n_nonzeros_disp[irank]+n_nonzeros_array[irank];</span>
<span class="lineNum">    1113 </span>            :     }
<span class="lineNum">    1114 </span><span class="lineCov">          4 :     n_nonzeros=n_nonzeros_array[iam];</span>
<span class="lineNum">    1115 </span>            : 
<span class="lineNum">    1116 </span><span class="lineCov">      40230 :     nnz        = new T[max(n_nonzeros,1)];</span>
<span class="lineNum">    1117 </span><span class="lineCov">          4 :     index_i    = new int[size];</span>
<span class="lineNum">    1118 </span><span class="lineCov">          8 :     index_j    = new int[max(n_nonzeros,1)];</span>
<span class="lineNum">    1119 </span><span class="lineCov">          8 :     edge_i     = new int[size+1];</span>
<span class="lineNum">    1120 </span><span class="lineCov">          8 :     diag_pos   = new int[size];</span>
<span class="lineNum">    1121 </span>            : 
<span class="lineNum">    1122 </span><span class="lineCov">          8 :     init_variable(index_i,size);</span>
<span class="lineNum">    1123 </span><span class="lineCov">          4 :     if (!n_nonzeros) {</span>
<span class="lineNum">    1124 </span><span class="lineNoCov">          0 :         init_variable(nnz,1);</span>
<span class="lineNum">    1125 </span><span class="lineNoCov">          0 :         init_variable(index_j,1);</span>
<span class="lineNum">    1126 </span>            :     }
<span class="lineNum">    1127 </span>            : 
<span class="lineNum">    1128 </span><span class="lineCov">          4 :     T *nnz_ptr = NULL;</span>
<span class="lineNum">    1129 </span><span class="lineCov">          4 :     int *indj_ptr = NULL;</span>
<span class="lineNum">    1130 </span><span class="lineCov">          4 :     int *indi_ptr = NULL;</span>
<span class="lineNum">    1131 </span><span class="lineCov">          4 :     if (iam==rootrank) {</span>
<span class="lineNum">    1132 </span><span class="lineCov">          4 :         nnz_ptr=dep_mat-&gt;nnz;</span>
<span class="lineNum">    1133 </span><span class="lineCov">          4 :         indj_ptr=dep_mat-&gt;index_j;</span>
<span class="lineNum">    1134 </span><span class="lineCov">          4 :         indi_ptr=dep_mat-&gt;index_i;</span>
<span class="lineNum">    1135 </span>            :     }
<span class="lineNum">    1136 </span>            : 
<span class="lineNum">    1137 </span><span class="lineCov">          4 :     MPI_Scatterv(nnz_ptr,n_nonzeros_array,n_nonzeros_disp,give_me_MPI_datatype(nnz),nnz,n_nonzeros,give_me_MPI_datatype(nnz),rootrank,matrix_comm);</span>
<span class="lineNum">    1138 </span><span class="lineCov">          4 :     MPI_Scatterv(indj_ptr,n_nonzeros_array,n_nonzeros_disp,MPI_INT,index_j,n_nonzeros,MPI_INT,rootrank,matrix_comm);</span>
<span class="lineNum">    1139 </span><span class="lineCov">          4 :     MPI_Scatterv(indi_ptr,sizes,first_rows,MPI_INT,index_i,size,MPI_INT,rootrank,matrix_comm);</span>
<span class="lineNum">    1140 </span>            : 
<span class="lineNum">    1141 </span><span class="lineCov">          4 :     delete[] first_rows;</span>
<span class="lineNum">    1142 </span><span class="lineCov">          4 :     delete[] sizes;</span>
<span class="lineNum">    1143 </span><span class="lineCov">          4 :     delete[] n_nonzeros_array;</span>
<span class="lineNum">    1144 </span><span class="lineCov">          4 :     delete[] n_nonzeros_disp;</span>
<span class="lineNum">    1145 </span>            : 
<span class="lineNum">    1146 </span><span class="lineCov">          4 :     get_row_edge();</span>
<span class="lineNum">    1147 </span><span class="lineCov">          4 :     get_diag_pos();</span>
<span class="lineNum">    1148 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    1149 </span>            : 
<span class="lineNum">    1150 </span>            : /************************************************************************************************/
<span class="lineNum">    1151 </span>            : 
<span class="lineNum">    1152 </span>            : template &lt;&gt;
<span class="lineNum">    1153 </span>            : inline TCSR&lt;CPX&gt;::TCSR(const char *filename)
<span class="lineNum">    1154 </span>            : {
<span class="lineNum">    1155 </span>            : 
<span class="lineNum">    1156 </span>            :     int i, ind_i;
<span class="lineNum">    1157 </span>            :     FILE *F = fopen(filename, &quot;r&quot;);
<span class="lineNum">    1158 </span>            :     double real_i, imag_i;
<span class="lineNum">    1159 </span>            : 
<span class="lineNum">    1160 </span>            :     fscanf(F,&quot;%i&quot;,&amp;size);
<span class="lineNum">    1161 </span>            :     fscanf(F,&quot;%i&quot;,&amp;n_nonzeros);
<span class="lineNum">    1162 </span>            :     fscanf(F,&quot;%i&quot;,&amp;findx);
<span class="lineNum">    1163 </span>            : 
<span class="lineNum">    1164 </span>            :     nnz        = new CPX[n_nonzeros];
<span class="lineNum">    1165 </span>            :     index_i    = new int[size];
<span class="lineNum">    1166 </span>            :     index_j    = new int[n_nonzeros];
<span class="lineNum">    1167 </span>            :     edge_i     = new int[size+1];
<span class="lineNum">    1168 </span>            :     diag_pos   = new int[size];
<span class="lineNum">    1169 </span>            : 
<span class="lineNum">    1170 </span>            :     size_tot   = size;
<span class="lineNum">    1171 </span>            :     type       = 0;
<span class="lineNum">    1172 </span>            :     first_row  = 0;
<span class="lineNum">    1173 </span>            : 
<span class="lineNum">    1174 </span>            :     for(i=0;i&lt;size;i++) index_i[i] = 0;
<span class="lineNum">    1175 </span>            : 
<span class="lineNum">    1176 </span>            :     for(i=0;i&lt;n_nonzeros;i++){
<span class="lineNum">    1177 </span>            :         fscanf(F,&quot;%i&quot;,&amp;ind_i);
<span class="lineNum">    1178 </span>            :         fscanf(F,&quot;%i&quot;,index_j+i);
<span class="lineNum">    1179 </span>            :         fscanf(F,&quot;%lg&quot;,&amp;real_i);
<span class="lineNum">    1180 </span>            :         fscanf(F,&quot;%lg&quot;,&amp;imag_i);
<span class="lineNum">    1181 </span>            :         nnz[i] = CPX(real_i,imag_i);
<span class="lineNum">    1182 </span>            : 
<span class="lineNum">    1183 </span>            :         if(ind_i==index_j[i]){
<span class="lineNum">    1184 </span>            :             diag_pos[ind_i-findx] = i;
<span class="lineNum">    1185 </span>            :         }
<span class="lineNum">    1186 </span>            :         index_i[ind_i-findx]++;
<span class="lineNum">    1187 </span>            :     }
<span class="lineNum">    1188 </span>            :     get_row_edge();
<span class="lineNum">    1189 </span>            :     fclose(F);
<span class="lineNum">    1190 </span>            : }
<span class="lineNum">    1191 </span>            : 
<span class="lineNum">    1192 </span>            : /***********************************************************************************************/
<span class="lineNum">    1193 </span>            : 
<span class="lineNum">    1194 </span>            : template &lt;&gt;
<span class="lineNum">    1195 </span>            : inline TCSR&lt;double&gt;::TCSR(const char *filename)
<span class="lineNum">    1196 </span>            : {
<span class="lineNum">    1197 </span>            : 
<span class="lineNum">    1198 </span>            :     int i,ind_i;
<span class="lineNum">    1199 </span>            :     FILE *F = fopen(filename,&quot;r&quot;);
<span class="lineNum">    1200 </span>            :    
<span class="lineNum">    1201 </span>            :     fscanf(F,&quot;%i&quot;,&amp;size);
<span class="lineNum">    1202 </span>            :     fscanf(F,&quot;%i&quot;,&amp;n_nonzeros);
<span class="lineNum">    1203 </span>            :     fscanf(F,&quot;%i&quot;,&amp;findx);
<span class="lineNum">    1204 </span>            :     
<span class="lineNum">    1205 </span>            :     nnz        = new double[n_nonzeros];
<span class="lineNum">    1206 </span>            :     index_i    = new int[size];                                           
<span class="lineNum">    1207 </span>            :     index_j    = new int[n_nonzeros];                                       
<span class="lineNum">    1208 </span>            :     edge_i     = new int[size+1];                                         
<span class="lineNum">    1209 </span>            :     diag_pos   = new int[size];                                           
<span class="lineNum">    1210 </span>            : 
<span class="lineNum">    1211 </span>            :     size_tot   = size;                                                    
<span class="lineNum">    1212 </span>            :     type       = 0;                                        
<span class="lineNum">    1213 </span>            :     first_row  = 0;                                                    
<span class="lineNum">    1214 </span>            : 
<span class="lineNum">    1215 </span>            :     for(i=0;i&lt;size;i++) index_i[i] = 0;
<span class="lineNum">    1216 </span>            :    
<span class="lineNum">    1217 </span>            :     for(i=0;i&lt;n_nonzeros;i++){
<span class="lineNum">    1218 </span>            :         fscanf(F,&quot;%i&quot;,&amp;ind_i);
<span class="lineNum">    1219 </span>            :               fscanf(F,&quot;%i&quot;,index_j+i);
<span class="lineNum">    1220 </span>            :               fscanf(F,&quot;%lg&quot;,nnz+i);
<span class="lineNum">    1221 </span>            :               if(ind_i==index_j[i]){
<span class="lineNum">    1222 </span>            :                   diag_pos[ind_i-findx] = i;
<span class="lineNum">    1223 </span>            :               }
<span class="lineNum">    1224 </span>            :               index_i[ind_i-findx]++;
<span class="lineNum">    1225 </span>            :     }
<span class="lineNum">    1226 </span>            :     get_row_edge();
<span class="lineNum">    1227 </span>            :     fclose(F);
<span class="lineNum">    1228 </span>            : 
<span class="lineNum">    1229 </span>            : }
<span class="lineNum">    1230 </span>            : 
<span class="lineNum">    1231 </span>            : /***********************************************************************************************/
<span class="lineNum">    1232 </span>            : 
<span class="lineNum">    1233 </span>            : template &lt;&gt;
<span class="lineNum">    1234 </span>            : inline TCSR&lt;CPX&gt;::TCSR(char *filename,int mrank,int msize)
<span class="lineNum">    1235 </span>            : {
<span class="lineNum">    1236 </span>            : }
<span class="lineNum">    1237 </span>            : 
<span class="lineNum">    1238 </span>            : /***********************************************************************************************/
<span class="lineNum">    1239 </span>            : 
<span class="lineNum">    1240 </span>            : template &lt;&gt;
<span class="lineNum">    1241 </span>            : inline TCSR&lt;double&gt;::TCSR(char *filename,int msize,int mrank)
<span class="lineNum">    1242 </span>            : {
<span class="lineNum">    1243 </span>            : 
<span class="lineNum">    1244 </span>            :     int i,i0,ind_i,var_i,n_tot;
<span class="lineNum">    1245 </span>            :     double var_d;
<span class="lineNum">    1246 </span>            :     FILE *F = fopen(filename,&quot;r&quot;);
<span class="lineNum">    1247 </span>            : 
<span class="lineNum">    1248 </span>            :     fscanf(F,&quot;%i&quot;,&amp;size_tot);
<span class="lineNum">    1249 </span>            :     fscanf(F,&quot;%i&quot;,&amp;n_tot);
<span class="lineNum">    1250 </span>            :     fscanf(F,&quot;%i&quot;,&amp;findx);
<span class="lineNum">    1251 </span>            : 
<span class="lineNum">    1252 </span>            :     cpu_distribute(&amp;first_row,&amp;size,size_tot,msize,mrank);
<span class="lineNum">    1253 </span>            : 
<span class="lineNum">    1254 </span>            :     n_nonzeros = 0;
<span class="lineNum">    1255 </span>            :     for(i=0;i&lt;n_tot;i++){
<span class="lineNum">    1256 </span>            :         fscanf(F,&quot;%i&quot;,&amp;ind_i);
<span class="lineNum">    1257 </span>            :         fscanf(F,&quot;%i&quot;,&amp;var_i);
<span class="lineNum">    1258 </span>            :         fscanf(F,&quot;%lg&quot;,&amp;var_d);
<span class="lineNum">    1259 </span>            :         if(((ind_i-findx)&gt;=first_row)&amp;&amp;((ind_i-findx)&lt;first_row+size)){
<span class="lineNum">    1260 </span>            :             n_nonzeros++;
<span class="lineNum">    1261 </span>            :         }
<span class="lineNum">    1262 </span>            :     }
<span class="lineNum">    1263 </span>            :     fclose(F);
<span class="lineNum">    1264 </span>            :     
<span class="lineNum">    1265 </span>            :     nnz        = new double[n_nonzeros];
<span class="lineNum">    1266 </span>            :     index_i    = new int[size];                                           
<span class="lineNum">    1267 </span>            :     index_j    = new int[n_nonzeros];                                       
<span class="lineNum">    1268 </span>            :     edge_i     = new int[size+1];                                         
<span class="lineNum">    1269 </span>            :     diag_pos   = new int[size];                                           
<span class="lineNum">    1270 </span>            :     
<span class="lineNum">    1271 </span>            :     type       = 0;                                                                                         
<span class="lineNum">    1272 </span>            : 
<span class="lineNum">    1273 </span>            :     for(i=0;i&lt;size;i++) index_i[i] = 0;
<span class="lineNum">    1274 </span>            : 
<span class="lineNum">    1275 </span>            :     F = fopen(filename,&quot;r&quot;);
<span class="lineNum">    1276 </span>            : 
<span class="lineNum">    1277 </span>            :     fscanf(F,&quot;%i&quot;,&amp;var_i);
<span class="lineNum">    1278 </span>            :     fscanf(F,&quot;%i&quot;,&amp;var_i);
<span class="lineNum">    1279 </span>            :     fscanf(F,&quot;%i&quot;,&amp;var_i);
<span class="lineNum">    1280 </span>            :    
<span class="lineNum">    1281 </span>            :     i0=0;
<span class="lineNum">    1282 </span>            :     for(i=0;i&lt;n_tot;i++){
<span class="lineNum">    1283 </span>            :         fscanf(F,&quot;%i&quot;,&amp;ind_i);
<span class="lineNum">    1284 </span>            :         fscanf(F,&quot;%i&quot;,&amp;var_i);
<span class="lineNum">    1285 </span>            :         fscanf(F,&quot;%lg&quot;,&amp;var_d);
<span class="lineNum">    1286 </span>            :         if(((ind_i-findx)&gt;=first_row)&amp;&amp;((ind_i-findx)&lt;first_row+size)){
<span class="lineNum">    1287 </span>            :             index_j[i0] = var_i;
<span class="lineNum">    1288 </span>            :             nnz[i0]     = var_d;
<span class="lineNum">    1289 </span>            :             if(ind_i==index_j[i0]){
<span class="lineNum">    1290 </span>            :                 diag_pos[ind_i-findx-first_row] = i0;
<span class="lineNum">    1291 </span>            :             }
<span class="lineNum">    1292 </span>            :             index_i[ind_i-findx-first_row]++;
<span class="lineNum">    1293 </span>            :             i0++;
<span class="lineNum">    1294 </span>            :         }
<span class="lineNum">    1295 </span>            :     }
<span class="lineNum">    1296 </span>            :     get_row_edge();
<span class="lineNum">    1297 </span>            :     fclose(F);
<span class="lineNum">    1298 </span>            : 
<span class="lineNum">    1299 </span>            : }
<span class="lineNum">    1300 </span>            : 
<span class="lineNum">    1301 </span>            : /***********************************************************************************************/
<a name="1302"><span class="lineNum">    1302 </span>            : </a>
<span class="lineNum">    1303 </span>            : template &lt;class T&gt;
<span class="lineNum">    1304 </span><span class="lineCov">        132 : TCSR&lt;T&gt;::~TCSR()</span>
<span class="lineNum">    1305 </span>            : {
<span class="lineNum">    1306 </span>            : 
<span class="lineNum">    1307 </span><span class="lineCov">        132 :     delete[] nnz;</span>
<span class="lineNum">    1308 </span><span class="lineCov">        132 :     delete[] index_i;</span>
<span class="lineNum">    1309 </span><span class="lineCov">        132 :     delete[] index_j;</span>
<span class="lineNum">    1310 </span><span class="lineCov">        132 :     delete[] edge_i;</span>
<span class="lineNum">    1311 </span><span class="lineCov">        132 :     delete[] diag_pos;</span>
<span class="lineNum">    1312 </span>            : 
<span class="lineNum">    1313 </span><span class="lineCov">        132 : }</span>
<span class="lineNum">    1314 </span>            : 
<span class="lineNum">    1315 </span>            : /************************************************************************************************/
<span class="lineNum">    1316 </span>            : 
<span class="lineNum">    1317 </span>            : template &lt;class T&gt;
<span class="lineNum">    1318 </span>            : void TCSR&lt;T&gt;::change_contain(TCSR&lt;T&gt; *mat)
<span class="lineNum">    1319 </span>            : {
<span class="lineNum">    1320 </span>            :     size       = mat-&gt;size;
<span class="lineNum">    1321 </span>            :     size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1322 </span>            :     type       = mat-&gt;type;
<span class="lineNum">    1323 </span>            :     n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1324 </span>            :     findx      = mat-&gt;findx;
<span class="lineNum">    1325 </span>            :     first_row  = mat-&gt;first_row;
<span class="lineNum">    1326 </span>            : 
<span class="lineNum">    1327 </span>            :     c_tcopy(n_nonzeros,mat-&gt;nnz,1,nnz,1);
<span class="lineNum">    1328 </span>            :     c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1329 </span>            :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1330 </span>            :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1331 </span>            :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1332 </span>            : }
<span class="lineNum">    1333 </span>            : 
<span class="lineNum">    1334 </span>            : /************************************************************************************************/
<span class="lineNum">    1335 </span>            : 
<span class="lineNum">    1336 </span>            : template &lt;class T&gt;
<span class="lineNum">    1337 </span>            : void TCSR&lt;T&gt;::copy_index(TCSR&lt;double&gt; *mat)
<span class="lineNum">    1338 </span>            : {
<span class="lineNum">    1339 </span>            :     size       = mat-&gt;size;
<span class="lineNum">    1340 </span>            :     size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1341 </span>            :     type       = mat-&gt;type;
<span class="lineNum">    1342 </span>            :     n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1343 </span>            :     findx      = mat-&gt;findx;
<span class="lineNum">    1344 </span>            :     first_row  = mat-&gt;first_row;
<span class="lineNum">    1345 </span>            : 
<span class="lineNum">    1346 </span>            :     c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1347 </span>            :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1348 </span>            :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1349 </span>            :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1350 </span>            : }
<span class="lineNum">    1351 </span>            : 
<span class="lineNum">    1352 </span>            : /************************************************************************************************/
<span class="lineNum">    1353 </span>            : 
<span class="lineNum">    1354 </span>            : template &lt;class T&gt;
<span class="lineNum">    1355 </span>            : void TCSR&lt;T&gt;::copy_index(TCSR&lt;CPX&gt; *mat)
<span class="lineNum">    1356 </span>            : {
<span class="lineNum">    1357 </span>            :     size       = mat-&gt;size;
<span class="lineNum">    1358 </span>            :     size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1359 </span>            :     type       = mat-&gt;type;
<span class="lineNum">    1360 </span>            :     n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1361 </span>            :     findx      = mat-&gt;findx;
<span class="lineNum">    1362 </span>            :     first_row  = mat-&gt;first_row;
<span class="lineNum">    1363 </span>            : 
<span class="lineNum">    1364 </span>            :     c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1365 </span>            :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1366 </span>            :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1367 </span>            :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1368 </span>            : }
<span class="lineNum">    1369 </span>            : 
<span class="lineNum">    1370 </span>            : /************************************************************************************************/
<span class="lineNum">    1371 </span>            : 
<span class="lineNum">    1372 </span>            : template &lt;&gt;
<span class="lineNum">    1373 </span><span class="lineCov">          1 : inline void TCSR&lt;CPX&gt;::copy_contain(TCSR&lt;double&gt; *mat,double factor)</span>
<span class="lineNum">    1374 </span>            : {
<span class="lineNum">    1375 </span>            : 
<span class="lineNum">    1376 </span><span class="lineCov">          1 :     size       = mat-&gt;size;</span>
<span class="lineNum">    1377 </span><span class="lineCov">          1 :     size_tot   = mat-&gt;size_tot;</span>
<span class="lineNum">    1378 </span><span class="lineCov">          1 :     type       = mat-&gt;type;</span>
<span class="lineNum">    1379 </span><span class="lineCov">          1 :     n_nonzeros = mat-&gt;n_nonzeros;</span>
<span class="lineNum">    1380 </span><span class="lineCov">          1 :     findx      = mat-&gt;findx;</span>
<span class="lineNum">    1381 </span><span class="lineCov">          1 :     first_row  = mat-&gt;first_row;</span>
<span class="lineNum">    1382 </span>            : 
<span class="lineNum">    1383 </span><span class="lineCov">          2 :     c_dcopy(n_nonzeros,mat-&gt;nnz,1,(double*)nnz,2);</span>
<span class="lineNum">    1384 </span><span class="lineCov">          3 :     c_zscal(n_nonzeros,CPX(factor,0.0),nnz,1);</span>
<span class="lineNum">    1385 </span><span class="lineCov">          2 :     c_icopy(size,mat-&gt;index_i,1,index_i,1);</span>
<span class="lineNum">    1386 </span><span class="lineCov">          2 :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);</span>
<span class="lineNum">    1387 </span><span class="lineCov">          2 :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);</span>
<span class="lineNum">    1388 </span><span class="lineCov">          2 :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);</span>
<span class="lineNum">    1389 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    1390 </span>            : 
<span class="lineNum">    1391 </span>            : /************************************************************************************************/
<span class="lineNum">    1392 </span>            : 
<span class="lineNum">    1393 </span>            : template &lt;&gt;
<span class="lineNum">    1394 </span>            : inline void TCSR&lt;double&gt;::copy_contain(TCSR&lt;double&gt; *mat,double factor)
<span class="lineNum">    1395 </span>            : {
<span class="lineNum">    1396 </span>            : 
<span class="lineNum">    1397 </span>            :     size       = mat-&gt;size;
<span class="lineNum">    1398 </span>            :     size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1399 </span>            :     type       = mat-&gt;type;
<span class="lineNum">    1400 </span>            :     n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1401 </span>            :     findx      = mat-&gt;findx;
<span class="lineNum">    1402 </span>            :     first_row  = mat-&gt;first_row;
<span class="lineNum">    1403 </span>            : 
<span class="lineNum">    1404 </span>            :     c_dcopy(n_nonzeros,mat-&gt;nnz,1,nnz,1);
<span class="lineNum">    1405 </span>            :     c_dscal(n_nonzeros,factor,nnz,1);
<span class="lineNum">    1406 </span>            :     c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1407 </span>            :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1408 </span>            :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1409 </span>            :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1410 </span>            : }
<span class="lineNum">    1411 </span>            : 
<span class="lineNum">    1412 </span>            : /************************************************************************************************/
<span class="lineNum">    1413 </span>            : 
<span class="lineNum">    1414 </span>            : template &lt;&gt;
<span class="lineNum">    1415 </span><span class="lineNoCov">          0 : inline void TCSR&lt;CPX&gt;::copy_contain(TCSR&lt;CPX&gt; *mat,double factor)</span>
<span class="lineNum">    1416 </span>            : {
<span class="lineNum">    1417 </span>            : 
<span class="lineNum">    1418 </span><span class="lineNoCov">          0 :     size       = mat-&gt;size;</span>
<span class="lineNum">    1419 </span><span class="lineNoCov">          0 :     size_tot   = mat-&gt;size_tot;</span>
<span class="lineNum">    1420 </span><span class="lineNoCov">          0 :     type       = mat-&gt;type;</span>
<span class="lineNum">    1421 </span><span class="lineNoCov">          0 :     n_nonzeros = mat-&gt;n_nonzeros;</span>
<span class="lineNum">    1422 </span><span class="lineNoCov">          0 :     findx      = mat-&gt;findx;</span>
<span class="lineNum">    1423 </span><span class="lineNoCov">          0 :     first_row  = mat-&gt;first_row;</span>
<span class="lineNum">    1424 </span>            : 
<span class="lineNum">    1425 </span><span class="lineNoCov">          0 :     c_zcopy(n_nonzeros,mat-&gt;nnz,1,nnz,1);</span>
<span class="lineNum">    1426 </span><span class="lineNoCov">          0 :     c_zscal(n_nonzeros,CPX(factor,0.0),nnz,1);</span>
<span class="lineNum">    1427 </span><span class="lineNoCov">          0 :     c_icopy(size,mat-&gt;index_i,1,index_i,1);</span>
<span class="lineNum">    1428 </span><span class="lineNoCov">          0 :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);</span>
<span class="lineNum">    1429 </span><span class="lineNoCov">          0 :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);</span>
<span class="lineNum">    1430 </span><span class="lineNoCov">          0 :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);</span>
<span class="lineNum">    1431 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    1432 </span>            : 
<span class="lineNum">    1433 </span>            : /************************************************************************************************/
<span class="lineNum">    1434 </span>            : 
<span class="lineNum">    1435 </span>            : template &lt;&gt;
<span class="lineNum">    1436 </span>            : inline void TCSR&lt;double&gt;::copy_contain(TCSR&lt;CPX&gt; *mat,double factor)
<span class="lineNum">    1437 </span>            : {
<span class="lineNum">    1438 </span>            : 
<span class="lineNum">    1439 </span>            :     size       = mat-&gt;size;
<span class="lineNum">    1440 </span>            :     size_tot   = mat-&gt;size_tot;
<span class="lineNum">    1441 </span>            :     type       = mat-&gt;type;
<span class="lineNum">    1442 </span>            :     n_nonzeros = mat-&gt;n_nonzeros;
<span class="lineNum">    1443 </span>            :     findx      = mat-&gt;findx;
<span class="lineNum">    1444 </span>            :     first_row  = mat-&gt;first_row;
<span class="lineNum">    1445 </span>            : 
<span class="lineNum">    1446 </span>            :     c_dcopy(n_nonzeros,(double*)mat-&gt;nnz,2,nnz,1);
<span class="lineNum">    1447 </span>            :     c_dscal(n_nonzeros,factor,nnz,1);
<span class="lineNum">    1448 </span>            :     c_icopy(size,mat-&gt;index_i,1,index_i,1);
<span class="lineNum">    1449 </span>            :     c_icopy(n_nonzeros,mat-&gt;index_j,1,index_j,1);
<span class="lineNum">    1450 </span>            :     c_icopy(size+1,mat-&gt;edge_i,1,edge_i,1);
<span class="lineNum">    1451 </span>            :     c_icopy(size,mat-&gt;diag_pos,1,diag_pos,1);
<span class="lineNum">    1452 </span>            : }
<span class="lineNum">    1453 </span>            : 
<span class="lineNum">    1454 </span>            : /************************************************************************************************/
<span class="lineNum">    1455 </span>            : 
<span class="lineNum">    1456 </span>            : template &lt;class T&gt;
<span class="lineNum">    1457 </span>            : void TCSR&lt;T&gt;::cpu_distribute(int *Istart,int *Nlocal,int N,int msize,int mrank)
<span class="lineNum">    1458 </span>            : {
<span class="lineNum">    1459 </span>            :     int max_rank,NCPU;
<span class="lineNum">    1460 </span>            : 
<span class="lineNum">    1461 </span>            :     NCPU             = int(ceil((double)N/msize));
<span class="lineNum">    1462 </span>            :     max_rank         = N-(NCPU-1)*msize;
<span class="lineNum">    1463 </span>            :     *Nlocal          = NCPU-1;
<span class="lineNum">    1464 </span>            : 
<span class="lineNum">    1465 </span>            :     if(mrank&lt;max_rank){*Nlocal = NCPU;}
<span class="lineNum">    1466 </span>            : 
<span class="lineNum">    1467 </span>            :     *Istart          = min(mrank,max_rank)*NCPU+max(mrank-max_rank,0)*(NCPU-1);
<span class="lineNum">    1468 </span>            : }
<span class="lineNum">    1469 </span>            : 
<span class="lineNum">    1470 </span>            : /************************************************************************************************/
<span class="lineNum">    1471 </span>            : 
<span class="lineNum">    1472 </span>            : template &lt;class T&gt;
<span class="lineNum">    1473 </span>            : void TCSR&lt;T&gt;::update_diag(T *diag,T factor)
<span class="lineNum">    1474 </span>            : {
<span class="lineNum">    1475 </span>            :     int i;
<span class="lineNum">    1476 </span>            : 
<span class="lineNum">    1477 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1478 </span>            :         if(diag_pos[i]&gt;=0){
<span class="lineNum">    1479 </span>            :             nnz[diag_pos[i]] = nnz[diag_pos[i]]+factor*diag[first_row+i];
<span class="lineNum">    1480 </span>            :         }else{
<span class="lineNum">    1481 </span>            :             printf(&quot;No diagonal at index %i (%i)\n&quot;,i,i+first_row);
<span class="lineNum">    1482 </span>            :             abort();
<span class="lineNum">    1483 </span>            :         }
<span class="lineNum">    1484 </span>            :     }
<span class="lineNum">    1485 </span>            :     
<span class="lineNum">    1486 </span>            : }
<span class="lineNum">    1487 </span>            : 
<span class="lineNum">    1488 </span>            : /************************************************************************************************/
<span class="lineNum">    1489 </span>            : 
<span class="lineNum">    1490 </span>            : template &lt;class T&gt;
<span class="lineNum">    1491 </span>            : void TCSR&lt;T&gt;::update_loc_diag(T *diag,T factor)
<span class="lineNum">    1492 </span>            : {
<span class="lineNum">    1493 </span>            :     int i;
<span class="lineNum">    1494 </span>            : 
<span class="lineNum">    1495 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1496 </span>            :         if(diag_pos[i]&gt;=0){
<span class="lineNum">    1497 </span>            :             nnz[diag_pos[i]] = nnz[diag_pos[i]]+factor*diag[i];
<span class="lineNum">    1498 </span>            :         }else{
<span class="lineNum">    1499 </span>            :             printf(&quot;No diagonal at index %i\n&quot;,i);
<span class="lineNum">    1500 </span>            :             abort();
<span class="lineNum">    1501 </span>            :         }
<span class="lineNum">    1502 </span>            :     }
<span class="lineNum">    1503 </span>            :     
<span class="lineNum">    1504 </span>            : }
<span class="lineNum">    1505 </span>            : 
<span class="lineNum">    1506 </span>            : /************************************************************************************************/
<span class="lineNum">    1507 </span>            : 
<span class="lineNum">    1508 </span>            : template &lt;class T&gt;
<span class="lineNum">    1509 </span>            : void TCSR&lt;T&gt;::update_diag_single(T diag_element)
<span class="lineNum">    1510 </span>            : {
<span class="lineNum">    1511 </span>            :     int i;
<span class="lineNum">    1512 </span>            : 
<span class="lineNum">    1513 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1514 </span>            :         if(diag_pos[i]&gt;=0){
<span class="lineNum">    1515 </span>            :             nnz[diag_pos[i]] = nnz[diag_pos[i]]+diag_element;
<span class="lineNum">    1516 </span>            :         }else{
<span class="lineNum">    1517 </span>            :             printf(&quot;No diagonal at index %i\n&quot;,i);
<span class="lineNum">    1518 </span>            :             abort();
<span class="lineNum">    1519 </span>            :         }
<span class="lineNum">    1520 </span>            :     }
<span class="lineNum">    1521 </span>            :     
<span class="lineNum">    1522 </span>            : }
<span class="lineNum">    1523 </span>            : 
<span class="lineNum">    1524 </span>            : /************************************************************************************************/
<span class="lineNum">    1525 </span>            : 
<span class="lineNum">    1526 </span>            : template &lt;class T&gt;
<span class="lineNum">    1527 </span>            : void TCSR&lt;T&gt;::update_diag_single(T diag_element,int start,int stop)
<span class="lineNum">    1528 </span>            : {
<span class="lineNum">    1529 </span>            :     int i;
<span class="lineNum">    1530 </span>            : 
<span class="lineNum">    1531 </span>            :     for(i=max(first_row,start);i&lt;min(first_row+size,stop);i++){
<span class="lineNum">    1532 </span>            :         if(diag_pos[i-first_row]&gt;=0){
<span class="lineNum">    1533 </span>            :             nnz[diag_pos[i-first_row]] = nnz[diag_pos[i-first_row]]+diag_element;
<span class="lineNum">    1534 </span>            :         }else{
<span class="lineNum">    1535 </span>            :           printf(&quot;No diagonal at index %i (%i)\n&quot;,i-first_row,i);
<span class="lineNum">    1536 </span>            :             abort();
<span class="lineNum">    1537 </span>            :         }
<span class="lineNum">    1538 </span>            :     }
<span class="lineNum">    1539 </span>            :     
<span class="lineNum">    1540 </span>            : }
<span class="lineNum">    1541 </span>            : 
<span class="lineNum">    1542 </span>            : /************************************************************************************************/
<span class="lineNum">    1543 </span>            : 
<span class="lineNum">    1544 </span>            : template &lt;class T&gt;
<span class="lineNum">    1545 </span>            : void TCSR&lt;T&gt;::update_diag_pack(T *diag,T factor,int N)
<span class="lineNum">    1546 </span>            : {
<span class="lineNum">    1547 </span>            :     int i,j;
<span class="lineNum">    1548 </span>            : 
<span class="lineNum">    1549 </span>            :     for(i=0;i&lt;size/N;i++){
<span class="lineNum">    1550 </span>            :         for(j=0;j&lt;N;j++){
<span class="lineNum">    1551 </span>            :             if(diag_pos[i*N+j]&gt;=0){
<span class="lineNum">    1552 </span>            :                 nnz[diag_pos[i*N+j]] = nnz[diag_pos[i*N+j]]+factor*diag[first_row/N+i];
<span class="lineNum">    1553 </span>            :             }else{
<span class="lineNum">    1554 </span>            :                 printf(&quot;No diagonal at index %i (%i)\n&quot;,i*N+j,i*N+j+first_row);
<span class="lineNum">    1555 </span>            :                 abort();
<span class="lineNum">    1556 </span>            :             }
<span class="lineNum">    1557 </span>            :         }
<span class="lineNum">    1558 </span>            :     }
<span class="lineNum">    1559 </span>            :     
<span class="lineNum">    1560 </span>            : }
<span class="lineNum">    1561 </span>            : 
<span class="lineNum">    1562 </span>            : /************************************************************************************************/
<span class="lineNum">    1563 </span>            : 
<span class="lineNum">    1564 </span>            : template &lt;&gt;
<span class="lineNum">    1565 </span>            : inline void TCSR&lt;double&gt;::update_rdiag_pack(double *diag,int start,int stop,double factor,\
<span class="lineNum">    1566 </span>            :                                             int N,int *n_of_elements)
<span class="lineNum">    1567 </span>            : {
<span class="lineNum">    1568 </span>            :     int i,j,ind;
<span class="lineNum">    1569 </span>            : 
<span class="lineNum">    1570 </span>            :     for(i=start;i&lt;stop;i++){
<span class="lineNum">    1571 </span>            :         ind = get_msize(start,i-1,N,n_of_elements);
<span class="lineNum">    1572 </span>            :         for(j=0;j&lt;(n_of_elements[i+1]-n_of_elements[i])*N/10;j++){
<span class="lineNum">    1573 </span>            :             if(diag_pos[ind+j]&gt;=0){
<span class="lineNum">    1574 </span>            :                 nnz[diag_pos[ind+j]] = nnz[diag_pos[ind+j]]+factor*diag[i];
<span class="lineNum">    1575 </span>            :             }else{
<span class="lineNum">    1576 </span>            :                 printf(&quot;No diagonal at index %i (%i)\n&quot;,ind+j,i);
<span class="lineNum">    1577 </span>            :                 abort();
<span class="lineNum">    1578 </span>            :             }
<span class="lineNum">    1579 </span>            :         }
<span class="lineNum">    1580 </span>            :     }
<span class="lineNum">    1581 </span>            :     
<span class="lineNum">    1582 </span>            : }
<span class="lineNum">    1583 </span>            : 
<span class="lineNum">    1584 </span>            : /************************************************************************************************/
<span class="lineNum">    1585 </span>            : 
<span class="lineNum">    1586 </span>            : template &lt;&gt;
<span class="lineNum">    1587 </span>            : inline void TCSR&lt;CPX&gt;::update_rdiag_pack(double *diag,int start,int stop,double factor,int N,
<span class="lineNum">    1588 </span>            :                                          int *n_of_elements)
<span class="lineNum">    1589 </span>            : {
<span class="lineNum">    1590 </span>            :     int i,j,ind;
<span class="lineNum">    1591 </span>            : 
<span class="lineNum">    1592 </span>            :     for(i=start;i&lt;stop;i++){
<span class="lineNum">    1593 </span>            :         ind = get_msize(start,i-1,N,n_of_elements);
<span class="lineNum">    1594 </span>            :         for(j=0;j&lt;(n_of_elements[i+1]-n_of_elements[i])*N/10;j++){
<span class="lineNum">    1595 </span>            :             if(diag_pos[ind+j]&gt;=0){
<span class="lineNum">    1596 </span>            :                 nnz[diag_pos[ind+j]] = nnz[diag_pos[ind+j]]+CPX(factor*diag[i],0.0);
<span class="lineNum">    1597 </span>            :             }else{
<span class="lineNum">    1598 </span>            :                 printf(&quot;No diagonal at index %i (%i)\n&quot;,ind+j,i);
<span class="lineNum">    1599 </span>            :                 abort();
<span class="lineNum">    1600 </span>            :             }
<span class="lineNum">    1601 </span>            :         }
<span class="lineNum">    1602 </span>            :     }
<span class="lineNum">    1603 </span>            :     
<span class="lineNum">    1604 </span>            : }
<span class="lineNum">    1605 </span>            : 
<span class="lineNum">    1606 </span>            : /************************************************************************************************/
<span class="lineNum">    1607 </span>            : 
<span class="lineNum">    1608 </span>            : template &lt;class T&gt;
<span class="lineNum">    1609 </span>            : void TCSR&lt;T&gt;::get_row_edge()
<span class="lineNum">    1610 </span>            : {
<span class="lineNum">    1611 </span>            :     int i;
<span class="lineNum">    1612 </span>            : 
<span class="lineNum">    1613 </span><span class="lineCov">        126 :     edge_i[0] = findx;</span>
<span class="lineNum">    1614 </span>            :   
<span class="lineNum">    1615 </span><span class="lineCov">      22734 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    1616 </span><span class="lineCov">      22608 :         edge_i[i+1] = edge_i[i]+index_i[i];</span>
<span class="lineNum">    1617 </span>            :     }
<span class="lineNum">    1618 </span>            :     
<span class="lineNum">    1619 </span>            : }
<span class="lineNum">    1620 </span>            : 
<span class="lineNum">    1621 </span>            : /************************************************************************************************/
<a name="1622"><span class="lineNum">    1622 </span>            : </a>
<span class="lineNum">    1623 </span>            : template &lt;class T&gt;
<span class="lineNum">    1624 </span><span class="lineCov">        126 : void TCSR&lt;T&gt;::get_diag_pos()</span>
<span class="lineNum">    1625 </span>            : {
<span class="lineNum">    1626 </span>            :     int i,j;
<span class="lineNum">    1627 </span>            :     int found_diag;
<span class="lineNum">    1628 </span>            : 
<span class="lineNum">    1629 </span><span class="lineCov">        126 :     edge_i[0] = findx;</span>
<span class="lineNum">    1630 </span>            :   
<span class="lineNum">    1631 </span><span class="lineCov">      22734 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    1632 </span><span class="lineCov">      22608 :         found_diag = 0;</span>
<span class="lineNum">    1633 </span><span class="lineCov">    1575817 :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){</span>
<span class="lineNum">    1634 </span><span class="lineCov">    1553209 :             if((index_j[j]-findx)==(i+first_row)){</span>
<span class="lineNum">    1635 </span><span class="lineCov">       9978 :                 diag_pos[i] = j;</span>
<span class="lineNum">    1636 </span><span class="lineCov">       9978 :                 found_diag  = 1;</span>
<span class="lineNum">    1637 </span>            :             }
<span class="lineNum">    1638 </span>            :         }
<span class="lineNum">    1639 </span><span class="lineCov">      22608 :         if(!found_diag){</span>
<span class="lineNum">    1640 </span><span class="lineCov">      12630 :             diag_pos[i] = -1;</span>
<span class="lineNum">    1641 </span>            :         }
<span class="lineNum">    1642 </span>            :     }
<span class="lineNum">    1643 </span>            :     
<span class="lineNum">    1644 </span><span class="lineCov">        126 : }</span>
<span class="lineNum">    1645 </span>            : 
<span class="lineNum">    1646 </span>            : /************************************************************************************************/
<span class="lineNum">    1647 </span>            : 
<span class="lineNum">    1648 </span>            : template &lt;class T&gt;
<span class="lineNum">    1649 </span>            : void TCSR&lt;T&gt;::scale_element(int N, int* dat_ind, T scale_fact)
<span class="lineNum">    1650 </span>            : {
<span class="lineNum">    1651 </span>            :     int i;
<span class="lineNum">    1652 </span>            : 
<span class="lineNum">    1653 </span>            :     for(i=0;i&lt;N;i++){
<span class="lineNum">    1654 </span>            :         nnz[dat_ind[i]] = scale_fact*nnz[dat_ind[i]];
<span class="lineNum">    1655 </span>            :     }
<span class="lineNum">    1656 </span>            : }
<span class="lineNum">    1657 </span>            : 
<span class="lineNum">    1658 </span>            : 
<span class="lineNum">    1659 </span>            : /************************************************************************************************/
<span class="lineNum">    1660 </span>            : 
<span class="lineNum">    1661 </span>            : template &lt;&gt;
<span class="lineNum">    1662 </span>            : inline void TCSR&lt;double&gt;::mat_vec_mult(double *in, double *out, int nrhs)
<span class="lineNum">    1663 </span>            : {
<span class="lineNum">    1664 </span>            :     int i,j,until;
<span class="lineNum">    1665 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    1666 </span>            :     
<span class="lineNum">    1667 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1668 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1669 </span>            :         until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    1670 </span>            :         for(j=0;j&lt;until;j++){
<span class="lineNum">    1671 </span>            :             c_daxpy(nrhs,nnz[edge_i[i]-findx+j],&amp;in[index_j[edge_i[i]-findx+j]-findx],\
<span class="lineNum">    1672 </span>            :                     size_tot,vec,1);
<span class="lineNum">    1673 </span>            :         }
<span class="lineNum">    1674 </span>            :         c_dcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1675 </span>            :     }
<span class="lineNum">    1676 </span>            :     delete[] vec;
<span class="lineNum">    1677 </span>            : 
<span class="lineNum">    1678 </span>            : }
<span class="lineNum">    1679 </span>            : 
<span class="lineNum">    1680 </span>            : /************************************************************************************************/
<span class="lineNum">    1681 </span>            : 
<span class="lineNum">    1682 </span>            : template &lt;&gt;
<span class="lineNum">    1683 </span><span class="lineCov">          8 : inline void TCSR&lt;CPX&gt;::mat_vec_mult(CPX *in, CPX *out, int nrhs)</span>
<span class="lineNum">    1684 </span>            : {
<span class="lineNum">    1685 </span>            :     int i,j,until;
<span class="lineNum">    1686 </span><span class="lineCov">         62 :     CPX *vec = new CPX[nrhs];</span>
<span class="lineNum">    1687 </span>            :     
<span class="lineNum">    1688 </span><span class="lineCov">       3464 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    1689 </span><span class="lineCov">       1728 :         init_variable(vec,nrhs);</span>
<span class="lineNum">    1690 </span><span class="lineCov">       1728 :         until = edge_i[i+1]-edge_i[i];</span>
<span class="lineNum">    1691 </span><span class="lineCov">      74096 :         for(j=0;j&lt;until;j++){</span>
<span class="lineNum">    1692 </span><span class="lineCov">      72368 :             c_zaxpy(nrhs,nnz[edge_i[i]-findx+j],&amp;in[index_j[edge_i[i]-findx+j]-findx],\</span>
<span class="lineNum">    1693 </span><span class="lineCov">      72368 :                     size_tot,vec,1);</span>
<span class="lineNum">    1694 </span>            :         }
<span class="lineNum">    1695 </span><span class="lineCov">       3456 :         c_zcopy(nrhs,vec,1,&amp;out[i],size);</span>
<span class="lineNum">    1696 </span>            :     }
<span class="lineNum">    1697 </span><span class="lineCov">          8 :     delete[] vec;</span>
<span class="lineNum">    1698 </span>            : 
<span class="lineNum">    1699 </span><span class="lineCov">          8 : }</span>
<span class="lineNum">    1700 </span>            : 
<span class="lineNum">    1701 </span>            : /************************************************************************************************/
<span class="lineNum">    1702 </span>            : 
<span class="lineNum">    1703 </span>            : template &lt;&gt;
<span class="lineNum">    1704 </span>            : inline void TCSR&lt;CPX&gt;::mat_vec_mult(CPX *in, CPX *out, int nrhs, int NR)
<span class="lineNum">    1705 </span>            : {
<span class="lineNum">    1706 </span>            :     int i,j,until;
<span class="lineNum">    1707 </span>            :     CPX *vec = new CPX[nrhs];
<span class="lineNum">    1708 </span>            :     
<span class="lineNum">    1709 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1710 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1711 </span>            :         until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    1712 </span>            :         for(j=0;j&lt;until;j++){
<span class="lineNum">    1713 </span>            :             c_zaxpy(nrhs,nnz[edge_i[i]-findx+j],&amp;in[index_j[edge_i[i]-findx+j]-findx],\
<span class="lineNum">    1714 </span>            :                     NR,vec,1);
<span class="lineNum">    1715 </span>            :         }
<span class="lineNum">    1716 </span>            :         c_zcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1717 </span>            :     }
<span class="lineNum">    1718 </span>            :     delete[] vec;
<span class="lineNum">    1719 </span>            : 
<span class="lineNum">    1720 </span>            : }
<span class="lineNum">    1721 </span>            : 
<span class="lineNum">    1722 </span>            : /************************************************************************************************/
<span class="lineNum">    1723 </span>            : 
<span class="lineNum">    1724 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<a name="1725"><span class="lineNum">    1725 </span>            :   efficient when blas is used)*/</a>
<span class="lineNum">    1726 </span>            : template &lt;&gt;
<span class="lineNum">    1727 </span><span class="lineCov">          2 : inline void TCSR&lt;CPX&gt;::trans_mat_vec_mult(CPX *tr_in, CPX *out, int nrhs, int NR)</span>
<span class="lineNum">    1728 </span>            : {
<span class="lineNum">    1729 </span>            :     int i,j;
<span class="lineNum">    1730 </span><span class="lineCov">         48 :     CPX *vec = new CPX[nrhs];</span>
<span class="lineNum">    1731 </span>            :     
<span class="lineNum">    1732 </span><span class="lineCov">        866 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    1733 </span><span class="lineCov">        432 :         init_variable(vec,nrhs);</span>
<span class="lineNum">    1734 </span><span class="lineCov">      18524 :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){</span>
<span class="lineNum">    1735 </span><span class="lineCov">      36184 :             c_zaxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);</span>
<span class="lineNum">    1736 </span>            :         }
<span class="lineNum">    1737 </span><span class="lineCov">        864 :         c_zcopy(nrhs,vec,1,&amp;out[i],size);</span>
<span class="lineNum">    1738 </span>            :     }
<span class="lineNum">    1739 </span>            : 
<span class="lineNum">    1740 </span><span class="lineCov">          2 :     delete[] vec;</span>
<span class="lineNum">    1741 </span>            : 
<span class="lineNum">    1742 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    1743 </span>            : 
<span class="lineNum">    1744 </span>            : /************************************************************************************************/
<span class="lineNum">    1745 </span>            : 
<span class="lineNum">    1746 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<span class="lineNum">    1747 </span>            :   efficient when blas is used)*/
<span class="lineNum">    1748 </span>            : template &lt;&gt;
<span class="lineNum">    1749 </span>            : inline void TCSR&lt;CPX&gt;::trans_mat_vec_mult_omp(CPX *tr_in, CPX *out, int nrhs, int NR)
<span class="lineNum">    1750 </span>            : {
<span class="lineNum">    1751 </span>            : #pragma omp parallel
<span class="lineNum">    1752 </span>            : {
<span class="lineNum">    1753 </span>            :     CPX *vec = new CPX[nrhs];
<span class="lineNum">    1754 </span>            : #pragma omp for schedule(dynamic)
<span class="lineNum">    1755 </span>            :     for(int i=0;i&lt;size;i++){
<span class="lineNum">    1756 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1757 </span>            :         for(int j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1758 </span>            :             c_zaxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);
<span class="lineNum">    1759 </span>            :         }
<span class="lineNum">    1760 </span>            :         c_zcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1761 </span>            :     }
<span class="lineNum">    1762 </span>            : 
<span class="lineNum">    1763 </span>            :     delete[] vec;
<span class="lineNum">    1764 </span>            : }
<span class="lineNum">    1765 </span>            : 
<span class="lineNum">    1766 </span>            : }
<span class="lineNum">    1767 </span>            : 
<span class="lineNum">    1768 </span>            : /************************************************************************************************/
<span class="lineNum">    1769 </span>            : 
<span class="lineNum">    1770 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<span class="lineNum">    1771 </span>            :   efficient when blas is used)*/
<span class="lineNum">    1772 </span>            : template &lt;&gt;
<span class="lineNum">    1773 </span>            : inline void TCSR&lt;CPX&gt;::trans_mat_vec_mult(CPX *tr_in, CPX *out, int nrhs, int NR,int NLine)
<span class="lineNum">    1774 </span>            : {
<span class="lineNum">    1775 </span>            :     int i,j;
<span class="lineNum">    1776 </span>            :     CPX *vec = new CPX[nrhs];
<span class="lineNum">    1777 </span>            :     
<span class="lineNum">    1778 </span>            :     for(i=0;i&lt;NLine;i++){
<span class="lineNum">    1779 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1780 </span>            :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1781 </span>            :             c_zaxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);
<span class="lineNum">    1782 </span>            :         }
<span class="lineNum">    1783 </span>            :         c_zcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1784 </span>            :     }
<span class="lineNum">    1785 </span>            : 
<span class="lineNum">    1786 </span>            :     delete[] vec;
<span class="lineNum">    1787 </span>            : 
<span class="lineNum">    1788 </span>            : }
<span class="lineNum">    1789 </span>            : 
<span class="lineNum">    1790 </span>            : /************************************************************************************************/
<span class="lineNum">    1791 </span>            : 
<span class="lineNum">    1792 </span>            : template &lt;&gt;
<span class="lineNum">    1793 </span>            : inline void TCSR&lt;double&gt;::mat_vec_mult(double *in, double *out, int nrhs, int NR)
<span class="lineNum">    1794 </span>            : {
<span class="lineNum">    1795 </span>            :     int i,j;
<span class="lineNum">    1796 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    1797 </span>            :     
<span class="lineNum">    1798 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1799 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1800 </span>            :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1801 </span>            :             c_daxpy(nrhs,nnz[j],&amp;in[index_j[j]-findx],NR,vec,1);
<span class="lineNum">    1802 </span>            :         }
<span class="lineNum">    1803 </span>            :         c_dcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1804 </span>            :     }
<span class="lineNum">    1805 </span>            : 
<span class="lineNum">    1806 </span>            :     delete[] vec;
<span class="lineNum">    1807 </span>            : 
<span class="lineNum">    1808 </span>            : }
<span class="lineNum">    1809 </span>            : 
<span class="lineNum">    1810 </span>            : /************************************************************************************************/
<span class="lineNum">    1811 </span>            : 
<span class="lineNum">    1812 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<span class="lineNum">    1813 </span>            :   efficient when blas is used)*/
<span class="lineNum">    1814 </span>            : template &lt;&gt;
<span class="lineNum">    1815 </span>            : inline void TCSR&lt;double&gt;::trans_mat_vec_mult(double *tr_in, double *out, int nrhs, int NR)
<span class="lineNum">    1816 </span>            : {
<span class="lineNum">    1817 </span>            :     int i,j;
<span class="lineNum">    1818 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    1819 </span>            :     
<span class="lineNum">    1820 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    1821 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1822 </span>            :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1823 </span>            :             c_daxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);
<span class="lineNum">    1824 </span>            :         }
<span class="lineNum">    1825 </span>            :         c_dcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1826 </span>            :     }
<span class="lineNum">    1827 </span>            : 
<span class="lineNum">    1828 </span>            :     delete[] vec;
<span class="lineNum">    1829 </span>            : 
<span class="lineNum">    1830 </span>            : }
<span class="lineNum">    1831 </span>            : 
<span class="lineNum">    1832 </span>            : /************************************************************************************************/
<span class="lineNum">    1833 </span>            : 
<span class="lineNum">    1834 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<span class="lineNum">    1835 </span>            :   efficient when blas is used)*/
<span class="lineNum">    1836 </span>            : template &lt;&gt;
<span class="lineNum">    1837 </span>            : inline void TCSR&lt;double&gt;::trans_mat_vec_mult_omp(double *tr_in, double *out, int nrhs, int NR)
<span class="lineNum">    1838 </span>            : {
<span class="lineNum">    1839 </span>            : #pragma omp parallel
<span class="lineNum">    1840 </span>            : {
<span class="lineNum">    1841 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    1842 </span>            : #pragma omp for schedule(dynamic)
<span class="lineNum">    1843 </span>            :     for(int i=0;i&lt;size;i++){
<span class="lineNum">    1844 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1845 </span>            :         for(int j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1846 </span>            :             c_daxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);
<span class="lineNum">    1847 </span>            :         }
<span class="lineNum">    1848 </span>            :         c_dcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1849 </span>            :     }
<span class="lineNum">    1850 </span>            : 
<span class="lineNum">    1851 </span>            :     delete[] vec;
<span class="lineNum">    1852 </span>            : }
<span class="lineNum">    1853 </span>            : 
<span class="lineNum">    1854 </span>            : }
<span class="lineNum">    1855 </span>            : 
<span class="lineNum">    1856 </span>            : /************************************************************************************************/
<span class="lineNum">    1857 </span>            : 
<span class="lineNum">    1858 </span>            : /*This function calculate sparse_mat*in with the help of the transpose of in tr_in (more
<span class="lineNum">    1859 </span>            :   efficient when blas is used)*/
<span class="lineNum">    1860 </span>            : template &lt;&gt;
<span class="lineNum">    1861 </span>            : inline void TCSR&lt;double&gt;::trans_mat_vec_mult(double *tr_in, double *out, int nrhs, int NR, int NLine)
<span class="lineNum">    1862 </span>            : {
<span class="lineNum">    1863 </span>            :     int i,j;
<span class="lineNum">    1864 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    1865 </span>            :     
<span class="lineNum">    1866 </span>            :     for(i=0;i&lt;NLine;i++){
<span class="lineNum">    1867 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    1868 </span>            :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    1869 </span>            :             c_daxpy(nrhs,nnz[j],&amp;tr_in[nrhs*(index_j[j]-findx)],1,vec,1);
<span class="lineNum">    1870 </span>            :         }
<span class="lineNum">    1871 </span>            :         c_dcopy(nrhs,vec,1,&amp;out[i],size);
<span class="lineNum">    1872 </span>            :     }
<span class="lineNum">    1873 </span>            : 
<span class="lineNum">    1874 </span>            :     delete[] vec;
<span class="lineNum">    1875 </span>            : 
<span class="lineNum">    1876 </span>            : }
<span class="lineNum">    1877 </span>            : 
<span class="lineNum">    1878 </span>            : /************************************************************************************************/
<span class="lineNum">    1879 </span>            : 
<span class="lineNum">    1880 </span>            : template &lt;class T&gt;
<span class="lineNum">    1881 </span>            : inline void TCSR&lt;T&gt;::spec_mat_vec_mult(T *in, T *out, int in_fst_row, int *low, int *high, \
<span class="lineNum">    1882 </span>            :                                        int NS, int fac)
<span class="lineNum">    1883 </span>            : {
<span class="lineNum">    1884 </span>            :     int i,j,start,stop,IS,until,in_index;
<span class="lineNum">    1885 </span>            : 
<span class="lineNum">    1886 </span>            :     init_variable(out,size);
<span class="lineNum">    1887 </span>            : 
<span class="lineNum">    1888 </span>            :     for(IS=0;IS&lt;NS-1;IS++){
<span class="lineNum">    1889 </span>            :         start = max(low[IS]*fac-first_row,0);
<span class="lineNum">    1890 </span>            :         stop  = min((high[IS]+1)*fac-first_row,size);
<span class="lineNum">    1891 </span>            :         for(i=start;i&lt;stop;i++){
<span class="lineNum">    1892 </span>            :             until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    1893 </span>            :             for(j=0;j&lt;until;j++){
<span class="lineNum">    1894 </span>            :                 if((index_j[edge_i[i]-findx+j]-findx)&gt;=low[IS+1]*fac){
<span class="lineNum">    1895 </span>            :                     in_index = index_j[edge_i[i]-findx+j]-findx-in_fst_row;
<span class="lineNum">    1896 </span>            :                     out[i]   = out[i]+nnz[edge_i[i]-findx+j]*in[in_index];
<span class="lineNum">    1897 </span>            :                 }
<span class="lineNum">    1898 </span>            :             }
<span class="lineNum">    1899 </span>            :         }
<span class="lineNum">    1900 </span>            :     }
<span class="lineNum">    1901 </span>            : }
<span class="lineNum">    1902 </span>            : 
<span class="lineNum">    1903 </span>            : /************************************************************************************************/
<span class="lineNum">    1904 </span>            : 
<span class="lineNum">    1905 </span>            : template &lt;class T&gt;
<span class="lineNum">    1906 </span>            : inline void TCSR&lt;T&gt;::spec_mat_vec_mult(T *in, T *out, int in_fst_row, int *low, int *high, \
<span class="lineNum">    1907 </span>            :                                        int NS, int fac, int *size_of_el)
<span class="lineNum">    1908 </span>            : {
<span class="lineNum">    1909 </span>            :     int i,j,start,stop,IS,until,in_index;
<span class="lineNum">    1910 </span>            : 
<span class="lineNum">    1911 </span>            :     init_variable(out,size);
<span class="lineNum">    1912 </span>            : 
<span class="lineNum">    1913 </span>            :     for(IS=0;IS&lt;NS-1;IS++){
<span class="lineNum">    1914 </span>            :         start = max(get_msize(0,low[IS]-1,fac,size_of_el)-first_row,0);
<span class="lineNum">    1915 </span>            :         stop  = min(get_msize(0,high[IS],fac,size_of_el)-first_row,size);
<span class="lineNum">    1916 </span>            :         for(i=start;i&lt;stop;i++){
<span class="lineNum">    1917 </span>            :             until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    1918 </span>            :             for(j=0;j&lt;until;j++){
<span class="lineNum">    1919 </span>            :                 if((index_j[edge_i[i]-findx+j]-findx)&gt;=get_msize(0,low[IS+1]-1,fac,size_of_el)){
<span class="lineNum">    1920 </span>            :                     in_index = index_j[edge_i[i]-findx+j]-findx-in_fst_row;
<span class="lineNum">    1921 </span>            :                     out[i]   = out[i]+nnz[edge_i[i]-findx+j]*in[in_index];
<span class="lineNum">    1922 </span>            :                 }
<span class="lineNum">    1923 </span>            :             }
<span class="lineNum">    1924 </span>            :         }
<span class="lineNum">    1925 </span>            :     }
<span class="lineNum">    1926 </span>            : }
<span class="lineNum">    1927 </span>            : 
<span class="lineNum">    1928 </span>            : /*SAB********************************************************************************************/
<span class="lineNum">    1929 </span>            : 
<span class="lineNum">    1930 </span>            : template &lt;&gt;
<span class="lineNum">    1931 </span>            : inline void TCSR&lt;double&gt;::sparse_to_cmp_full(CPX *B,int nrow,int ncol)
<span class="lineNum">    1932 </span>            : {
<span class="lineNum">    1933 </span>            :     int i,j,e;
<span class="lineNum">    1934 </span>            : 
<span class="lineNum">    1935 </span>            :     init_variable(B,nrow*ncol);
<span class="lineNum">    1936 </span>            :     for(i=0;i&lt;min(nrow,size);i++){
<span class="lineNum">    1937 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    1938 </span>            :             if ((j=index_j[e]-findx)&lt;ncol){
<span class="lineNum">    1939 </span>            :                 B[i+j*nrow] = CPX(nnz[e],0.0);
<span class="lineNum">    1940 </span>            :             }
<span class="lineNum">    1941 </span>            :         }
<span class="lineNum">    1942 </span>            :     }
<span class="lineNum">    1943 </span>            : }
<span class="lineNum">    1944 </span>            : 
<span class="lineNum">    1945 </span>            : /************************************************************************************************/
<span class="lineNum">    1946 </span>            : 
<span class="lineNum">    1947 </span>            : template &lt;&gt;
<span class="lineNum">    1948 </span>            : inline void TCSR&lt;CPX&gt;::sparse_to_cmp_full(CPX *B,int nrow,int ncol)
<span class="lineNum">    1949 </span>            : {
<span class="lineNum">    1950 </span>            : }
<span class="lineNum">    1951 </span>            : 
<span class="lineNum">    1952 </span>            : /*SAB********************************************************************************************/
<a name="1953"><span class="lineNum">    1953 </span>            : </a>
<span class="lineNum">    1954 </span>            : template &lt;&gt;
<span class="lineNum">    1955 </span><span class="lineCov">      16128 : inline void TCSR&lt;double&gt;::add_sparse_to_cmp_full(CPX *B,int nrow,int ncol,CPX fac)</span>
<span class="lineNum">    1956 </span>            : {
<span class="lineNum">    1957 </span>            :     int i,j,e;
<span class="lineNum">    1958 </span>            : 
<span class="lineNum">    1959 </span><span class="lineCov">    2354688 :     for(i=0;i&lt;min(nrow,size);i++){</span>
<span class="lineNum">    1960 </span><span class="lineCov">   40237056 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    1961 </span><span class="lineCov">   39075840 :             if ((j=index_j[e]-findx)&lt;ncol){</span>
<span class="lineNum">    1962 </span><span class="lineCov">  117227520 :                 B[i+j*nrow] += fac*CPX(nnz[e],0.0);</span>
<span class="lineNum">    1963 </span>            :             }
<span class="lineNum">    1964 </span>            :         }
<span class="lineNum">    1965 </span>            :     }
<span class="lineNum">    1966 </span><span class="lineCov">      16128 : }</span>
<span class="lineNum">    1967 </span>            : 
<span class="lineNum">    1968 </span>            : /************************************************************************************************/
<span class="lineNum">    1969 </span>            : 
<span class="lineNum">    1970 </span>            : template &lt;&gt;
<span class="lineNum">    1971 </span>            : inline void TCSR&lt;CPX&gt;::add_sparse_to_cmp_full(CPX *B,int nrow,int ncol,CPX fac)
<span class="lineNum">    1972 </span>            : {
<span class="lineNum">    1973 </span>            : }
<span class="lineNum">    1974 </span>            : 
<span class="lineNum">    1975 </span>            : /*SAB********************************************************************************************/
<a name="1976"><span class="lineNum">    1976 </span>            : </a>
<span class="lineNum">    1977 </span>            : template &lt;class T&gt;
<span class="lineNum">    1978 </span><span class="lineCov">          3 : void TCSR&lt;T&gt;::sparse_to_full(T *B,int nrow,int ncol)</span>
<span class="lineNum">    1979 </span>            : {
<span class="lineNum">    1980 </span>            :     int i,j,e;
<span class="lineNum">    1981 </span>            : 
<span class="lineNum">    1982 </span><span class="lineCov">          3 :     init_variable(B,nrow*ncol);</span>
<span class="lineNum">    1983 </span><span class="lineCov">      10374 :     for(i=0;i&lt;min(nrow,size);i++){</span>
<span class="lineNum">    1984 </span><span class="lineCov">     264418 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    1985 </span><span class="lineCov">     260962 :             if ((j=index_j[e]-findx)&lt;ncol){</span>
<span class="lineNum">    1986 </span><span class="lineCov">     260962 :                 B[i+j*nrow] = nnz[e];</span>
<span class="lineNum">    1987 </span>            :             }
<span class="lineNum">    1988 </span>            :         }
<span class="lineNum">    1989 </span>            :     }
<span class="lineNum">    1990 </span><span class="lineCov">          3 : }</span>
<span class="lineNum">    1991 </span>            : 
<span class="lineNum">    1992 </span>            : /*SAB********************************************************************************************/
<a name="1993"><span class="lineNum">    1993 </span>            : </a>
<span class="lineNum">    1994 </span>            : template &lt;class T&gt;
<span class="lineNum">    1995 </span><span class="lineCov">         24 : void TCSR&lt;T&gt;::add_sparse_to_full(T *B,int nrow,int ncol,T fac)</span>
<span class="lineNum">    1996 </span>            : {
<span class="lineNum">    1997 </span>            :     int i,j,e;
<span class="lineNum">    1998 </span>            : 
<span class="lineNum">    1999 </span><span class="lineCov">       3504 :     for(i=0;i&lt;min(nrow,size);i++){</span>
<span class="lineNum">    2000 </span><span class="lineCov">      51584 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2001 </span><span class="lineCov">      49856 :             if ((j=index_j[e]-findx)&lt;ncol){</span>
<span class="lineNum">    2002 </span><span class="lineCov">     149568 :                 B[i+j*nrow] += fac*nnz[e];</span>
<span class="lineNum">    2003 </span>            :             }
<span class="lineNum">    2004 </span>            :         }
<span class="lineNum">    2005 </span>            :     }
<span class="lineNum">    2006 </span><span class="lineCov">         24 : }</span>
<span class="lineNum">    2007 </span>            : 
<span class="lineNum">    2008 </span>            : /*SAB********************************************************************************************/
<span class="lineNum">    2009 </span>            : 
<span class="lineNum">    2010 </span>            : template &lt;class T&gt;
<span class="lineNum">    2011 </span>            : void TCSR&lt;T&gt;::sparse_to_full(T *B,int nrow,int ncol,int ipos, int jpos)
<span class="lineNum">    2012 </span>            : {
<span class="lineNum">    2013 </span>            :     int i,j,e;
<span class="lineNum">    2014 </span>            : 
<span class="lineNum">    2015 </span>            :     init_variable(B,nrow*ncol);
<span class="lineNum">    2016 </span>            :     for(i=ipos;i&lt;min(ipos+nrow,size);i++){
<span class="lineNum">    2017 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2018 </span>            :             j=index_j[e]-findx-jpos;
<span class="lineNum">    2019 </span>            :             if (j&gt;=0 &amp;&amp; j&lt;ncol){
<span class="lineNum">    2020 </span>            :                 B[i-ipos+j*nrow] = nnz[e];
<span class="lineNum">    2021 </span>            :             }
<span class="lineNum">    2022 </span>            :         }
<span class="lineNum">    2023 </span>            :     }
<span class="lineNum">    2024 </span>            : }
<span class="lineNum">    2025 </span>            : 
<span class="lineNum">    2026 </span>            : /************************************************************************************************/
<span class="lineNum">    2027 </span>            : 
<span class="lineNum">    2028 </span>            : template &lt;&gt;
<span class="lineNum">    2029 </span>            : inline void TCSR&lt;double&gt;::mat_vec_mult_add(double *in, double *out, int nrhs, double fac)
<span class="lineNum">    2030 </span>            : {
<span class="lineNum">    2031 </span>            :     int i,j,until;
<span class="lineNum">    2032 </span>            :     double *vec = new double[nrhs];
<span class="lineNum">    2033 </span>            :     
<span class="lineNum">    2034 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2035 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    2036 </span>            :         until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    2037 </span>            :         for(j=0;j&lt;until;j++){
<span class="lineNum">    2038 </span>            :             c_daxpy(nrhs,nnz[edge_i[i]-findx+j],&amp;in[index_j[edge_i[i]-findx+j]-findx],\
<span class="lineNum">    2039 </span>            :                     size_tot,vec,1);
<span class="lineNum">    2040 </span>            :         }
<span class="lineNum">    2041 </span>            :         c_daxpy(nrhs,fac,vec,1,&amp;out[i],size);
<span class="lineNum">    2042 </span>            :     }
<span class="lineNum">    2043 </span>            :     delete[] vec;
<span class="lineNum">    2044 </span>            : 
<span class="lineNum">    2045 </span>            : }
<span class="lineNum">    2046 </span>            : 
<span class="lineNum">    2047 </span>            : /************************************************************************************************/
<span class="lineNum">    2048 </span>            : 
<span class="lineNum">    2049 </span>            : template &lt;&gt;
<span class="lineNum">    2050 </span>            : inline void TCSR&lt;CPX&gt;::mat_vec_mult_add(CPX *in, CPX *out, int nrhs, CPX fac)
<span class="lineNum">    2051 </span>            : {
<span class="lineNum">    2052 </span>            :     int i,j,until;
<span class="lineNum">    2053 </span>            :     CPX *vec = new CPX[nrhs];
<span class="lineNum">    2054 </span>            :     
<span class="lineNum">    2055 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2056 </span>            :         init_variable(vec,nrhs);
<span class="lineNum">    2057 </span>            :         until = edge_i[i+1]-edge_i[i];
<span class="lineNum">    2058 </span>            :         for(j=0;j&lt;until;j++){
<span class="lineNum">    2059 </span>            :             c_zaxpy(nrhs,nnz[edge_i[i]-findx+j],&amp;in[index_j[edge_i[i]-findx+j]-findx],\
<span class="lineNum">    2060 </span>            :                     size_tot,vec,1);
<span class="lineNum">    2061 </span>            :         }
<span class="lineNum">    2062 </span>            :         c_zaxpy(nrhs,fac,vec,1,&amp;out[i],size);
<span class="lineNum">    2063 </span>            :     }
<span class="lineNum">    2064 </span>            :     delete[] vec;
<span class="lineNum">    2065 </span>            : 
<span class="lineNum">    2066 </span>            : }
<span class="lineNum">    2067 </span>            : 
<span class="lineNum">    2068 </span>            : /************************************************************************************************/
<span class="lineNum">    2069 </span>            : 
<span class="lineNum">    2070 </span>            : template &lt;class T&gt;
<span class="lineNum">    2071 </span>            : int TCSR&lt;T&gt;::additionalentries(TCSR&lt;T&gt; *mat)
<span class="lineNum">    2072 </span>            : {
<span class="lineNum">    2073 </span>            :     int additional=0;
<span class="lineNum">    2074 </span>            :     int i,edgy1,edgy2,foundit;
<span class="lineNum">    2075 </span>            :     for (i=0;i&lt;size;i++) {
<span class="lineNum">    2076 </span>            :         for (edgy1=edge_i[i]-findx;edgy1&lt;edge_i[i+1]-findx;edgy1++) {
<span class="lineNum">    2077 </span>            :             foundit=0;
<span class="lineNum">    2078 </span>            :             for (edgy2=mat-&gt;edge_i[i]-mat-&gt;findx;edgy2&lt;mat-&gt;edge_i[i+1]-mat-&gt;findx;edgy2++) {
<span class="lineNum">    2079 </span>            :                 if (index_j[edgy1]==mat-&gt;index_j[edgy2]) {
<span class="lineNum">    2080 </span>            :                     foundit++;
<span class="lineNum">    2081 </span>            :                 }
<span class="lineNum">    2082 </span>            :             }
<span class="lineNum">    2083 </span>            :             if (!foundit) {
<span class="lineNum">    2084 </span>            :                 additional++;
<span class="lineNum">    2085 </span>            :             } else if (foundit&gt;1) {
<span class="lineNum">    2086 </span>            :                 return -1;
<span class="lineNum">    2087 </span>            :             }
<span class="lineNum">    2088 </span>            :         }
<span class="lineNum">    2089 </span>            :     }
<span class="lineNum">    2090 </span>            :     return additional;
<span class="lineNum">    2091 </span>            : }
<span class="lineNum">    2092 </span>            : 
<span class="lineNum">    2093 </span>            : /************************************************************************************************/
<span class="lineNum">    2094 </span>            : 
<span class="lineNum">    2095 </span>            : template &lt;class T&gt;
<span class="lineNum">    2096 </span>            : void TCSR&lt;T&gt;::add(TCSR&lt;T&gt; *A,T factor)
<span class="lineNum">    2097 </span>            : {
<span class="lineNum">    2098 </span>            :     if (size      != A-&gt;size      ) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2099 </span>            :     if (size_tot  != A-&gt;size_tot  ) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2100 </span>            :     if (type      != A-&gt;type      ) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2101 </span>            :     if (first_row != A-&gt;first_row ) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2102 </span>            : 
<span class="lineNum">    2103 </span>            :     int i,e;
<span class="lineNum">    2104 </span>            :     T *linefull=new T[size_tot];
<span class="lineNum">    2105 </span>            : 
<span class="lineNum">    2106 </span>            :     for (i=0;i&lt;size;i++) {
<span class="lineNum">    2107 </span>            :         init_variable(linefull,size_tot);
<span class="lineNum">    2108 </span>            :         for (e=A-&gt;edge_i[i]-A-&gt;findx;e&lt;A-&gt;edge_i[i+1]-A-&gt;findx;e++) {
<span class="lineNum">    2109 </span>            :             linefull[A-&gt;index_j[e]-A-&gt;findx]=factor*A-&gt;nnz[e];
<span class="lineNum">    2110 </span>            :         }
<span class="lineNum">    2111 </span>            :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2112 </span>            :             nnz[e]+=linefull[index_j[e]-findx];
<span class="lineNum">    2113 </span>            :         }
<span class="lineNum">    2114 </span>            :     }
<span class="lineNum">    2115 </span>            :     delete[] linefull;
<span class="lineNum">    2116 </span>            : }
<span class="lineNum">    2117 </span>            : 
<span class="lineNum">    2118 </span>            : /************************************************************************************************/
<span class="lineNum">    2119 </span>            : 
<span class="lineNum">    2120 </span>            : template &lt;&gt;
<span class="lineNum">    2121 </span><span class="lineNoCov">          0 : inline void TCSR&lt;double&gt;::add_real(TCSR&lt;CPX&gt; *A,CPX factor)</span>
<span class="lineNum">    2122 </span>            : {
<span class="lineNum">    2123 </span><span class="lineNoCov">          0 :     if (size      != A-&gt;size      ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    2124 </span><span class="lineNoCov">          0 :     if (size_tot  != A-&gt;size_tot  ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    2125 </span><span class="lineNoCov">          0 :     if (type      != A-&gt;type      ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    2126 </span><span class="lineNoCov">          0 :     if (first_row != A-&gt;first_row ) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    2127 </span>            : 
<span class="lineNum">    2128 </span>            :     int i,e;
<span class="lineNum">    2129 </span><span class="lineNoCov">          0 :     double *linefull=new double[size_tot];</span>
<span class="lineNum">    2130 </span>            : 
<span class="lineNum">    2131 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;size;i++) {</span>
<span class="lineNum">    2132 </span><span class="lineNoCov">          0 :         init_variable(linefull,size_tot);</span>
<span class="lineNum">    2133 </span><span class="lineNoCov">          0 :         for (e=A-&gt;edge_i[i]-A-&gt;findx;e&lt;A-&gt;edge_i[i+1]-A-&gt;findx;e++) {</span>
<span class="lineNum">    2134 </span><span class="lineNoCov">          0 :             linefull[A-&gt;index_j[e]-A-&gt;findx]=real(factor*A-&gt;nnz[e]);</span>
<span class="lineNum">    2135 </span>            :         }
<span class="lineNum">    2136 </span><span class="lineNoCov">          0 :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {</span>
<span class="lineNum">    2137 </span><span class="lineNoCov">          0 :             nnz[e]+=linefull[index_j[e]-findx];</span>
<span class="lineNum">    2138 </span>            :         }
<span class="lineNum">    2139 </span>            :     }
<span class="lineNum">    2140 </span><span class="lineNoCov">          0 :     delete[] linefull;</span>
<span class="lineNum">    2141 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2142 </span>            : 
<span class="lineNum">    2143 </span>            : /************************************************************************************************/
<a name="2144"><span class="lineNum">    2144 </span>            : </a>
<span class="lineNum">    2145 </span>            : template &lt;class T&gt;
<span class="lineNum">    2146 </span><span class="lineNoCov">          0 : void TCSR&lt;T&gt;::copy_shifted(TCSR&lt;T&gt;* mat,int istart, int ilength, int jstart, int jlength)</span>
<span class="lineNum">    2147 </span>            : {
<span class="lineNum">    2148 </span>            :     int i,e;
<span class="lineNum">    2149 </span><span class="lineNoCov">          0 :     T *linefull=new T[size_tot];</span>
<span class="lineNum">    2150 </span>            : 
<span class="lineNum">    2151 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;size;i++) {</span>
<span class="lineNum">    2152 </span><span class="lineNoCov">          0 :         init_variable(linefull,size_tot);</span>
<span class="lineNum">    2153 </span><span class="lineNoCov">          0 :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {</span>
<span class="lineNum">    2154 </span><span class="lineNoCov">          0 :             linefull[index_j[e]-findx]=nnz[e];</span>
<span class="lineNum">    2155 </span>            :         }
<span class="lineNum">    2156 </span><span class="lineNoCov">          0 :         for (e=mat-&gt;edge_i[i+istart+first_row-mat-&gt;first_row]-mat-&gt;findx;e&lt;mat-&gt;edge_i[i+istart+first_row-mat-&gt;first_row+1]-mat-&gt;findx;e++) {</span>
<span class="lineNum">    2157 </span><span class="lineNoCov">          0 :             if (mat-&gt;index_j[e]-mat-&gt;findx&gt;=jstart &amp;&amp; mat-&gt;index_j[e]-mat-&gt;findx&lt;jstart+jlength) {</span>
<span class="lineNum">    2158 </span><span class="lineNoCov">          0 :                 mat-&gt;nnz[e]=linefull[mat-&gt;index_j[e]-mat-&gt;findx-jstart];</span>
<span class="lineNum">    2159 </span>            :             }
<span class="lineNum">    2160 </span>            :         }
<span class="lineNum">    2161 </span>            :     }
<span class="lineNum">    2162 </span><span class="lineNoCov">          0 :     delete[] linefull;</span>
<span class="lineNum">    2163 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2164 </span>            : 
<span class="lineNum">    2165 </span>            : /************************************************************************************************/
<span class="lineNum">    2166 </span>            : 
<span class="lineNum">    2167 </span>            : template &lt;class T&gt;
<span class="lineNum">    2168 </span>            : void TCSR&lt;T&gt;::copy_pbc_cell(contact_type contact,int strinum,int strirange,MPI_Comm my_comm)
<span class="lineNum">    2169 </span>            : {
<span class="lineNum">    2170 </span>            :     int i,j,e;
<span class="lineNum">    2171 </span>            :     int bandw    = contact.bandwidth;
<span class="lineNum">    2172 </span>            :     int ndof     = contact.ndof;
<span class="lineNum">    2173 </span>            :     int start    = contact.start;//WARNING NOT IMPLEMENTED YET
<span class="lineNum">    2174 </span>            :     int inj_sign = contact.inj_sign;
<span class="lineNum">    2175 </span>            :     T* linefull = new T[(2*bandw+1)*ndof];
<span class="lineNum">    2176 </span>            :     if (inj_sign==1) {
<span class="lineNum">    2177 </span>            :         TCSR&lt;T&gt; *Pscut = new TCSR&lt;T&gt;(this,strinum*ndof,ndof,0,size_tot);
<span class="lineNum">    2178 </span>            :         TCSR&lt;T&gt; *Pcell = new TCSR&lt;T&gt;(Pscut,my_comm);
<span class="lineNum">    2179 </span>            :         delete Pscut;
<span class="lineNum">    2180 </span>            :         for (i=0;i&lt;size;i++) {
<span class="lineNum">    2181 </span>            :             int i_band=(i+first_row)/ndof;
<span class="lineNum">    2182 </span>            :             int i_elem=(i+first_row)%ndof;
<span class="lineNum">    2183 </span>            :             if (i_band&lt;strirange) {
<span class="lineNum">    2184 </span>            :                 init_variable(linefull,(2*bandw+1)*ndof);
<span class="lineNum">    2185 </span>            :                 for (e=Pcell-&gt;edge_i[i_elem]-Pcell-&gt;findx;e&lt;Pcell-&gt;edge_i[i_elem+1]-Pcell-&gt;findx;e++) {
<span class="lineNum">    2186 </span>            :                     j=(Pcell-&gt;index_j[e]-Pcell-&gt;findx+(bandw-strinum)*ndof+size_tot)%size_tot;
<span class="lineNum">    2187 </span>            :                     if (j&lt;0 || j&gt;=(2*bandw+1)*ndof) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2188 </span>            :                     linefull[j]=Pcell-&gt;nnz[e];
<span class="lineNum">    2189 </span>            :                 }
<span class="lineNum">    2190 </span>            :                 for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2191 </span>            :                     j=(index_j[e]-findx+(bandw-i_band)*ndof+size_tot)%size_tot;
<span class="lineNum">    2192 </span>            :                     if (j&lt;0 || j&gt;=(2*bandw+1)*ndof) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2193 </span>            :                     nnz[e]=linefull[j];
<span class="lineNum">    2194 </span>            :                 }
<span class="lineNum">    2195 </span>            :             }
<span class="lineNum">    2196 </span>            :         }
<span class="lineNum">    2197 </span>            :         delete Pcell;
<span class="lineNum">    2198 </span>            :     } else if (inj_sign==-1) {
<span class="lineNum">    2199 </span>            :         TCSR&lt;T&gt; *Pscut = new TCSR&lt;T&gt;(this,size_tot-(strinum+1)*ndof,ndof,0,size_tot);
<span class="lineNum">    2200 </span>            :         TCSR&lt;T&gt; *Pcell = new TCSR&lt;T&gt;(Pscut,my_comm);
<span class="lineNum">    2201 </span>            :         delete Pscut;
<span class="lineNum">    2202 </span>            :         for (i=0;i&lt;size;i++) {
<span class="lineNum">    2203 </span>            :             int i_band=(size_tot-i-first_row-1)/ndof;
<span class="lineNum">    2204 </span>            :             int i_elem=ndof-1-(size_tot-i-first_row-1)%ndof;
<span class="lineNum">    2205 </span>            :             if (i_band&lt;strirange) {
<span class="lineNum">    2206 </span>            :                 init_variable(linefull,(2*bandw+1)*ndof);
<span class="lineNum">    2207 </span>            :                 for (e=Pcell-&gt;edge_i[i_elem]-Pcell-&gt;findx;e&lt;Pcell-&gt;edge_i[i_elem+1]-Pcell-&gt;findx;e++) {
<span class="lineNum">    2208 </span>            :                     j=(Pcell-&gt;index_j[e]-Pcell-&gt;findx+(bandw+1+strinum)*ndof+size_tot)%size_tot;
<span class="lineNum">    2209 </span>            :                     if (j&lt;0 || j&gt;=(2*bandw+1)*ndof) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2210 </span>            :                     linefull[j]=Pcell-&gt;nnz[e];
<span class="lineNum">    2211 </span>            :                 }
<span class="lineNum">    2212 </span>            :                 for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2213 </span>            :                     j=(index_j[e]-findx+(bandw+1+i_band)*ndof+size_tot)%size_tot;
<span class="lineNum">    2214 </span>            :                     if (j&lt;0 || j&gt;=(2*bandw+1)*ndof) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2215 </span>            :                     nnz[e]=linefull[j];
<span class="lineNum">    2216 </span>            :                 }
<span class="lineNum">    2217 </span>            :             }
<span class="lineNum">    2218 </span>            :         }
<span class="lineNum">    2219 </span>            :         delete Pcell;
<span class="lineNum">    2220 </span>            :     }
<span class="lineNum">    2221 </span>            :     delete[] linefull;
<span class="lineNum">    2222 </span>            : }
<span class="lineNum">    2223 </span>            : 
<span class="lineNum">    2224 </span>            : /************************************************************************************************/
<span class="lineNum">    2225 </span>            : 
<span class="lineNum">    2226 </span>            : template &lt;class T&gt;
<span class="lineNum">    2227 </span>            : void TCSR&lt;T&gt;::add_pot(TCSR&lt;T&gt; *mat,int *n_of_el,T *vec)
<span class="lineNum">    2228 </span>            : {
<span class="lineNum">    2229 </span>            :     int* atom_of_bf=new int[size_tot];
<span class="lineNum">    2230 </span>            :     int atom=0;
<span class="lineNum">    2231 </span>            :     for (int i=0;i&lt;size_tot;i++) {
<span class="lineNum">    2232 </span>            :         if (i==n_of_el[atom+1]) ++atom;
<span class="lineNum">    2233 </span>            :         atom_of_bf[i]=atom;
<span class="lineNum">    2234 </span>            :     }
<span class="lineNum">    2235 </span>            :     for(int i=0;i&lt;size;i++) {
<span class="lineNum">    2236 </span>            :         int atom_i=atom_of_bf[i+first_row];
<span class="lineNum">    2237 </span>            :         for(int e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2238 </span>            :             int atom_j=atom_of_bf[index_j[e]-findx];
<span class="lineNum">    2239 </span>            :             nnz[e]+=(vec[atom_i]+vec[atom_j])/2.0*mat-&gt;nnz[e];
<span class="lineNum">    2240 </span>            :         }
<span class="lineNum">    2241 </span>            :     }
<span class="lineNum">    2242 </span>            :     delete[] atom_of_bf;
<span class="lineNum">    2243 </span>            : }
<span class="lineNum">    2244 </span>            : 
<span class="lineNum">    2245 </span>            : /************************************************************************************************/
<span class="lineNum">    2246 </span>            : 
<span class="lineNum">    2247 </span>            : template &lt;class T&gt;
<span class="lineNum">    2248 </span>            : void TCSR&lt;T&gt;::Bcast(int rootrank,MPI_Comm my_comm)
<span class="lineNum">    2249 </span>            : {
<span class="lineNum">    2250 </span>            :     MPI_Bcast(&amp;size,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2251 </span>            :     MPI_Bcast(&amp;size_tot,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2252 </span>            :     MPI_Bcast(&amp;type,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2253 </span>            :     MPI_Bcast(&amp;n_nonzeros,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2254 </span>            :     MPI_Bcast(&amp;findx,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2255 </span>            :     MPI_Bcast(&amp;first_row,1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2256 </span>            :     
<span class="lineNum">    2257 </span>            :     MPI_Bcast(nnz,n_nonzeros,give_me_MPI_datatype(nnz),rootrank,my_comm);
<span class="lineNum">    2258 </span>            :     MPI_Bcast(index_i,size,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2259 </span>            :     MPI_Bcast(index_j,n_nonzeros,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2260 </span>            :     MPI_Bcast(edge_i,size+1,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2261 </span>            :     MPI_Bcast(diag_pos,size,MPI_INT,rootrank,my_comm);
<span class="lineNum">    2262 </span>            : }
<span class="lineNum">    2263 </span>            : 
<span class="lineNum">    2264 </span>            : /************************************************************************************************/
<span class="lineNum">    2265 </span>            : 
<span class="lineNum">    2266 </span>            : template &lt;class T&gt;
<span class="lineNum">    2267 </span>            : void TCSR&lt;T&gt;::scatter(TCSR&lt;T&gt;*matdist,int root,MPI_Comm my_comm)
<span class="lineNum">    2268 </span>            : {
<span class="lineNum">    2269 </span>            :     int iam,nprocs;
<span class="lineNum">    2270 </span>            :     MPI_Comm_size(my_comm,&amp;nprocs);
<span class="lineNum">    2271 </span>            :     MPI_Comm_rank(my_comm,&amp;iam);
<span class="lineNum">    2272 </span>            : 
<span class="lineNum">    2273 </span>            :     int *scounts=new int[nprocs];
<span class="lineNum">    2274 </span>            :     int sloc=matdist-&gt;n_nonzeros;
<span class="lineNum">    2275 </span>            :     MPI_Allgather(&amp;sloc,1,MPI_INT,scounts,1,MPI_INT,my_comm);
<span class="lineNum">    2276 </span>            : 
<span class="lineNum">    2277 </span>            :     int *first_rows=new int[nprocs];
<span class="lineNum">    2278 </span>            :     int frloc=matdist-&gt;first_row;
<span class="lineNum">    2279 </span>            :     MPI_Allgather(&amp;frloc,1,MPI_INT,first_rows,1,MPI_INT,my_comm);
<span class="lineNum">    2280 </span>            : 
<span class="lineNum">    2281 </span>            :     int rows_start;
<span class="lineNum">    2282 </span>            :     int rows_end;
<span class="lineNum">    2283 </span>            :     if (iam==root){
<span class="lineNum">    2284 </span>            :         rows_start=first_row;
<span class="lineNum">    2285 </span>            :         rows_end=first_row+size;
<span class="lineNum">    2286 </span>            :     }
<span class="lineNum">    2287 </span>            :     MPI_Bcast(&amp;rows_start,1,MPI_INT,root,my_comm);
<span class="lineNum">    2288 </span>            :     MPI_Bcast(&amp;rows_end,1,MPI_INT,root,my_comm);
<span class="lineNum">    2289 </span>            : 
<span class="lineNum">    2290 </span>            :     for (int IR=0;IR&lt;nprocs;IR++){
<span class="lineNum">    2291 </span>            :         int row=first_rows[IR];
<span class="lineNum">    2292 </span>            :         if (row&lt;rows_start || row&gt;=rows_end){
<span class="lineNum">    2293 </span>            :             scounts[IR]=0;
<span class="lineNum">    2294 </span>            :         }
<span class="lineNum">    2295 </span>            :     }
<span class="lineNum">    2296 </span>            : 
<span class="lineNum">    2297 </span>            :     int *displc=new int[nprocs];
<span class="lineNum">    2298 </span>            :     displc[0]=0;
<span class="lineNum">    2299 </span>            :     for (int IP=1;IP&lt;nprocs;IP++){
<span class="lineNum">    2300 </span>            :         displc[IP]=displc[IP-1]+scounts[IP-1];
<span class="lineNum">    2301 </span>            :     }
<span class="lineNum">    2302 </span>            : 
<span class="lineNum">    2303 </span>            :     MPI_Scatterv(nnz,scounts,displc,give_me_MPI_datatype(nnz),matdist-&gt;nnz,scounts[iam],give_me_MPI_datatype(nnz),root,my_comm);
<span class="lineNum">    2304 </span>            : 
<span class="lineNum">    2305 </span>            :     delete[] scounts;
<span class="lineNum">    2306 </span>            :     delete[] first_rows;
<span class="lineNum">    2307 </span>            :     delete[] displc;
<span class="lineNum">    2308 </span>            : }
<span class="lineNum">    2309 </span>            : 
<span class="lineNum">    2310 </span>            : /************************************************************************************************/
<span class="lineNum">    2311 </span>            : 
<span class="lineNum">    2312 </span>            : template &lt;class T&gt;
<span class="lineNum">    2313 </span>            : void TCSR&lt;T&gt;::reduce(int root,MPI_Comm my_comm)
<span class="lineNum">    2314 </span>            : {
<span class="lineNum">    2315 </span>            :     T *nnz_tmp=NULL;
<span class="lineNum">    2316 </span>            : 
<span class="lineNum">    2317 </span>            :     int iam,nprocs;
<span class="lineNum">    2318 </span>            :     MPI_Comm_size(my_comm,&amp;nprocs);
<span class="lineNum">    2319 </span>            :     MPI_Comm_rank(my_comm,&amp;iam);
<span class="lineNum">    2320 </span>            : 
<span class="lineNum">    2321 </span>            :     if (iam==root){
<span class="lineNum">    2322 </span>            :         nnz_tmp=new T[n_nonzeros];
<span class="lineNum">    2323 </span>            :     }
<span class="lineNum">    2324 </span>            : 
<span class="lineNum">    2325 </span>            :     if (n_nonzeros){
<span class="lineNum">    2326 </span>            :         MPI_Reduce(nnz,nnz_tmp,n_nonzeros,give_me_MPI_datatype(nnz),MPI_SUM,root,my_comm);
<span class="lineNum">    2327 </span>            :     }
<span class="lineNum">    2328 </span>            : 
<span class="lineNum">    2329 </span>            :     if (iam==root){
<span class="lineNum">    2330 </span>            :         c_tcopy(n_nonzeros,nnz_tmp,1,nnz,1);
<span class="lineNum">    2331 </span>            :         delete[] nnz_tmp;
<span class="lineNum">    2332 </span>            :     }
<span class="lineNum">    2333 </span>            : }
<span class="lineNum">    2334 </span>            : 
<span class="lineNum">    2335 </span>            : /************************************************************************************************/
<span class="lineNum">    2336 </span>            : 
<span class="lineNum">    2337 </span>            : template &lt;class T&gt;
<span class="lineNum">    2338 </span>            : void TCSR&lt;T&gt;::reducescatter(TCSR&lt;T&gt;*matdist,MPI_Comm my_comm)
<span class="lineNum">    2339 </span>            : {
<span class="lineNum">    2340 </span>            :     int iam,nprocs;
<span class="lineNum">    2341 </span>            :     MPI_Comm_size(my_comm,&amp;nprocs);
<span class="lineNum">    2342 </span>            :     MPI_Comm_rank(my_comm,&amp;iam);
<span class="lineNum">    2343 </span>            : 
<span class="lineNum">    2344 </span>            :     int *recvcounts=new int[nprocs];
<span class="lineNum">    2345 </span>            :     int recvloc=matdist-&gt;n_nonzeros;
<span class="lineNum">    2346 </span>            :     MPI_Allgather(&amp;recvloc,1,MPI_INT,recvcounts,1,MPI_INT,my_comm);
<span class="lineNum">    2347 </span>            : 
<span class="lineNum">    2348 </span>            :     MPI_Reduce_scatter(nnz,matdist-&gt;nnz,recvcounts,give_me_MPI_datatype(nnz),MPI_SUM,my_comm);
<span class="lineNum">    2349 </span>            : 
<span class="lineNum">    2350 </span>            :     delete[] recvcounts;
<span class="lineNum">    2351 </span>            : }
<span class="lineNum">    2352 </span>            : 
<span class="lineNum">    2353 </span>            : /************************************************************************************************/
<a name="2354"><span class="lineNum">    2354 </span>            : </a>
<span class="lineNum">    2355 </span>            : template &lt;class T&gt;
<span class="lineNum">    2356 </span><span class="lineCov">          2 : void TCSR&lt;T&gt;::distribute_back(cp2k_csr_interop_type&amp; cp2kCSRmat,MPI_Comm my_comm_in,int *sizes,int outsize,int cutoutl,int cutoutr,MPI_Comm my_comm_out)</span>
<span class="lineNum">    2357 </span>            : {
<span class="lineNum">    2358 </span>            :     int iam,insize;
<span class="lineNum">    2359 </span><span class="lineCov">          2 :     MPI_Comm_size(my_comm_in,&amp;insize);</span>
<span class="lineNum">    2360 </span><span class="lineCov">          2 :     MPI_Comm_rank(my_comm_in,&amp;iam);</span>
<span class="lineNum">    2361 </span>            :     int rank_my_comm_out;
<span class="lineNum">    2362 </span><span class="lineCov">          2 :     MPI_Comm_rank(my_comm_out,&amp;rank_my_comm_out);</span>
<span class="lineNum">    2363 </span>            :     MPI_Comm equal_rank_comm;
<span class="lineNum">    2364 </span><span class="lineCov">          2 :     MPI_Comm_split(my_comm_in,rank_my_comm_out,iam,&amp;equal_rank_comm);</span>
<span class="lineNum">    2365 </span><span class="lineCov">          2 :     MPI_Allreduce(MPI_IN_PLACE,nnz,n_nonzeros,give_me_MPI_datatype(nnz),MPI_SUM,equal_rank_comm);</span>
<span class="lineNum">    2366 </span><span class="lineCov">          2 :     MPI_Comm_free(&amp;equal_rank_comm);</span>
<span class="lineNum">    2367 </span>            : 
<span class="lineNum">    2368 </span><span class="lineCov">          2 :     int *frows_out = new int[outsize+1];</span>
<span class="lineNum">    2369 </span><span class="lineCov">          2 :     frows_out[0]=0;</span>
<span class="lineNum">    2370 </span><span class="lineCov">          6 :     for (int i=0;i&lt;outsize;i++) frows_out[i+1]=frows_out[i]+sizes[i];</span>
<span class="lineNum">    2371 </span><span class="lineCov">          2 :     int *displc_nnz  = new int[insize+1];</span>
<span class="lineNum">    2372 </span><span class="lineCov">          4 :     int *dist_nnz    = new int[insize];</span>
<span class="lineNum">    2373 </span>            : 
<span class="lineNum">    2374 </span><span class="lineCov">          6 :     for (int ir=0;ir&lt;outsize;ir++) {</span>
<span class="lineNum">    2375 </span><span class="lineCov">          2 :         int displc_size=cp2kCSRmat.first_row-cutoutl-frows_out[ir];</span>
<span class="lineNum">    2376 </span><span class="lineCov">          2 :         if (displc_size&lt;0)         displc_size=0;</span>
<span class="lineNum">    2377 </span><span class="lineCov">          2 :         if (displc_size&gt;sizes[ir]) displc_size=sizes[ir];</span>
<span class="lineNum">    2378 </span><span class="lineCov">          2 :         int displc_size_next=cp2kCSRmat.first_row+cp2kCSRmat.nrows_local-cutoutl-frows_out[ir];</span>
<span class="lineNum">    2379 </span><span class="lineCov">          2 :         if (displc_size_next&lt;0)         displc_size_next=0;</span>
<span class="lineNum">    2380 </span><span class="lineCov">          2 :         if (displc_size_next&gt;sizes[ir]) displc_size_next=sizes[ir];</span>
<span class="lineNum">    2381 </span><span class="lineCov">          2 :         int dist_size=displc_size_next-displc_size;</span>
<span class="lineNum">    2382 </span><span class="lineCov">          2 :         int start_size=0;</span>
<span class="lineNum">    2383 </span><span class="lineCov">          2 :         int end_size=cp2kCSRmat.nrows_local;</span>
<span class="lineNum">    2384 </span><span class="lineCov">          2 :         if (displc_size==0 &amp;&amp; dist_size&gt;0) start_size=cutoutl+frows_out[ir]-cp2kCSRmat.first_row;</span>
<span class="lineNum">    2385 </span><span class="lineCov">          2 :         if (displc_size==sizes[ir]-dist_size &amp;&amp; dist_size&gt;0) end_size=start_size+dist_size;</span>
<span class="lineNum">    2386 </span><span class="lineCov">          2 :         int dist_nnz_local=0;</span>
<span class="lineNum">    2387 </span><span class="lineCov">          2 :         if (dist_size&gt;0) dist_nnz_local=cp2kCSRmat.rowptr_local[end_size]-cp2kCSRmat.rowptr_local[start_size];</span>
<span class="lineNum">    2388 </span><span class="lineCov">          2 :         int start_nnz=cp2kCSRmat.rowptr_local[start_size]-1;</span>
<span class="lineNum">    2389 </span><span class="lineCov">          2 :         MPI_Allgather(&amp;dist_nnz_local,1,MPI_INT,dist_nnz,1,MPI_INT,my_comm_in);</span>
<span class="lineNum">    2390 </span><span class="lineCov">          2 :         displc_nnz[0]=0;</span>
<span class="lineNum">    2391 </span><span class="lineCov">          6 :         for (int i=0;i&lt;insize;i++) {</span>
<span class="lineNum">    2392 </span><span class="lineCov">          4 :             displc_nnz[i+1]=displc_nnz[i]+dist_nnz[i];</span>
<span class="lineNum">    2393 </span>            :         }
<span class="lineNum">    2394 </span><span class="lineCov">          2 :         MPI_Scatterv(nnz,dist_nnz,displc_nnz,give_me_MPI_datatype(nnz),&amp;cp2kCSRmat.nzvals_local[start_nnz],dist_nnz[iam],give_me_MPI_datatype(nnz),ir,my_comm_in);</span>
<span class="lineNum">    2395 </span>            :     }
<span class="lineNum">    2396 </span>            : 
<span class="lineNum">    2397 </span><span class="lineCov">          2 :     delete[] frows_out;</span>
<span class="lineNum">    2398 </span><span class="lineCov">          2 :     delete[] displc_nnz;</span>
<span class="lineNum">    2399 </span><span class="lineCov">          2 :     delete[] dist_nnz;</span>
<span class="lineNum">    2400 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    2401 </span>            : 
<span class="lineNum">    2402 </span>            : /************************************************************************************************/
<span class="lineNum">    2403 </span>            : 
<span class="lineNum">    2404 </span>            : template &lt;&gt;
<span class="lineNum">    2405 </span>            : inline void TCSR&lt;double&gt;::psipsidagger(CPX* psi,int nkval,CPX factor)
<span class="lineNum">    2406 </span>            : {
<span class="lineNum">    2407 </span>            :     int i,e;
<span class="lineNum">    2408 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2409 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2410 </span>            :             nnz[e]+=real(factor*c_zdotc(nkval,&amp;psi[index_j[e]-findx],size_tot,&amp;psi[first_row+i],size_tot));
<span class="lineNum">    2411 </span>            :         }
<span class="lineNum">    2412 </span>            :     }
<span class="lineNum">    2413 </span>            : }
<span class="lineNum">    2414 </span>            : 
<span class="lineNum">    2415 </span>            : /************************************************************************************************/
<span class="lineNum">    2416 </span>            : 
<span class="lineNum">    2417 </span>            : template &lt;&gt;
<span class="lineNum">    2418 </span>            : inline void TCSR&lt;double&gt;::psipsidagger(double* psi,int nkval,double factor)
<span class="lineNum">    2419 </span>            : {
<span class="lineNum">    2420 </span>            :     int i,e;
<span class="lineNum">    2421 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2422 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2423 </span>            :             nnz[e]+=factor*c_ddot(nkval,&amp;psi[index_j[e]-findx],size_tot,&amp;psi[first_row+i],size_tot);
<span class="lineNum">    2424 </span>            :         }
<span class="lineNum">    2425 </span>            :     }
<span class="lineNum">    2426 </span>            : }
<span class="lineNum">    2427 </span>            : 
<span class="lineNum">    2428 </span>            : /************************************************************************************************/
<span class="lineNum">    2429 </span>            : 
<span class="lineNum">    2430 </span>            : template &lt;&gt;
<span class="lineNum">    2431 </span>            : inline void TCSR&lt;double&gt;::psipsidagger_transpose(CPX* psi,int nkval,CPX factor)
<span class="lineNum">    2432 </span>            : {
<span class="lineNum">    2433 </span>            :     int i,e;
<span class="lineNum">    2434 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2435 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2436 </span>            :             nnz[e]+=real(factor*c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1));
<span class="lineNum">    2437 </span>            :         }
<span class="lineNum">    2438 </span>            :     }
<span class="lineNum">    2439 </span>            : }
<span class="lineNum">    2440 </span>            : 
<span class="lineNum">    2441 </span>            : /************************************************************************************************/
<span class="lineNum">    2442 </span>            : 
<span class="lineNum">    2443 </span>            : template &lt;&gt;
<span class="lineNum">    2444 </span><span class="lineNoCov">          0 : inline void TCSR&lt;double&gt;::psipsidagger_transpose(CPX* psi_loc,CPX* psi,int nkval,CPX factor)</span>
<span class="lineNum">    2445 </span>            : {
<span class="lineNum">    2446 </span>            :     int i,e;
<span class="lineNum">    2447 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2448 </span><span class="lineNoCov">          0 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2449 </span><span class="lineNoCov">          0 :             nnz[e]+=real(factor*c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi_loc[i*nkval],1));</span>
<span class="lineNum">    2450 </span>            :         }
<span class="lineNum">    2451 </span>            :     }
<span class="lineNum">    2452 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2453 </span>            : 
<span class="lineNum">    2454 </span>            : /************************************************************************************************/
<span class="lineNum">    2455 </span>            : 
<span class="lineNum">    2456 </span>            : template &lt;&gt;
<span class="lineNum">    2457 </span>            : inline double TCSR&lt;double&gt;::psipsidagger_transpose(TCSR&lt;double&gt;* matS,TCSR&lt;double&gt;* matI,CPX* psi,int nkval,CPX factor)
<span class="lineNum">    2458 </span>            : {
<span class="lineNum">    2459 </span>            :     int i,e;
<span class="lineNum">    2460 </span>            :     CPX z;
<span class="lineNum">    2461 </span>            :     double result=0.0;
<span class="lineNum">    2462 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2463 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2464 </span>            :             z=c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);
<span class="lineNum">    2465 </span>            :             result+=matS-&gt;nnz[e]*real(z);
<span class="lineNum">    2466 </span>            :             nnz[e]+=real(factor*z);
<span class="lineNum">    2467 </span>            :             matI-&gt;nnz[e]+=imag(factor*z);
<span class="lineNum">    2468 </span>            :         }
<span class="lineNum">    2469 </span>            :     }
<span class="lineNum">    2470 </span>            :     return result;
<span class="lineNum">    2471 </span>            : }
<span class="lineNum">    2472 </span>            : 
<span class="lineNum">    2473 </span>            : /************************************************************************************************/
<span class="lineNum">    2474 </span>            : 
<span class="lineNum">    2475 </span>            : template &lt;&gt;
<span class="lineNum">    2476 </span><span class="lineCov">          2 : inline void TCSR&lt;double&gt;::psipsidagger_transpose(TCSR&lt;double&gt;* matS,double* dosprofile,int* n_of_el,TCSR&lt;double&gt;* matI,CPX* psi,int nkval,CPX factor,MPI_Comm matrix_comm)</span>
<span class="lineNum">    2477 </span>            : {
<span class="lineNum">    2478 </span>            :     int i,e;
<span class="lineNum">    2479 </span><span class="lineCov">          2 :     CPX z;</span>
<span class="lineNum">    2480 </span><span class="lineCov">          2 :     int* atom_of_bf=new int[size_tot];</span>
<span class="lineNum">    2481 </span>            :     int atom=0;
<span class="lineNum">    2482 </span><span class="lineCov">       4610 :     for (int i=0;i&lt;size_tot;i++) {</span>
<span class="lineNum">    2483 </span><span class="lineCov">       2304 :         if (i==n_of_el[atom+1]) ++atom;</span>
<span class="lineNum">    2484 </span><span class="lineCov">       2304 :         atom_of_bf[i]=atom;</span>
<span class="lineNum">    2485 </span>            :     }
<span class="lineNum">    2486 </span><span class="lineCov">          2 :     ++atom;</span>
<span class="lineNum">    2487 </span><span class="lineCov">          2 :     init_variable(dosprofile,atom);</span>
<span class="lineNum">    2488 </span><span class="lineCov">       4610 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2489 </span><span class="lineCov">     545024 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2490 </span><span class="lineCov">     542720 :             z=c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);</span>
<span class="lineNum">    2491 </span><span class="lineCov">    1085440 :             nnz[e]+=real(factor*z);</span>
<span class="lineNum">    2492 </span><span class="lineCov">    1085440 :             matI-&gt;nnz[e]+=imag(factor*z);</span>
<span class="lineNum">    2493 </span><span class="lineCov">    1085440 :             dosprofile[atom_of_bf[first_row+i]]+=matS-&gt;nnz[e]*real(z);</span>
<span class="lineNum">    2494 </span>            :         }
<span class="lineNum">    2495 </span>            :     }
<span class="lineNum">    2496 </span><span class="lineCov">          2 :     delete[] atom_of_bf;</span>
<span class="lineNum">    2497 </span><span class="lineCov">          2 :     MPI_Allreduce(MPI_IN_PLACE,dosprofile,atom,MPI_DOUBLE,MPI_SUM,matrix_comm);</span>
<span class="lineNum">    2498 </span><span class="lineCov">          2 : }</span>
<span class="lineNum">    2499 </span>            : 
<span class="lineNum">    2500 </span>            : /************************************************************************************************/
<span class="lineNum">    2501 </span>            : 
<span class="lineNum">    2502 </span>            : template &lt;&gt;
<span class="lineNum">    2503 </span><span class="lineNoCov">          0 : inline void TCSR&lt;double&gt;::psipsidagger_transpose(double* dosprofile,CPX* psi,int nkval,MPI_Comm matrix_comm)</span>
<span class="lineNum">    2504 </span>            : {
<span class="lineNum">    2505 </span>            :     int i,e;
<span class="lineNum">    2506 </span><span class="lineNoCov">          0 :     CPX z;</span>
<span class="lineNum">    2507 </span><span class="lineNoCov">          0 :     init_variable(dosprofile,size_tot);</span>
<span class="lineNum">    2508 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2509 </span><span class="lineNoCov">          0 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2510 </span><span class="lineNoCov">          0 :             z=c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);</span>
<span class="lineNum">    2511 </span><span class="lineNoCov">          0 :             dosprofile[first_row+i]+=nnz[e]*real(z);</span>
<span class="lineNum">    2512 </span>            :         }
<span class="lineNum">    2513 </span>            :     }
<span class="lineNum">    2514 </span><span class="lineNoCov">          0 :     MPI_Allreduce(MPI_IN_PLACE,dosprofile,size_tot,MPI_DOUBLE,MPI_SUM,matrix_comm);</span>
<span class="lineNum">    2515 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2516 </span>            : 
<span class="lineNum">    2517 </span>            : /************************************************************************************************/
<span class="lineNum">    2518 </span>            : 
<span class="lineNum">    2519 </span>            : template &lt;&gt;
<span class="lineNum">    2520 </span>            : inline void TCSR&lt;double&gt;::psipsidagger_transpose(double* psi,int nkval,double factor)
<span class="lineNum">    2521 </span>            : {
<span class="lineNum">    2522 </span>            :     int i,e;
<span class="lineNum">    2523 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2524 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2525 </span>            :             nnz[e]+=factor*c_ddot(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);
<span class="lineNum">    2526 </span>            :         }
<span class="lineNum">    2527 </span>            :     }
<span class="lineNum">    2528 </span>            : }
<span class="lineNum">    2529 </span>            : 
<span class="lineNum">    2530 </span>            : /************************************************************************************************/
<span class="lineNum">    2531 </span>            : 
<span class="lineNum">    2532 </span>            : template &lt;&gt;
<span class="lineNum">    2533 </span>            : inline double TCSR&lt;double&gt;::psipsidagger(TCSR&lt;double&gt;* mat,CPX* psi,CPX* psil,CPX* psir,int nkval,int ndof,int bw,CPX factor)
<span class="lineNum">    2534 </span>            : {
<span class="lineNum">    2535 </span>            :     int i,e;
<span class="lineNum">    2536 </span>            :     CPX z;
<span class="lineNum">    2537 </span>            :     double result=0.0;
<span class="lineNum">    2538 </span>            :     for(i=0;i&lt;size;i++) {
<span class="lineNum">    2539 </span>            :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2540 </span>            :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &gt; bw ) {
<span class="lineNum">    2541 </span>            :                 z=c_zdotc(nkval,&amp;psil[index_j[e]-findx],size_tot,&amp;psi[first_row+i],size_tot);
<span class="lineNum">    2542 </span>            :             } else if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &lt; -bw ) {
<span class="lineNum">    2543 </span>            :                 z=c_zdotc(nkval,&amp;psir[index_j[e]-findx],size_tot,&amp;psi[first_row+i],size_tot);
<span class="lineNum">    2544 </span>            :             } else {
<span class="lineNum">    2545 </span>            :                 z=c_zdotc(nkval,&amp;psi[index_j[e]-findx],size_tot,&amp;psi[first_row+i],size_tot);
<span class="lineNum">    2546 </span>            :             }
<span class="lineNum">    2547 </span>            :             result+=mat-&gt;nnz[e]*real(z);
<span class="lineNum">    2548 </span>            :             nnz[e]+=real(factor*z);
<span class="lineNum">    2549 </span>            :         }
<span class="lineNum">    2550 </span>            :     }
<span class="lineNum">    2551 </span>            :     return result;
<span class="lineNum">    2552 </span>            : }
<span class="lineNum">    2553 </span>            : 
<span class="lineNum">    2554 </span>            : /************************************************************************************************/
<span class="lineNum">    2555 </span>            : 
<span class="lineNum">    2556 </span>            : template &lt;&gt;
<span class="lineNum">    2557 </span><span class="lineNoCov">          0 : inline double TCSR&lt;double&gt;::psipsidagger_transpose(TCSR&lt;double&gt;* mat,CPX* psi,CPX* psil,CPX* psir,int nkval,int ndof,int bw,CPX factor)</span>
<span class="lineNum">    2558 </span>            : {
<span class="lineNum">    2559 </span>            :     int i,e;
<span class="lineNum">    2560 </span><span class="lineNoCov">          0 :     CPX z;</span>
<span class="lineNum">    2561 </span><span class="lineNoCov">          0 :     double result=0.0;</span>
<span class="lineNum">    2562 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;size;i++) {</span>
<span class="lineNum">    2563 </span><span class="lineNoCov">          0 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {</span>
<span class="lineNum">    2564 </span><span class="lineNoCov">          0 :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &gt; bw ) {</span>
<span class="lineNum">    2565 </span><span class="lineNoCov">          0 :                 z=c_zdotc(nkval,&amp;psil[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);</span>
<span class="lineNum">    2566 </span><span class="lineNoCov">          0 :             } else if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &lt; -bw ) {</span>
<span class="lineNum">    2567 </span><span class="lineNoCov">          0 :                 z=c_zdotc(nkval,&amp;psir[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);</span>
<span class="lineNum">    2568 </span>            :             } else {
<span class="lineNum">    2569 </span><span class="lineNoCov">          0 :                 z=c_zdotc(nkval,&amp;psi[(index_j[e]-findx)*nkval],1,&amp;psi[(first_row+i)*nkval],1);</span>
<span class="lineNum">    2570 </span>            :             }
<span class="lineNum">    2571 </span><span class="lineNoCov">          0 :             result+=mat-&gt;nnz[e]*real(z);</span>
<span class="lineNum">    2572 </span><span class="lineNoCov">          0 :             nnz[e]+=real(factor*z);</span>
<span class="lineNum">    2573 </span>            :         }
<span class="lineNum">    2574 </span>            :     }
<span class="lineNum">    2575 </span><span class="lineNoCov">          0 :     return result;</span>
<span class="lineNum">    2576 </span>            : }
<span class="lineNum">    2577 </span>            : 
<span class="lineNum">    2578 </span>            : /************************************************************************************************/
<a name="2579"><span class="lineNum">    2579 </span>            : </a>
<span class="lineNum">    2580 </span>            : template &lt;class T&gt;
<span class="lineNum">    2581 </span><span class="lineNoCov">          0 : void TCSR&lt;T&gt;::atom_allocate(TCSR&lt;T&gt;* mat,int* n_of_el,T* result,T factor)</span>
<span class="lineNum">    2582 </span>            : {
<span class="lineNum">    2583 </span>            :     int i,e;
<span class="lineNum">    2584 </span><span class="lineNoCov">          0 :     int* atom_of_bf=new int[size_tot];</span>
<span class="lineNum">    2585 </span><span class="lineNoCov">          0 :     int atom=0;</span>
<span class="lineNum">    2586 </span><span class="lineNoCov">          0 :     for (i=0;i&lt;size_tot;i++) {</span>
<span class="lineNum">    2587 </span><span class="lineNoCov">          0 :         if (i==n_of_el[atom+1]) ++atom;</span>
<span class="lineNum">    2588 </span><span class="lineNoCov">          0 :         atom_of_bf[i]=atom;</span>
<span class="lineNum">    2589 </span>            :     }
<span class="lineNum">    2590 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2591 </span><span class="lineNoCov">          0 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2592 </span><span class="lineNoCov">          0 :             result[atom_of_bf[first_row+i]]+=factor*nnz[e]*mat-&gt;nnz[e];</span>
<span class="lineNum">    2593 </span>            :         }
<span class="lineNum">    2594 </span>            :     }
<span class="lineNum">    2595 </span><span class="lineNoCov">          0 :     delete[] atom_of_bf;</span>
<span class="lineNum">    2596 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2597 </span>            : 
<span class="lineNum">    2598 </span>            : /************************************************************************************************/
<span class="lineNum">    2599 </span>            : 
<span class="lineNum">    2600 </span>            : template &lt;class T&gt;
<span class="lineNum">    2601 </span>            : void TCSR&lt;T&gt;::settozeropbc(int bw, int ndof)
<span class="lineNum">    2602 </span>            : {
<span class="lineNum">    2603 </span>            :     int i,e;
<span class="lineNum">    2604 </span>            :     T zero=(T)0;
<span class="lineNum">    2605 </span>            : 
<span class="lineNum">    2606 </span>            :     for (i=0;i&lt;max(0,min(size,bw*ndof-first_row));i++) {
<span class="lineNum">    2607 </span>            :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2608 </span>            :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &gt; bw ) {
<span class="lineNum">    2609 </span>            :                 nnz[e]=zero;
<span class="lineNum">    2610 </span>            :             }
<span class="lineNum">    2611 </span>            :         }
<span class="lineNum">    2612 </span>            :     }
<span class="lineNum">    2613 </span>            : 
<span class="lineNum">    2614 </span>            :     for (i=max(0,min(size,size_tot-bw*ndof-first_row));i&lt;size;i++) {
<span class="lineNum">    2615 </span>            :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {
<span class="lineNum">    2616 </span>            :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &lt; -bw ) {
<span class="lineNum">    2617 </span>            :                 nnz[e]=zero;
<span class="lineNum">    2618 </span>            :             }
<span class="lineNum">    2619 </span>            :         }
<span class="lineNum">    2620 </span>            :     }
<span class="lineNum">    2621 </span>            : }
<span class="lineNum">    2622 </span>            : 
<span class="lineNum">    2623 </span>            : /************************************************************************************************/
<a name="2624"><span class="lineNum">    2624 </span>            : </a>
<span class="lineNum">    2625 </span>            : template &lt;class T&gt;
<span class="lineNum">    2626 </span><span class="lineCov">          1 : void TCSR&lt;T&gt;::removepbc(int bw, int ndof)</span>
<span class="lineNum">    2627 </span>            : {
<span class="lineNum">    2628 </span>            :     int i,e;
<span class="lineNum">    2629 </span>            : 
<span class="lineNum">    2630 </span><span class="lineCov">        651 :     for (i=0;i&lt;max(0,min(size,bw*ndof-first_row));i++) {</span>
<span class="lineNum">    2631 </span><span class="lineCov">      51096 :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {</span>
<span class="lineNum">    2632 </span><span class="lineCov">      50880 :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &gt; bw ) {</span>
<span class="lineNum">    2633 </span><span class="lineCov">       9046 :                 index_j[e]=-1;</span>
<span class="lineNum">    2634 </span>            :             }
<span class="lineNum">    2635 </span>            :         }
<span class="lineNum">    2636 </span>            :     }
<span class="lineNum">    2637 </span>            : 
<span class="lineNum">    2638 </span><span class="lineCov">        219 :     for (i=max(0,min(size,size_tot-bw*ndof-first_row));i&lt;size;i++) {</span>
<span class="lineNum">    2639 </span><span class="lineCov">      51096 :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++) {</span>
<span class="lineNum">    2640 </span><span class="lineCov">      50880 :             if ( (index_j[e]-findx)/ndof - (i+first_row)/ndof &lt; -bw ) {</span>
<span class="lineNum">    2641 </span><span class="lineCov">       9046 :                 index_j[e]=-1;</span>
<span class="lineNum">    2642 </span>            :             }
<span class="lineNum">    2643 </span>            :         }
<span class="lineNum">    2644 </span>            :     }
<span class="lineNum">    2645 </span>            : 
<span class="lineNum">    2646 </span><span class="lineCov">          1 :     n_nonzeros = 0;</span>
<span class="lineNum">    2647 </span><span class="lineCov">          1 :     init_variable(index_i,size);</span>
<span class="lineNum">    2648 </span>            : 
<span class="lineNum">    2649 </span><span class="lineCov">       2305 :     for (int i=0;i&lt;size;i++) {</span>
<span class="lineNum">    2650 </span><span class="lineCov">     272512 :         for(int e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2651 </span><span class="lineCov">     271360 :             if(index_j[e]&gt;=0){</span>
<span class="lineNum">    2652 </span><span class="lineCov">     253268 :                 index_i[i]++;</span>
<span class="lineNum">    2653 </span><span class="lineCov">     253268 :                 index_j[n_nonzeros]=index_j[e];</span>
<span class="lineNum">    2654 </span><span class="lineCov">     253268 :                 nnz[n_nonzeros]=nnz[e];</span>
<span class="lineNum">    2655 </span><span class="lineCov">     253268 :                 n_nonzeros++;</span>
<span class="lineNum">    2656 </span>            :             }
<span class="lineNum">    2657 </span>            :         }
<span class="lineNum">    2658 </span>            :     }
<span class="lineNum">    2659 </span>            : 
<span class="lineNum">    2660 </span><span class="lineCov">          1 :     get_row_edge();</span>
<span class="lineNum">    2661 </span><span class="lineCov">          1 :     get_diag_pos();</span>
<span class="lineNum">    2662 </span>            : 
<span class="lineNum">    2663 </span><span class="lineCov">          1 :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);</span>
<span class="lineNum">    2664 </span><span class="lineCov">          1 : }</span>
<span class="lineNum">    2665 </span>            : 
<span class="lineNum">    2666 </span>            : /************************************************************************************************/
<span class="lineNum">    2667 </span>            : 
<span class="lineNum">    2668 </span>            : template &lt;class T&gt;
<span class="lineNum">    2669 </span>            : void TCSR&lt;T&gt;::tr_full_to_sparse(T *B,int nrow,int ncol)
<span class="lineNum">    2670 </span>            : {
<span class="lineNum">    2671 </span>            :     int i,j;
<span class="lineNum">    2672 </span>            : 
<span class="lineNum">    2673 </span>            :     size       = nrow;
<span class="lineNum">    2674 </span>            :     n_nonzeros = 0;
<span class="lineNum">    2675 </span>            : 
<span class="lineNum">    2676 </span>            :     for(i=0;i&lt;nrow;i++){
<span class="lineNum">    2677 </span>            : 
<span class="lineNum">    2678 </span>            :         index_i[i] = 0;
<span class="lineNum">    2679 </span>            : 
<span class="lineNum">    2680 </span>            :         for(j=0;j&lt;ncol;j++){
<span class="lineNum">    2681 </span>            : 
<span class="lineNum">    2682 </span>            :             if(abs(B[i+j*nrow])&gt;tollim){
<span class="lineNum">    2683 </span>            : 
<span class="lineNum">    2684 </span>            :                 index_j[n_nonzeros] = j+findx;
<span class="lineNum">    2685 </span>            :                 nnz[n_nonzeros]     = B[i*nrow+j];
<span class="lineNum">    2686 </span>            : 
<span class="lineNum">    2687 </span>            :                 index_i[i]++;
<span class="lineNum">    2688 </span>            :                 n_nonzeros++;
<span class="lineNum">    2689 </span>            :             }
<span class="lineNum">    2690 </span>            :         }
<span class="lineNum">    2691 </span>            :     }
<span class="lineNum">    2692 </span>            :     get_row_edge();
<span class="lineNum">    2693 </span>            :     get_diag_pos();
<span class="lineNum">    2694 </span>            : }
<span class="lineNum">    2695 </span>            : 
<span class="lineNum">    2696 </span>            : /************************************************************************************************/
<span class="lineNum">    2697 </span>            : 
<span class="lineNum">    2698 </span>            : template &lt;class T&gt;
<span class="lineNum">    2699 </span>            : void TCSR&lt;T&gt;::extract_lower_triangle(TCSR&lt;T&gt; *mat)
<span class="lineNum">    2700 </span>            : {
<span class="lineNum">    2701 </span>            :     findx=mat-&gt;findx;
<span class="lineNum">    2702 </span>            :     int i,e;
<span class="lineNum">    2703 </span>            :     n_nonzeros=0;
<span class="lineNum">    2704 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2705 </span>            :         index_i[i]=0;
<span class="lineNum">    2706 </span>            :         for(e=mat-&gt;edge_i[i]-mat-&gt;findx;e&lt;mat-&gt;edge_i[i+1]-mat-&gt;findx;e++){
<span class="lineNum">    2707 </span>            :             if(mat-&gt;index_j[e]-mat-&gt;findx&lt;=i){
<span class="lineNum">    2708 </span>            :                 index_i[i]++;
<span class="lineNum">    2709 </span>            :                 index_j[n_nonzeros]=mat-&gt;index_j[e];
<span class="lineNum">    2710 </span>            :                 nnz[n_nonzeros]=mat-&gt;nnz[e];
<span class="lineNum">    2711 </span>            :                 n_nonzeros++;
<span class="lineNum">    2712 </span>            :             }
<span class="lineNum">    2713 </span>            :         }
<span class="lineNum">    2714 </span>            :     }
<span class="lineNum">    2715 </span>            :     get_row_edge();
<span class="lineNum">    2716 </span>            :     get_diag_pos();
<span class="lineNum">    2717 </span>            : 
<span class="lineNum">    2718 </span>            :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2719 </span>            : }
<span class="lineNum">    2720 </span>            : 
<span class="lineNum">    2721 </span>            : /************************************************************************************************/
<span class="lineNum">    2722 </span>            : 
<span class="lineNum">    2723 </span>            : template &lt;class T&gt;
<span class="lineNum">    2724 </span>            : void TCSR&lt;T&gt;::extract_upper_triangle(TCSR&lt;T&gt; *mat)
<span class="lineNum">    2725 </span>            : {
<span class="lineNum">    2726 </span>            :     findx=mat-&gt;findx;
<span class="lineNum">    2727 </span>            :     int i,e;
<span class="lineNum">    2728 </span>            :     n_nonzeros=0;
<span class="lineNum">    2729 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2730 </span>            :         index_i[i]=0;
<span class="lineNum">    2731 </span>            :         for(e=mat-&gt;edge_i[i]-mat-&gt;findx;e&lt;mat-&gt;edge_i[i+1]-mat-&gt;findx;e++){
<span class="lineNum">    2732 </span>            :             if(mat-&gt;index_j[e]-mat-&gt;findx&gt;=i){
<span class="lineNum">    2733 </span>            :                 index_i[i]++;
<span class="lineNum">    2734 </span>            :                 index_j[n_nonzeros]=mat-&gt;index_j[e];
<span class="lineNum">    2735 </span>            :                 nnz[n_nonzeros]=mat-&gt;nnz[e];
<span class="lineNum">    2736 </span>            :                 n_nonzeros++;
<span class="lineNum">    2737 </span>            :             }
<span class="lineNum">    2738 </span>            :         }
<span class="lineNum">    2739 </span>            :     }
<span class="lineNum">    2740 </span>            :     get_row_edge();
<span class="lineNum">    2741 </span>            :     get_diag_pos();
<span class="lineNum">    2742 </span>            : 
<span class="lineNum">    2743 </span>            :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2744 </span>            : }
<span class="lineNum">    2745 </span>            : 
<span class="lineNum">    2746 </span>            : /************************************************************************************************/
<span class="lineNum">    2747 </span>            : 
<span class="lineNum">    2748 </span>            : template &lt;class T&gt;
<span class="lineNum">    2749 </span><span class="lineCov">          4 : void TCSR&lt;T&gt;::full_to_sparse(T *B,int nrow,int ncol,int ipos,int jpos)</span>
<span class="lineNum">    2750 </span>            : {
<span class="lineNum">    2751 </span>            :     int i,j;
<span class="lineNum">    2752 </span>            : 
<span class="lineNum">    2753 </span><span class="lineCov">          4 :     n_nonzeros = 0;</span>
<span class="lineNum">    2754 </span><span class="lineCov">          8 :     init_variable(index_i,size);</span>
<span class="lineNum">    2755 </span>            : 
<span class="lineNum">    2756 </span><span class="lineCov">          8 :     int imax=min(ipos+nrow,size)-ipos;    </span>
<span class="lineNum">    2757 </span><span class="lineCov">        868 :     for(i=0;i&lt;imax;i++){</span>
<span class="lineNum">    2758 </span>            : 
<span class="lineNum">    2759 </span><span class="lineCov">     189216 :         for(j=0;j&lt;ncol;j++){</span>
<span class="lineNum">    2760 </span>            : 
<span class="lineNum">    2761 </span><span class="lineCov">     188352 :             if(abs(B[i+j*nrow])&gt;tollim){</span>
<span class="lineNum">    2762 </span>            : 
<span class="lineNum">    2763 </span><span class="lineCov">      40222 :                 index_j[n_nonzeros] = jpos+j+findx;</span>
<span class="lineNum">    2764 </span><span class="lineCov">      40222 :                 nnz[n_nonzeros]     = B[i+j*nrow];</span>
<span class="lineNum">    2765 </span>            : 
<span class="lineNum">    2766 </span><span class="lineCov">      40222 :                 index_i[i+ipos]++;</span>
<span class="lineNum">    2767 </span><span class="lineCov">      40222 :                 n_nonzeros++;</span>
<span class="lineNum">    2768 </span>            :             }
<span class="lineNum">    2769 </span>            :         }
<span class="lineNum">    2770 </span>            :     }
<span class="lineNum">    2771 </span><span class="lineCov">          4 :     get_row_edge();</span>
<span class="lineNum">    2772 </span><span class="lineCov">          4 :     get_diag_pos();</span>
<span class="lineNum">    2773 </span><span class="lineCov">          4 : }</span>
<span class="lineNum">    2774 </span>            : 
<span class="lineNum">    2775 </span>            : /************************************************************************************************/
<a name="2776"><span class="lineNum">    2776 </span>            : </a>
<span class="lineNum">    2777 </span>            : template &lt;class T&gt;
<span class="lineNum">    2778 </span><span class="lineCov">         32 : void TCSR&lt;T&gt;::sparse_transpose(TCSR&lt;T&gt; *mat)</span>
<span class="lineNum">    2779 </span>            : {
<span class="lineNum">    2780 </span>            :     int i, j, e;
<span class="lineNum">    2781 </span><span class="lineCov">         32 :     int fin  = mat-&gt;findx;</span>
<span class="lineNum">    2782 </span><span class="lineCov">         32 :     int fout = findx;</span>
<span class="lineNum">    2783 </span>            : 
<span class="lineNum">    2784 </span><span class="lineCov">         32 :     n_nonzeros = mat-&gt;n_nonzeros;</span>
<span class="lineNum">    2785 </span>            :     
<span class="lineNum">    2786 </span><span class="lineCov">         32 :     init_variable(index_i,size);</span>
<span class="lineNum">    2787 </span><span class="lineCov">       5216 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2788 </span><span class="lineCov">      83004 :         for(e=mat-&gt;edge_i[i]-fin;e&lt;mat-&gt;edge_i[i+1]-fin;e++){</span>
<span class="lineNum">    2789 </span><span class="lineCov">      80412 :             index_i[mat-&gt;index_j[e]-fin]++;</span>
<span class="lineNum">    2790 </span>            :         }
<span class="lineNum">    2791 </span>            :     }
<span class="lineNum">    2792 </span><span class="lineCov">         32 :     get_row_edge();</span>
<span class="lineNum">    2793 </span>            : 
<span class="lineNum">    2794 </span><span class="lineCov">         32 :     int *ptr = new int[size];</span>
<span class="lineNum">    2795 </span><span class="lineCov">       5248 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2796 </span><span class="lineCov">       2592 :         ptr[i] = edge_i[i] - fout;</span>
<span class="lineNum">    2797 </span>            :     }
<span class="lineNum">    2798 </span>            :     
<span class="lineNum">    2799 </span><span class="lineCov">       5216 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2800 </span><span class="lineCov">      83004 :         for(e=mat-&gt;edge_i[i]-fin;e&lt;mat-&gt;edge_i[i+1]-fin;e++){</span>
<span class="lineNum">    2801 </span><span class="lineCov">      80412 :             j = mat-&gt;index_j[e]-fin;</span>
<span class="lineNum">    2802 </span><span class="lineCov">      80412 :             index_j[ptr[j]] = i + fout;</span>
<span class="lineNum">    2803 </span><span class="lineCov">      80412 :             nnz[ptr[j]] = mat-&gt;nnz[e];</span>
<span class="lineNum">    2804 </span><span class="lineCov">      80412 :             ptr[j]++;</span>
<span class="lineNum">    2805 </span>            :         }
<span class="lineNum">    2806 </span>            :     }
<span class="lineNum">    2807 </span>            : 
<span class="lineNum">    2808 </span><span class="lineCov">         32 :     delete[] ptr;</span>
<span class="lineNum">    2809 </span>            : 
<span class="lineNum">    2810 </span><span class="lineCov">         32 :     get_diag_pos();</span>
<span class="lineNum">    2811 </span><span class="lineCov">         32 : }</span>
<span class="lineNum">    2812 </span>            : 
<span class="lineNum">    2813 </span>            : /************************************************************************************************/
<span class="lineNum">    2814 </span>            : 
<span class="lineNum">    2815 </span>            : template &lt;class T&gt;
<span class="lineNum">    2816 </span>            : void TCSR&lt;T&gt;::set_to_id()
<span class="lineNum">    2817 </span>            : {
<span class="lineNum">    2818 </span>            :     n_nonzeros=size;
<span class="lineNum">    2819 </span>            :     for (int i=0;i&lt;size;i++) {
<span class="lineNum">    2820 </span>            :         nnz[i]=1.0;
<span class="lineNum">    2821 </span>            :         index_i[i]=1;
<span class="lineNum">    2822 </span>            :         index_j[i]=first_row+findx+i;
<span class="lineNum">    2823 </span>            :     }
<span class="lineNum">    2824 </span>            : 
<span class="lineNum">    2825 </span>            :     get_row_edge();
<span class="lineNum">    2826 </span>            :     get_diag_pos();
<span class="lineNum">    2827 </span>            : }
<span class="lineNum">    2828 </span>            : 
<span class="lineNum">    2829 </span>            : /************************************************************************************************/
<span class="lineNum">    2830 </span>            : 
<span class="lineNum">    2831 </span>            : template &lt;class T&gt;
<span class="lineNum">    2832 </span>            : void TCSR&lt;T&gt;::remove_thr(double thr)
<span class="lineNum">    2833 </span>            : {
<span class="lineNum">    2834 </span>            :     int i,e;
<span class="lineNum">    2835 </span>            : 
<span class="lineNum">    2836 </span>            :     n_nonzeros=0; 
<span class="lineNum">    2837 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    2838 </span>            :         index_i[i]=0;
<span class="lineNum">    2839 </span>            :         for (e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){
<span class="lineNum">    2840 </span>            :             if (abs(nnz[e])&gt;thr){
<span class="lineNum">    2841 </span>            :                 nnz[n_nonzeros]=nnz[e];
<span class="lineNum">    2842 </span>            :                 index_j[n_nonzeros]=index_j[e];
<span class="lineNum">    2843 </span>            :                 index_i[i]++;
<span class="lineNum">    2844 </span>            :                 n_nonzeros++;
<span class="lineNum">    2845 </span>            :             }
<span class="lineNum">    2846 </span>            :         }
<span class="lineNum">    2847 </span>            :     }
<span class="lineNum">    2848 </span>            : 
<span class="lineNum">    2849 </span>            :     get_row_edge();
<span class="lineNum">    2850 </span>            :     get_diag_pos();
<span class="lineNum">    2851 </span>            : 
<span class="lineNum">    2852 </span>            :     if (n_nonzeros!=edge_i[size]-findx) throw CSR_Exception(__LINE__,__FILE__);
<span class="lineNum">    2853 </span>            : }
<span class="lineNum">    2854 </span>            : 
<span class="lineNum">    2855 </span>            : /************************************************************************************************/
<a name="2856"><span class="lineNum">    2856 </span>            : </a>
<span class="lineNum">    2857 </span>            : template &lt;class T&gt;
<span class="lineNum">    2858 </span><span class="lineNoCov">          0 : int TCSR&lt;T&gt;::get_bandwidth(MPI_Comm comm)</span>
<span class="lineNum">    2859 </span>            : {
<span class="lineNum">    2860 </span>            :     int IR;
<span class="lineNum">    2861 </span>            :     int width;
<span class="lineNum">    2862 </span>            :     int loc_ham_bs;
<span class="lineNum">    2863 </span>            : 
<span class="lineNum">    2864 </span><span class="lineNoCov">          0 :     loc_ham_bs = 0;</span>
<span class="lineNum">    2865 </span><span class="lineNoCov">          0 :     width      = 0;</span>
<span class="lineNum">    2866 </span>            : 
<span class="lineNum">    2867 </span><span class="lineNoCov">          0 :     for(IR=0;IR&lt;size;IR++){</span>
<span class="lineNum">    2868 </span><span class="lineNoCov">          0 :         if(edge_i[IR+1]&gt;edge_i[IR]){</span>
<span class="lineNum">    2869 </span><span class="lineNoCov">          0 :             width = (index_j[edge_i[IR+1]-1-findx]-index_j[edge_i[IR]-findx]+1);</span>
<span class="lineNum">    2870 </span>            :         }
<span class="lineNum">    2871 </span><span class="lineNoCov">          0 :         if(width&gt;loc_ham_bs){</span>
<span class="lineNum">    2872 </span><span class="lineNoCov">          0 :             loc_ham_bs = width;</span>
<span class="lineNum">    2873 </span>            :         }
<span class="lineNum">    2874 </span>            :     }
<span class="lineNum">    2875 </span>            : 
<span class="lineNum">    2876 </span><span class="lineNoCov">          0 :     loc_ham_bs = ceil((double)loc_ham_bs/2.0);</span>
<span class="lineNum">    2877 </span>            : 
<span class="lineNum">    2878 </span><span class="lineNoCov">          0 :     MPI_Allreduce(&amp;loc_ham_bs,&amp;width,1,MPI_INT,MPI_MAX,comm);</span>
<span class="lineNum">    2879 </span>            : 
<span class="lineNum">    2880 </span><span class="lineNoCov">          0 :     return width;</span>
<span class="lineNum">    2881 </span>            : }
<span class="lineNum">    2882 </span>            : 
<span class="lineNum">    2883 </span>            : /************************************************************************************************/
<a name="2884"><span class="lineNum">    2884 </span>            : </a>
<span class="lineNum">    2885 </span>            : template &lt;class T&gt;
<span class="lineNum">    2886 </span><span class="lineNoCov">          0 : void TCSR&lt;T&gt;::sparse_to_narrow_band(T *B,int bw,int pp)</span>
<span class="lineNum">    2887 </span>            : {
<span class="lineNum">    2888 </span>            :     int i,j,e,o;
<span class="lineNum">    2889 </span>            : 
<span class="lineNum">    2890 </span><span class="lineNoCov">          0 :     init_variable(B,(2*bw*pp+2*bw+1)*size);</span>
<span class="lineNum">    2891 </span><span class="lineNoCov">          0 :     for(i=0;i&lt;size;i++){</span>
<span class="lineNum">    2892 </span><span class="lineNoCov">          0 :         o=i*(2*bw*pp+2*bw+1)+2*bw*pp;</span>
<span class="lineNum">    2893 </span><span class="lineNoCov">          0 :         for(e=edge_i[i]-findx;e&lt;edge_i[i+1]-findx;e++){</span>
<span class="lineNum">    2894 </span><span class="lineNoCov">          0 :             j=index_j[e]-findx+bw-i-first_row;</span>
<span class="lineNum">    2895 </span><span class="lineNoCov">          0 :             if (j&gt;=0 &amp;&amp; j&lt;2*bw+1){</span>
<span class="lineNum">    2896 </span><span class="lineNoCov">          0 :                 B[o+j] = nnz[e];</span>
<span class="lineNum">    2897 </span>            :             }
<span class="lineNum">    2898 </span>            :         }
<span class="lineNum">    2899 </span>            :     }
<span class="lineNum">    2900 </span><span class="lineNoCov">          0 : }</span>
<span class="lineNum">    2901 </span>            : 
<span class="lineNum">    2902 </span>            : /*SAB*END****************************************************************************************/
<span class="lineNum">    2903 </span>            : 
<span class="lineNum">    2904 </span>            : template &lt;class T&gt;
<span class="lineNum">    2905 </span>            : void TCSR&lt;T&gt;::full_to_sparse(T *B,int nrow,int ncol)
<span class="lineNum">    2906 </span>            : {
<span class="lineNum">    2907 </span>            :     int i,j;
<span class="lineNum">    2908 </span>            : 
<span class="lineNum">    2909 </span>            :     size       = nrow;
<span class="lineNum">    2910 </span>            :     n_nonzeros = 0;
<span class="lineNum">    2911 </span>            :     
<span class="lineNum">    2912 </span>            :     for(i=0;i&lt;nrow;i++){
<span class="lineNum">    2913 </span>            : 
<span class="lineNum">    2914 </span>            :         index_i[i] = 0;
<span class="lineNum">    2915 </span>            : 
<span class="lineNum">    2916 </span>            :         for(j=0;j&lt;ncol;j++){
<span class="lineNum">    2917 </span>            : 
<span class="lineNum">    2918 </span>            :             if(abs(B[i+j*nrow])&gt;tollim){
<span class="lineNum">    2919 </span>            : 
<span class="lineNum">    2920 </span>            :                 index_j[n_nonzeros] = j+findx;
<span class="lineNum">    2921 </span>            :                 nnz[n_nonzeros]     = B[i+j*nrow];
<span class="lineNum">    2922 </span>            : 
<span class="lineNum">    2923 </span>            :                 index_i[i]++;
<span class="lineNum">    2924 </span>            :                 n_nonzeros++;
<span class="lineNum">    2925 </span>            :             }
<span class="lineNum">    2926 </span>            :         }
<span class="lineNum">    2927 </span>            :     }
<span class="lineNum">    2928 </span>            :     get_row_edge();
<span class="lineNum">    2929 </span>            :     get_diag_pos();
<span class="lineNum">    2930 </span>            : }
<span class="lineNum">    2931 </span>            : 
<span class="lineNum">    2932 </span>            : /************************************************************************************************/
<span class="lineNum">    2933 </span>            : /*
<span class="lineNum">    2934 </span>            : template &lt;&gt;
<span class="lineNum">    2935 </span>            : void TCSR&lt;double&gt;::cmp_full_to_sparse(CPX *B,int nrow,int ncol,CPX factor)
<span class="lineNum">    2936 </span>            : {
<span class="lineNum">    2937 </span>            :     int i,j;
<span class="lineNum">    2938 </span>            : 
<span class="lineNum">    2939 </span>            :     size       = nrow;
<span class="lineNum">    2940 </span>            :     n_nonzeros = 0;
<span class="lineNum">    2941 </span>            :     
<span class="lineNum">    2942 </span>            :     for(i=0;i&lt;nrow;i++){
<span class="lineNum">    2943 </span>            : 
<span class="lineNum">    2944 </span>            :         index_i[i] = 0;
<span class="lineNum">    2945 </span>            : 
<span class="lineNum">    2946 </span>            :         for(j=0;j&lt;ncol;j++){
<span class="lineNum">    2947 </span>            : 
<span class="lineNum">    2948 </span>            :             if(abs(B[i+j*nrow])&gt;tollim){
<span class="lineNum">    2949 </span>            : 
<span class="lineNum">    2950 </span>            :                 index_j[n_nonzeros] = j+findx;
<span class="lineNum">    2951 </span>            :                 nnz[n_nonzeros]     = real(factor*B[i+j*nrow]);
<span class="lineNum">    2952 </span>            : 
<span class="lineNum">    2953 </span>            :                 index_i[i]++;
<span class="lineNum">    2954 </span>            :                 n_nonzeros++;
<span class="lineNum">    2955 </span>            :             }
<span class="lineNum">    2956 </span>            :         }
<span class="lineNum">    2957 </span>            :     }
<span class="lineNum">    2958 </span>            : 
<span class="lineNum">    2959 </span>            :     get_row_edge();
<span class="lineNum">    2960 </span>            :     get_diag_pos();
<span class="lineNum">    2961 </span>            : }
<span class="lineNum">    2962 </span>            : */
<span class="lineNum">    2963 </span>            : /************************************************************************************************/
<span class="lineNum">    2964 </span>            : /*
<span class="lineNum">    2965 </span>            : template &lt;&gt;
<span class="lineNum">    2966 </span>            : void TCSR&lt;CPX&gt;::cmp_full_to_sparse(CPX *B,int nrow,int ncol,CPX factor)
<span class="lineNum">    2967 </span>            : {
<span class="lineNum">    2968 </span>            :     int i,j;
<span class="lineNum">    2969 </span>            : 
<span class="lineNum">    2970 </span>            :     size       = nrow;
<span class="lineNum">    2971 </span>            :     n_nonzeros = 0;
<span class="lineNum">    2972 </span>            :     
<span class="lineNum">    2973 </span>            :     for(i=0;i&lt;nrow;i++){
<span class="lineNum">    2974 </span>            : 
<span class="lineNum">    2975 </span>            :         index_i[i] = 0;
<span class="lineNum">    2976 </span>            : 
<span class="lineNum">    2977 </span>            :         for(j=0;j&lt;ncol;j++){
<span class="lineNum">    2978 </span>            : 
<span class="lineNum">    2979 </span>            :             if(abs(B[i+j*nrow])&gt;tollim){
<span class="lineNum">    2980 </span>            : 
<span class="lineNum">    2981 </span>            :                 index_j[n_nonzeros] = j+findx;
<span class="lineNum">    2982 </span>            :                 nnz[n_nonzeros]     = factor*B[i+j*nrow];
<span class="lineNum">    2983 </span>            : 
<span class="lineNum">    2984 </span>            :                 index_i[i]++;
<span class="lineNum">    2985 </span>            :                 n_nonzeros++;
<span class="lineNum">    2986 </span>            :             }
<span class="lineNum">    2987 </span>            :         }
<span class="lineNum">    2988 </span>            :     }
<span class="lineNum">    2989 </span>            : 
<span class="lineNum">    2990 </span>            :     get_row_edge();
<span class="lineNum">    2991 </span>            :     get_diag_pos();
<span class="lineNum">    2992 </span>            : }
<span class="lineNum">    2993 </span>            : */
<span class="lineNum">    2994 </span>            : /************************************************************************************************/
<span class="lineNum">    2995 </span>            : 
<span class="lineNum">    2996 </span>            : template &lt;&gt;
<span class="lineNum">    2997 </span>            : inline void TCSR&lt;double&gt;::write_CSR_bin(const char* filename)
<span class="lineNum">    2998 </span>            : {
<span class="lineNum">    2999 </span>            :     int i,j,u=0;
<span class="lineNum">    3000 </span>            :     
<span class="lineNum">    3001 </span>            :     ofstream myfile;
<span class="lineNum">    3002 </span>            :     myfile.open (filename,ios::out | ios::binary);
<span class="lineNum">    3003 </span>            :     double dsize = (double) size;
<span class="lineNum">    3004 </span>            :     double dnnon = (double) n_nonzeros;
<span class="lineNum">    3005 </span>            :     double dfind = (double) findx;
<span class="lineNum">    3006 </span>            :     myfile.write((char*)&amp;dsize,sizeof(double));
<span class="lineNum">    3007 </span>            :     myfile.write((char*)&amp;dnnon,sizeof(double));
<span class="lineNum">    3008 </span>            :     myfile.write((char*)&amp;dfind,sizeof(double));
<span class="lineNum">    3009 </span>            :     for(i=0;i&lt;size;i++){                                              
<span class="lineNum">    3010 </span>            :         for(j=0;j&lt;index_i[i];j++){                                    
<span class="lineNum">    3011 </span>            :             double ipos = (double) (i+findx);
<span class="lineNum">    3012 </span>            :             double jpos = (double) index_j[u];
<span class="lineNum">    3013 </span>            :             double rval = nnz[u];
<span class="lineNum">    3014 </span>            :             double ival = 0.0;
<span class="lineNum">    3015 </span>            :             myfile.write((char*)&amp;ipos,sizeof(double));
<span class="lineNum">    3016 </span>            :             myfile.write((char*)&amp;jpos,sizeof(double));
<span class="lineNum">    3017 </span>            :             myfile.write((char*)&amp;rval,sizeof(double));
<span class="lineNum">    3018 </span>            :             myfile.write((char*)&amp;ival,sizeof(double));
<span class="lineNum">    3019 </span>            :             u++;                                                      
<span class="lineNum">    3020 </span>            :         }                                                             
<span class="lineNum">    3021 </span>            :     }                                                                 
<span class="lineNum">    3022 </span>            :     myfile.close();                                                   
<span class="lineNum">    3023 </span>            : 
<span class="lineNum">    3024 </span>            : }
<span class="lineNum">    3025 </span>            : 
<span class="lineNum">    3026 </span>            : /************************************************************************************************/
<span class="lineNum">    3027 </span>            : 
<span class="lineNum">    3028 </span>            : template &lt;&gt;
<span class="lineNum">    3029 </span>            : inline void TCSR&lt;CPX&gt;::write_CSR_bin(const char* filename)
<span class="lineNum">    3030 </span>            : {
<span class="lineNum">    3031 </span>            :     int i,j,u=0;
<span class="lineNum">    3032 </span>            :     
<span class="lineNum">    3033 </span>            :     ofstream myfile;
<span class="lineNum">    3034 </span>            :     myfile.open (filename,ios::out | ios::binary);
<span class="lineNum">    3035 </span>            :     double dsize = (double) size;
<span class="lineNum">    3036 </span>            :     double dnnon = (double) n_nonzeros;
<span class="lineNum">    3037 </span>            :     double dfind = (double) findx;
<span class="lineNum">    3038 </span>            :     myfile.write((char*)&amp;dsize,sizeof(double));
<span class="lineNum">    3039 </span>            :     myfile.write((char*)&amp;dnnon,sizeof(double));
<span class="lineNum">    3040 </span>            :     myfile.write((char*)&amp;dfind,sizeof(double));
<span class="lineNum">    3041 </span>            :     for(i=0;i&lt;size;i++){                                              
<span class="lineNum">    3042 </span>            :         for(j=0;j&lt;index_i[i];j++){                                    
<span class="lineNum">    3043 </span>            :             double ipos = (double) (i+findx);
<span class="lineNum">    3044 </span>            :             double jpos = (double) index_j[u];
<span class="lineNum">    3045 </span>            :             double rval = real(nnz[u]);
<span class="lineNum">    3046 </span>            :             double ival = imag(nnz[u]);
<span class="lineNum">    3047 </span>            :             myfile.write((char*)&amp;ipos,sizeof(double));
<span class="lineNum">    3048 </span>            :             myfile.write((char*)&amp;jpos,sizeof(double));
<span class="lineNum">    3049 </span>            :             myfile.write((char*)&amp;rval,sizeof(double));
<span class="lineNum">    3050 </span>            :             myfile.write((char*)&amp;ival,sizeof(double));
<span class="lineNum">    3051 </span>            :             u++;                                                      
<span class="lineNum">    3052 </span>            :         }                                                             
<span class="lineNum">    3053 </span>            :     }                                                                 
<span class="lineNum">    3054 </span>            :     myfile.close();                                                   
<span class="lineNum">    3055 </span>            : 
<span class="lineNum">    3056 </span>            : }
<span class="lineNum">    3057 </span>            : 
<span class="lineNum">    3058 </span>            : /************************************************************************************************/
<span class="lineNum">    3059 </span>            : 
<span class="lineNum">    3060 </span>            : template &lt;&gt;
<span class="lineNum">    3061 </span>            : inline void TCSR&lt;double&gt;::write_CSR(const char* filename)
<span class="lineNum">    3062 </span>            : {
<span class="lineNum">    3063 </span>            :     int i,j,u=0;
<span class="lineNum">    3064 </span>            :     
<span class="lineNum">    3065 </span>            :     ofstream myfile;
<span class="lineNum">    3066 </span>            :     myfile.open (filename);
<span class="lineNum">    3067 </span>            :     myfile.precision(8);
<span class="lineNum">    3068 </span>            :     myfile&lt;&lt;size&lt;&lt;&quot;\n&quot;;
<span class="lineNum">    3069 </span>            :     myfile&lt;&lt;n_nonzeros&lt;&lt;&quot;\n&quot;;
<span class="lineNum">    3070 </span>            :     myfile&lt;&lt;findx&lt;&lt;&quot;\n&quot;;
<span class="lineNum">    3071 </span>            :     for(i=0;i&lt;size;i++){                                              
<span class="lineNum">    3072 </span>            :         for(j=0;j&lt;index_i[i];j++){                                    
<span class="lineNum">    3073 </span>            :             myfile&lt;&lt;i+findx&lt;&lt;&quot; &quot;&lt;&lt;index_j[u]&lt;&lt;&quot; &quot;&lt;&lt;nnz[u]&lt;&lt;&quot;\n&quot;;  
<span class="lineNum">    3074 </span>            :             u++;                                                      
<span class="lineNum">    3075 </span>            :         }                                                             
<span class="lineNum">    3076 </span>            :     }                                                                 
<span class="lineNum">    3077 </span>            :     myfile.close();                                                   
<span class="lineNum">    3078 </span>            : 
<span class="lineNum">    3079 </span>            : }
<span class="lineNum">    3080 </span>            : 
<span class="lineNum">    3081 </span>            : /************************************************************************************************/
<span class="lineNum">    3082 </span>            : 
<span class="lineNum">    3083 </span>            : template &lt;&gt;
<span class="lineNum">    3084 </span>            : inline void TCSR&lt;CPX&gt;::write_CSR(const char* filename)
<span class="lineNum">    3085 </span>            : {
<span class="lineNum">    3086 </span>            :     
<span class="lineNum">    3087 </span>            :     int i,j,u=0;                                                        
<span class="lineNum">    3088 </span>            :                                                                       
<span class="lineNum">    3089 </span>            :     ofstream myfile;                                                  
<span class="lineNum">    3090 </span>            :     myfile.open (filename);                                           
<span class="lineNum">    3091 </span>            :     myfile.precision(8);                                              
<span class="lineNum">    3092 </span>            :     myfile&lt;&lt;size&lt;&lt;&quot;\n&quot;;                                               
<span class="lineNum">    3093 </span>            :     myfile&lt;&lt;n_nonzeros&lt;&lt;&quot;\n&quot;;                                         
<span class="lineNum">    3094 </span>            :     myfile&lt;&lt;findx&lt;&lt;&quot;\n&quot;;                                              
<span class="lineNum">    3095 </span>            :     for(i=0;i&lt;size;i++){                                              
<span class="lineNum">    3096 </span>            :         for(j=0;j&lt;index_i[i];j++){                                    
<span class="lineNum">    3097 </span>            :           myfile&lt;&lt;i+findx&lt;&lt;&quot; &quot;&lt;&lt;index_j[u]&lt;&lt;&quot; &quot;&lt;&lt;real(nnz[u])&lt;&lt;&quot; &quot;&lt;&lt;imag(nnz[u])&lt;&lt;&quot;\n&quot;;      
<span class="lineNum">    3098 </span>            :             u++;                                                      
<span class="lineNum">    3099 </span>            :         }                                                             
<span class="lineNum">    3100 </span>            :     }                                                                 
<span class="lineNum">    3101 </span>            :     myfile.close();                                                   
<span class="lineNum">    3102 </span>            :     
<span class="lineNum">    3103 </span>            : }
<span class="lineNum">    3104 </span>            : 
<span class="lineNum">    3105 </span>            : /************************************************************************************************/
<span class="lineNum">    3106 </span>            : 
<span class="lineNum">    3107 </span>            : template &lt;&gt;
<span class="lineNum">    3108 </span>            : inline void TCSR&lt;double&gt;::write(const char* filename)
<span class="lineNum">    3109 </span>            : {
<span class="lineNum">    3110 </span>            :     int u=0,i,j;
<span class="lineNum">    3111 </span>            :     
<span class="lineNum">    3112 </span>            :     ofstream myfile;
<span class="lineNum">    3113 </span>            :     myfile.open (filename);
<span class="lineNum">    3114 </span>            :     myfile.precision(8);
<span class="lineNum">    3115 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    3116 </span>            :         for(j=0;j&lt;index_i[i];j++){
<span class="lineNum">    3117 </span>            :             myfile&lt;&lt;i+1+first_row&lt;&lt;&quot; &quot;&lt;&lt;index_j[u]+1-findx&lt;&lt;&quot; &quot;&lt;&lt;nnz[u]&lt;&lt;&quot;\n&quot;;
<span class="lineNum">    3118 </span>            :             u++;
<span class="lineNum">    3119 </span>            :         }
<span class="lineNum">    3120 </span>            :     }
<span class="lineNum">    3121 </span>            :     myfile.close();                                                   
<span class="lineNum">    3122 </span>            : }
<span class="lineNum">    3123 </span>            : 
<span class="lineNum">    3124 </span>            : /************************************************************************************************/
<span class="lineNum">    3125 </span>            : 
<span class="lineNum">    3126 </span>            : template &lt;&gt;
<span class="lineNum">    3127 </span>            : inline void TCSR&lt;CPX&gt;::write(const char* filename)
<span class="lineNum">    3128 </span>            : {
<span class="lineNum">    3129 </span>            :     int u=0,i,j;
<span class="lineNum">    3130 </span>            :     
<span class="lineNum">    3131 </span>            :     ofstream myfile;
<span class="lineNum">    3132 </span>            :     myfile.open (filename);
<span class="lineNum">    3133 </span>            :     myfile.precision(8);
<span class="lineNum">    3134 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    3135 </span>            :         for(j=0;j&lt;index_i[i];j++){
<span class="lineNum">    3136 </span>            :             myfile&lt;&lt;i+1+first_row&lt;&lt;&quot; &quot;&lt;&lt;index_j[u]+1-findx&lt;&lt;&quot; &quot;&lt;&lt;real(nnz[u])&lt;&lt;&quot; &quot;\
<span class="lineNum">    3137 </span>            :                   &lt;&lt;imag(nnz[u])&lt;&lt;&quot;\n&quot;;
<span class="lineNum">    3138 </span>            :             u++;
<span class="lineNum">    3139 </span>            :         }
<span class="lineNum">    3140 </span>            :     }
<span class="lineNum">    3141 </span>            :     myfile.close();
<span class="lineNum">    3142 </span>            : }
<span class="lineNum">    3143 </span>            : 
<span class="lineNum">    3144 </span>            : /************************************************************************************************/
<span class="lineNum">    3145 </span>            : 
<span class="lineNum">    3146 </span>            : template &lt;class T&gt;
<span class="lineNum">    3147 </span>            : void TCSR&lt;T&gt;::init_variable(int *var,int N)
<span class="lineNum">    3148 </span>            : {
<span class="lineNum">    3149 </span><span class="lineCov">      31622 :     for(int i=0;i&lt;N;i++){</span>
<span class="lineNum">    3150 </span><span class="lineCov">      15768 :         var[i] = 0;</span>
<span class="lineNum">    3151 </span>            :     }
<span class="lineNum">    3152 </span>            : }
<span class="lineNum">    3153 </span>            : 
<span class="lineNum">    3154 </span>            : /************************************************************************************************/
<span class="lineNum">    3155 </span>            : 
<span class="lineNum">    3156 </span>            : template &lt;class T&gt;
<span class="lineNum">    3157 </span>            : void TCSR&lt;T&gt;::init_variable(double *var,int N)
<span class="lineNum">    3158 </span>            : {
<span class="lineNum">    3159 </span><span class="lineCov">        386 :     for(int i=0;i&lt;N;i++){</span>
<span class="lineNum">    3160 </span><span class="lineCov">        192 :         var[i] = 0.0;</span>
<span class="lineNum">    3161 </span>            :     }
<span class="lineNum">    3162 </span>            : }
<span class="lineNum">    3163 </span>            : 
<span class="lineNum">    3164 </span>            : /************************************************************************************************/
<span class="lineNum">    3165 </span>            : 
<span class="lineNum">    3166 </span>            : template &lt;class T&gt;
<span class="lineNum">    3167 </span>            : void TCSR&lt;T&gt;::init_variable(CPX *var,int N)
<span class="lineNum">    3168 </span>            : {
<span class="lineNum">    3169 </span><span class="lineCov">    2907019 :     for(int i=0;i&lt;N;i++){</span>
<span class="lineNum">    3170 </span><span class="lineCov">    1452254 :         var[i] = CPX(0.0,0.0);</span>
<span class="lineNum">    3171 </span>            :     }
<span class="lineNum">    3172 </span>            : }
<span class="lineNum">    3173 </span>            : 
<span class="lineNum">    3174 </span>            : /************************************************************************************************/
<span class="lineNum">    3175 </span>            : 
<span class="lineNum">    3176 </span>            : template &lt;class T&gt;
<span class="lineNum">    3177 </span>            : void TCSR&lt;T&gt;::add_to_corner(T *V,T sign,int *ind,int N)
<span class="lineNum">    3178 </span>            : {
<span class="lineNum">    3179 </span>            :     int i,j;
<span class="lineNum">    3180 </span>            :     
<span class="lineNum">    3181 </span>            :     for(i=0;i&lt;N;i++){
<span class="lineNum">    3182 </span>            :         for(j=0;j&lt;N;j++){
<span class="lineNum">    3183 </span>            :             nnz[ind[i*N+j]] = nnz[ind[i*N+j]]+sign*V[i+j*N];
<span class="lineNum">    3184 </span>            :         }
<span class="lineNum">    3185 </span>            :     }
<span class="lineNum">    3186 </span>            : }
<span class="lineNum">    3187 </span>            : 
<span class="lineNum">    3188 </span>            : /************************************************************************************************/
<span class="lineNum">    3189 </span>            : 
<span class="lineNum">    3190 </span>            : template&lt;class T&gt;
<span class="lineNum">    3191 </span>            : void TCSR&lt;T&gt;::change_findx(int fortran_index)
<span class="lineNum">    3192 </span>            : {
<span class="lineNum">    3193 </span>            :     int fold = findx;
<span class="lineNum">    3194 </span>            :     int fnew = fortran_index;
<span class="lineNum">    3195 </span>            :     int i;
<span class="lineNum">    3196 </span>            :     
<span class="lineNum">    3197 </span>            :     for(i=0;i&lt;=size;i++){edge_i[i]=edge_i[i]-fold+fnew;}
<span class="lineNum">    3198 </span>            :     for(i=0;i&lt;n_nonzeros;i++){index_j[i]=index_j[i]-fold+fnew;}
<span class="lineNum">    3199 </span>            : 
<span class="lineNum">    3200 </span>            :     findx = fortran_index;
<span class="lineNum">    3201 </span>            : }
<span class="lineNum">    3202 </span>            : 
<span class="lineNum">    3203 </span>            : /************************************************************************************************/
<span class="lineNum">    3204 </span>            : 
<span class="lineNum">    3205 </span>            : template&lt;class T&gt;
<span class="lineNum">    3206 </span>            : void TCSR&lt;T&gt;::get_full_index_i(int *full_index_i)
<span class="lineNum">    3207 </span>            : {
<span class="lineNum">    3208 </span>            :     int i,j;
<span class="lineNum">    3209 </span>            : 
<span class="lineNum">    3210 </span>            :     for(i=0;i&lt;size;i++){
<span class="lineNum">    3211 </span>            :         for(j=edge_i[i]-findx;j&lt;edge_i[i+1]-findx;j++){
<span class="lineNum">    3212 </span>            :             full_index_i[j] = i+findx;
<span class="lineNum">    3213 </span>            :         }
<span class="lineNum">    3214 </span>            :     }
<span class="lineNum">    3215 </span>            : }
<span class="lineNum">    3216 </span>            : 
<span class="lineNum">    3217 </span>            : /************************************************************************************************/
<span class="lineNum">    3218 </span>            : 
<span class="lineNum">    3219 </span>            : template&lt;class T&gt;
<span class="lineNum">    3220 </span>            : int TCSR&lt;T&gt;::get_msize(int start,int stop,int tb,int* n_of_el)
<span class="lineNum">    3221 </span>            : {
<span class="lineNum">    3222 </span>            :   /*
<span class="lineNum">    3223 </span>            :     int IM,msize,factor;
<span class="lineNum">    3224 </span>            : 
<span class="lineNum">    3225 </span>            :     factor = 1;
<span class="lineNum">    3226 </span>            :     if(tb==20) factor = 2;
<span class="lineNum">    3227 </span>            : 
<span class="lineNum">    3228 </span>            :     msize = 0;
<span class="lineNum">    3229 </span>            :     for(IM=start;IM&lt;=stop;IM++){
<span class="lineNum">    3230 </span>            :         msize = msize+factor*n_of_el[IM];
<span class="lineNum">    3231 </span>            :     }
<span class="lineNum">    3232 </span>            : 
<span class="lineNum">    3233 </span>            :     return msize;
<span class="lineNum">    3234 </span>            :   */
<span class="lineNum">    3235 </span>            :     return (tb/10)*(n_of_el[stop+1]-n_of_el[start]);
<span class="lineNum">    3236 </span>            : }
<span class="lineNum">    3237 </span>            : /************************************************************************************************/
<span class="lineNum">    3238 </span>            : 
<span class="lineNum">    3239 </span>            : #endif
</pre>
      </td>
    </tr>
  </table>
  <br>

  <table width="100%" border=0 cellspacing=0 cellpadding=0>
    <tr><td class="ruler"><img src="../glass.png" width=3 height=3 alt=""></td></tr>
    <tr><td class="versionInfo">Generated by: <a href="http://ltp.sourceforge.net/coverage/lcov.php" target="_parent">LCOV version 1.13</a></td></tr>
  </table>
  <br>

</body>
</html>
